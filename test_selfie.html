<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Selfie - Preview</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #0a0e27;
      color: white;
    }
    .container {
      max-width: 400px;
      margin: 0 auto;
    }
    .video-container {
      width: 100%;
      aspect-ratio: 3 / 4;
      border-radius: 16px;
      overflow: hidden;
      background: #000;
      margin-bottom: 20px;
      position: relative;
    }
    .video-container video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center center;
    }
    .preview-container {
      width: 100%;
      aspect-ratio: 3 / 4;
      border-radius: 16px;
      overflow: hidden;
      background: #000;
      margin-bottom: 20px;
      display: none;
    }
    .preview-container.active {
      display: block;
    }
    .preview-container img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center center;
    }
    button {
      background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
      color: white;
      border: none;
      padding: 16px 32px;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-bottom: 10px;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .info {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 12px;
      margin-top: 20px;
      font-size: 14px;
    }
    .info h3 {
      margin-top: 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Test Selfie - Preview</h1>
    
    <div class="video-container">
      <video id="video" autoplay playsinline muted></video>
    </div>
    
    <div class="preview-container" id="previewContainer">
      <img id="preview" alt="Preview">
    </div>
    
    <button id="captureBtn" disabled>Cattura Selfie</button>
    <button id="retakeBtn" style="display: none;">Scatta di nuovo</button>
    
    <div class="info">
      <h3>Info Test:</h3>
      <p><strong>Aspect Ratio:</strong> 3:4 (verticale)</p>
      <p><strong>Object-fit:</strong> cover (nessuna banda nera)</p>
      <p><strong>Crop:</strong> centrato verticalmente</p>
      <p id="videoInfo">Video: caricamento...</p>
      <p id="canvasInfo" style="display: none;">Canvas: -</p>
    </div>
  </div>

  <canvas id="canvas" style="display: none;"></canvas>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const preview = document.getElementById('preview');
    const previewContainer = document.getElementById('previewContainer');
    const captureBtn = document.getElementById('captureBtn');
    const retakeBtn = document.getElementById('retakeBtn');
    const videoInfo = document.getElementById('videoInfo');
    const canvasInfo = document.getElementById('canvasInfo');
    
    let stream = null;

    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { 
            facingMode: 'user',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        });
        video.srcObject = stream;
        
        await new Promise((resolve) => {
          video.onloadedmetadata = () => {
            video.play().then(resolve);
          };
        });
        
        captureBtn.disabled = false;
        videoInfo.textContent = `Video: ${video.videoWidth}x${video.videoHeight} (aspect: ${(video.videoWidth/video.videoHeight).toFixed(2)})`;
      } catch(err) {
        alert("Errore accesso camera: " + err.message);
      }
    }

    function captureSelfie() {
      const targetAspectRatio = 3 / 4;
      const videoAspectRatio = video.videoWidth / video.videoHeight;
      
      let sourceX = 0;
      let sourceY = 0;
      let sourceWidth = video.videoWidth;
      let sourceHeight = video.videoHeight;
      
      let canvasWidth, canvasHeight;
      
      if(videoAspectRatio > targetAspectRatio) {
        canvasHeight = video.videoHeight;
        canvasWidth = Math.round(canvasHeight * targetAspectRatio);
        sourceX = Math.round((video.videoWidth - canvasWidth) / 2);
        sourceY = 0;
      } else {
        canvasWidth = video.videoWidth;
        canvasHeight = Math.round(canvasWidth / targetAspectRatio);
        sourceX = 0;
        sourceY = Math.round((video.videoHeight - canvasHeight) / 2);
      }
      
      canvas.width = canvasWidth;
      canvas.height = canvasHeight;
      
      const ctx = canvas.getContext('2d');
      ctx.drawImage(
        video,
        sourceX, sourceY, sourceWidth, sourceHeight,
        0, 0, canvasWidth, canvasHeight
      );
      
      canvasInfo.textContent = `Canvas: ${canvas.width}x${canvas.height} (aspect: ${(canvas.width/canvas.height).toFixed(2)})`;
      canvasInfo.style.display = 'block';
      
      canvas.toBlob((blob) => {
        const url = URL.createObjectURL(blob);
        preview.src = url;
        previewContainer.classList.add('active');
        captureBtn.style.display = 'none';
        retakeBtn.style.display = 'block';
        
        if(stream) {
          stream.getTracks().forEach(track => track.stop());
          stream = null;
        }
      }, 'image/jpeg', 0.9);
    }

    captureBtn.addEventListener('click', captureSelfie);
    retakeBtn.addEventListener('click', () => {
      previewContainer.classList.remove('active');
      captureBtn.style.display = 'block';
      retakeBtn.style.display = 'none';
      startCamera();
    });

    startCamera();
  </script>
</body>
</html>

