<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Tenerife Stars Pictures - Trova le tue foto</title>
  <style>
    :root{
      --bg-dark: #0a0e27;
      --bg-dark2: #1a1f3a;
      --bg-gradient: linear-gradient(180deg, #1a1f3a 0%, #0a0e27 100%);
      --text-light: #ffffff;
      --text-muted: #a0a8c0;
      --accent: #6366f1;
      --accent-light: #818cf8;
      --purple: #a855f7;
      --pink: #ec4899;
      --radius: 16px;
      --shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    *{box-sizing:border-box; margin:0; padding:0}
    html, body{
      margin:0;
      padding:0;
      height: 100%;
      overflow: hidden;
    }
    body{
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
      color:var(--text-light);
      height: 100dvh;
      height: 100vh; /* Fallback per browser che non supportano dvh */
      background: var(--bg-gradient);
      overflow: hidden;
      position: fixed;
      width: 100%;
    }
    
    /* Utility */
    .screen{
      height: 100dvh;
      height: 100vh; /* Fallback */
      display: none;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }
    .screen.active{
      display: flex;
    }
    
    /* Language Selection Screen */
    .language-screen{
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      text-align: center;
    }
    
    .language-title{
      font-size: 28px;
      font-weight: 700;
      color: var(--text-light);
      margin-bottom: 10px;
    }
    
    .language-subtitle{
      font-size: 16px;
      color: var(--text-muted);
      margin-bottom: 40px;
    }
    
    .language-grid{
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      max-width: 400px;
      width: 100%;
      margin: 0 auto;
    }
    
    .language-option{
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }
    
    .language-option:hover{
      background: rgba(255, 255, 255, 0.1);
      border-color: var(--accent);
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
    }
    
    .language-flag{
      font-size: 48px;
      line-height: 1;
    }
    
    .language-name{
      font-size: 18px;
      font-weight: 600;
      color: var(--text-light);
    }
    
    /* Email Screen */
    .email-screen{
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      text-align: center;
    }
    
    .email-title{
      font-size: 28px;
      font-weight: 700;
      color: var(--text-light);
      margin-bottom: 10px;
    }
    
    .email-subtitle{
      font-size: 16px;
      color: var(--text-muted);
      margin-bottom: 30px;
    }
    
    .email-input-container{
      max-width: 400px;
      width: 100%;
      margin: 0 auto 30px;
    }
    
    .email-input{
      width: 100%;
      padding: 16px 20px;
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      color: var(--text-light);
      font-size: 16px;
      transition: all 0.3s ease;
    }
    
    .email-input:focus{
      outline: none;
      border-color: var(--accent);
      background: rgba(255, 255, 255, 0.08);
    }
    
    .email-input::placeholder{
      color: var(--text-muted);
    }
    
    .email-error{
      color: #ff4444;
      font-size: 14px;
      margin-top: 10px;
      display: none;
    }
    
    .email-error.show{
      display: block;
    }
    
    /* Welcome Screen */
    .welcome-screen{
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      text-align: center;
    }
    
    .welcome-icon{
      width: 120px;
      height: 120px;
      margin-bottom: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .welcome-icon svg{
      width: 100%;
      height: 100%;
      stroke: var(--accent-light);
      fill: none;
      stroke-width: 2;
    }
    
    .welcome-title{
      font-size: 32px;
      font-weight: 700;
      color: var(--text-light);
      margin-bottom: 20px;
    }
    
    .welcome-text{
      font-size: 16px;
      color: var(--text-muted);
      line-height: 1.6;
      max-width: 400px;
      margin: 0 auto 40px;
    }
    
    .welcome-privacy{
      font-size: 14px;
      color: var(--text-muted);
      max-width: 400px;
      margin: 20px auto 0;
    }
    
    .btn-primary{
      background: linear-gradient(135deg, var(--accent) 0%, var(--purple) 100%);
      color: white;
      border: none;
      padding: 16px 48px;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .btn-primary:active{
      transform: scale(0.98);
    }
    
    /* Selfie Screen */
    .selfie-screen{
      padding: 10px;
      overflow: hidden;
    }
    
    .selfie-header{
      flex-shrink: 0;
      padding: 10px 0;
      text-align: center;
    }
    
    .selfie-header h2{
      font-size: 20px;
      font-weight: 600;
      color: var(--text-light);
      margin: 0;
    }
    
    .selfie-preview{
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      min-height: 0; /* Importante per flex */
      overflow: hidden;
    }
    
    .selfie-video{
      width: 100%;
      max-width: 100%;
      aspect-ratio: 3 / 4; /* Aspect ratio fisso 3:4 verticale */
      border-radius: 16px;
      overflow: hidden;
      background: #000;
      flex-shrink: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    
    .selfie-video video{
      width: 100%;
      height: 100%;
      object-fit: cover; /* Copre tutto il contenitore senza bande nere */
      display: block;
      object-position: center center; /* Centra verticalmente sul volto */
    }
    
    .selfie-controls{
      flex-shrink: 0;
      margin-top: 15px;
      margin-bottom: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }
    
    /* Upload Status Area - sempre visibile */
    .upload-status{
      flex-shrink: 0;
      padding: 12px 20px;
      background: rgba(0, 0, 0, 0.3);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: none;
      flex-direction: column;
      gap: 8px;
    }
    
    .upload-status.active{
      display: flex;
    }
    
    .upload-status-text{
      font-size: 14px;
      color: var(--text-light);
      text-align: center;
      font-weight: 500;
    }
    
    .upload-progress-container{
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      overflow: hidden;
    }
    
    .upload-progress-bar{
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--purple));
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 3px;
    }
    
    .upload-percentage{
      font-size: 12px;
      color: var(--text-muted);
      text-align: center;
    }
    
    .upload-spinner{
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    
    .camera-btn{
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: white;
      border: 4px solid var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    
    .camera-btn svg{
      width: 40px;
      height: 40px;
      stroke: var(--accent);
      stroke-width: 2;
    }
    
    /* Confirm Selfie Screen */
    .confirm-screen{
      padding: 10px 20px;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    
    .confirm-title{
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 30px;
      text-align: center;
    }
    
    .confirm-preview{
      width: 100%;
      max-width: 300px;
      aspect-ratio: 3 / 4; /* Stesso aspect ratio del selfie catturato */
      border-radius: 20px;
      overflow: hidden;
      margin-bottom: 15px;
      box-shadow: var(--shadow);
      flex-shrink: 1;
      background: #000;
    }
    
    .confirm-preview img{
      width: 100%;
      height: 100%;
      object-fit: cover; /* Stesso comportamento del video */
      object-position: center center;
      display: block;
    }
    
    .confirm-privacy{
      max-width: 400px;
      text-align: center;
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 30px;
      line-height: 1.6;
    }
    
    .confirm-privacy a{
      color: var(--accent-light);
      text-decoration: underline;
    }
    
    .confirm-buttons{
      display: flex;
      flex-direction: column;
      gap: 12px;
      width: 100%;
      max-width: 400px;
    }
    
    .btn-confirm{
      background: var(--accent);
      color: white;
      border: none;
      padding: 16px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }
    
    .btn-retake{
      background: transparent;
      color: var(--text-light);
      border: 2px solid var(--text-muted);
      padding: 16px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }
    
    /* Add People Screen */
    .add-people-screen{
      padding: 40px 20px;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    
    .add-people-title{
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 30px;
    }
    
    .people-list{
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-bottom: 40px;
      flex-wrap: wrap;
    }
    
    .person-avatar{
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--bg-dark2);
      border: 3px solid var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    
    .person-avatar img{
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .add-person-btn{
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--accent);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 32px;
      color: white;
    }
    
    .add-people-buttons{
      display: flex;
      flex-direction: column;
      gap: 12px;
      width: 100%;
      max-width: 400px;
    }
    
    /* Album Screen */
    .album-screen{
      padding: 0;
      overflow-y: auto; /* Permetti scroll verticale */
      -webkit-overflow-scrolling: touch; /* Smooth scroll su iOS */
    }
    
    .album-header{
      position: sticky;
      top: 0;
      background: var(--bg-dark2);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      z-index: 999; /* Sotto il banner sticky ma sopra il contenuto */
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    
    .album-back{
      background: none;
      border: none;
      color: var(--text-light);
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
    }
    
    .album-cart{
      background: var(--accent);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    
    .album-profile{
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .profile-avatar{
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--bg-dark2);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .profile-avatar img{
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .profile-info h3{
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 2px;
      line-height: 1.2;
    }
    
    .profile-info p{
      font-size: 11px;
      color: var(--text-muted);
      line-height: 1.3;
      margin: 0;
    }
    
    .album-tabs{
      display: flex;
      padding: 0 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .album-tab{
      background: none;
      border: none;
      color: var(--text-muted);
      padding: 16px 20px;
      font-size: 16px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: color 0.2s, border-color 0.2s;
    }
    
    .album-tab.active{
      color: var(--accent-light);
      border-bottom-color: var(--accent-light);
    }
    
    .album-tab:hover{
      color: var(--text-light);
    }
    
    /* Listino prezzi */
    .prices-list{
      display: none;
      padding: 15px 20px;
      padding-bottom: calc(80px + env(safe-area-inset-bottom)); /* Spazio per banner sticky */
      max-width: 600px;
      margin: 0 auto;
      max-height: calc(100vh - 200px); /* Altezza massima per evitare overflow */
      overflow-y: auto;
    }
    
    .prices-list.active{
      display: block;
    }
    
    .prices-title{
      font-size: 20px;
      font-weight: 700;
      color: var(--text-light);
      margin-bottom: 8px;
      text-align: center;
    }
    
    .prices-subtitle{
      font-size: 12px;
      color: var(--text-muted);
      text-align: center;
      margin-bottom: 12px;
    }
    
    .price-item{
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 16px;
      margin-bottom: 8px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: background 0.2s, transform 0.2s;
    }
    
    .price-item:hover{
      background: rgba(255, 255, 255, 0.08);
      transform: translateX(4px);
    }
    
    .price-item.highlight{
      background: linear-gradient(135deg, rgba(168, 85, 247, 0.2) 0%, rgba(236, 72, 153, 0.2) 100%);
      border-color: var(--purple);
    }
    
    .price-item-info{
      flex: 1;
    }
    
    .price-item-count{
      font-size: 15px;
      font-weight: 600;
      color: var(--text-light);
      margin-bottom: 2px;
    }
    
    .price-item-desc{
      font-size: 11px;
      color: var(--text-muted);
    }
    
    .price-item-value{
      font-size: 20px;
      font-weight: 700;
      color: var(--accent-light);
    }
    
    .price-item-badge{
      display: inline-block;
      background: var(--purple);
      color: white;
      font-size: 10px;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 4px;
      margin-left: 8px;
      text-transform: uppercase;
    }
    
    .album-tab.active{
      color: var(--text-light);
      border-bottom-color: var(--accent);
    }
    
    .album-grid{
      padding: 20px;
      padding-bottom: calc(80px + env(safe-area-inset-bottom)); /* Spazio per il banner sticky + safe area iPhone */
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
    }
    
    .album-photo{
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      aspect-ratio: 1;
      background: var(--bg-dark2);
    }
    
    .album-photo img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .album-photo img.loaded{
      opacity: 1;
    }
    
    .album-photo .photo-skeleton{
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, 
        rgba(255,255,255,0.05) 0%, 
        rgba(255,255,255,0.1) 50%, 
        rgba(255,255,255,0.05) 100%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s ease-in-out infinite;
    }
    
    @keyframes skeleton-loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    .album-loading-overlay{
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(4px);
    }
    
    .album-loading-overlay.active{
      display: flex;
    }
    
    .album-loading-content{
      text-align: center;
      color: white;
    }
    
    .album-loading-spinner{
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255,255,255,0.3);
      border-top-color: var(--purple);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    .album-photo .add-cart{
      position: absolute;
      bottom: 8px;
      right: 8px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(0,0,0,0.6);
      border: 2px solid rgba(255,255,255,0.3);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 0;
      transition: all 0.3s ease;
    }
    
    .album-photo .add-cart::before{
      content: '';
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid white;
      background: transparent;
      transition: all 0.3s ease;
    }
    
    .album-photo .add-cart.in-cart{
      background: var(--accent);
      border-color: var(--accent);
    }
    
    .album-photo .add-cart.in-cart::before{
      background: white;
      border-color: white;
    }
    
    .album-buy-all{
      margin: 20px;
      background: linear-gradient(135deg, var(--purple) 0%, var(--pink) 100%);
      color: white;
      border: none;
      padding: 20px;
      border-radius: 16px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 20px rgba(168, 85, 247, 0.4);
    }
    
    .album-buy-all .price{
      font-size: 24px;
    }
    
    .album-buy-all .subtitle{
      font-size: 14px;
      opacity: 0.9;
      margin-top: 4px;
    }
    
    /* Modal styles */
    .ios-share-modal{
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1001;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    
    .ios-share-modal.active{
      opacity: 1;
      visibility: visible;
    }
    
    .ios-share-modal-content{
      background: var(--bg-dark2);
      padding: 30px;
      border-radius: 20px;
      text-align: center;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Sticky Offer Bar */
    .sticky-offer-bar{
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, var(--purple) 0%, var(--pink) 100%);
      padding: 8px 12px;
      padding-bottom: calc(8px + env(safe-area-inset-bottom)); /* Safe area iPhone */
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
      z-index: 1000; /* Z-index pi√π alto per essere sopra tutto */
      display: none;
      transform: translateY(100%);
      transition: transform 0.3s ease-out;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      /* Assicura che rimanga fisso durante lo scroll con accelerazione hardware */
      will-change: transform;
      -webkit-transform: translateZ(0);
      transform: translateZ(0) translateY(100%);
      min-height: 60px; /* Altezza minima ridotta */
    }
    
    .sticky-offer-bar.active{
      transform: translateZ(0) translateY(0);
    }
    
    /* Mostra solo quando lo schermo album √® attivo */
    .album-screen.active ~ .sticky-offer-bar.active,
    body:has(.album-screen.active) .sticky-offer-bar.active{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      animation: slideUp 0.4s ease-out forwards;
    }
    
    @keyframes slideUp {
      from {
        transform: translateY(100%);
      }
      to {
        transform: translateY(0);
      }
    }
    
    .sticky-offer-content{
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .sticky-offer-text{
      font-size: 12px;
      font-weight: 600;
      color: white;
      line-height: 1.2;
    }
    
    .sticky-offer-price{
      font-size: 16px;
      font-weight: 700;
      color: white;
    }
    
    .sticky-offer-actions{
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .sticky-offer-btn{
      background: white;
      color: var(--purple);
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: transform 0.2s, opacity 0.2s;
    }
    
    .sticky-offer-btn:active{
      transform: scale(0.95);
      opacity: 0.8;
    }
    
    .sticky-offer-close{
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
      flex-shrink: 0;
      transition: background 0.2s;
    }
    
    .sticky-offer-close:active{
      background: rgba(255, 255, 255, 0.3);
    }
    
    /* Paid Photos Countdown Banner */
    .paid-countdown-banner{
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
      padding: 12px 20px;
      z-index: 90;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      transform: translateY(-100%);
      transition: transform 0.3s ease;
    }
    
    .paid-countdown-banner.show{
      transform: translateY(0);
    }
    
    .paid-countdown-content{
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      max-width: 1200px;
      margin: 0 auto;
      font-size: 14px;
      font-weight: 500;
    }
    
    .paid-countdown-icon{
      font-size: 18px;
    }
    
    .paid-countdown-text{
      text-align: center;
    }
    
    .paid-countdown-text strong{
      font-weight: 700;
      font-size: 16px;
    }
    
    /* Album photo count banner sopra la griglia */
    .album-photo-count{
      padding: 12px 20px;
      background: rgba(168, 85, 247, 0.1);
      border-bottom: 1px solid rgba(168, 85, 247, 0.2);
      text-align: center;
      font-size: 16px;
      font-weight: 600;
      color: var(--accent-light);
    }
  </style>
</head>
<body>
  <!-- Language Selection Screen -->
  <div class="screen language-screen active" id="languageScreen">
    <h1 class="language-title" data-i18n="language.title">Choose your language</h1>
    <p class="language-subtitle" data-i18n="language.subtitle">Select your preferred language</p>
    <div class="language-grid">
      <div class="language-option" data-lang="en">
        <div class="language-flag">üá¨üáß</div>
        <div class="language-name">English</div>
      </div>
      <div class="language-option" data-lang="it">
        <div class="language-flag">üáÆüáπ</div>
        <div class="language-name">Italiano</div>
      </div>
      <div class="language-option" data-lang="fr">
        <div class="language-flag">üá´üá∑</div>
        <div class="language-name">Fran√ßais</div>
      </div>
      <div class="language-option" data-lang="de">
        <div class="language-flag">üá©üá™</div>
        <div class="language-name">Deutsch</div>
      </div>
      <div class="language-option" data-lang="es">
        <div class="language-flag">üá™üá∏</div>
        <div class="language-name">Espa√±ol</div>
      </div>
    </div>
  </div>

  <!-- Email Screen -->
  <div class="screen email-screen" id="emailScreen">
    <h1 class="email-title" data-i18n="email.title">Inserisci la tua email</h1>
    <p class="email-subtitle" data-i18n="email.subtitle">La tua email √® obbligatoria per salvare e recuperare le tue foto</p>
    <div class="email-input-container">
      <input type="email" class="email-input" id="emailInput" placeholder="tua@email.com" data-i18n-placeholder="email.placeholder">
      <p class="email-error" id="emailError" data-i18n="email.error">Email non valida</p>
    </div>
    <button class="btn-primary" id="emailContinueBtn" data-i18n="email.continue">Continua</button>
  </div>

  <!-- Welcome Screen -->
  <div class="screen welcome-screen" id="welcomeScreen">
    <div class="welcome-icon">
      <svg viewBox="0 0 100 100">
        <rect x="20" y="25" width="60" height="50" rx="8"/>
        <circle cx="50" cy="45" r="12"/>
        <rect x="35" y="60" width="30" height="8" rx="4"/>
        <circle cx="70" cy="35" r="4"/>
      </svg>
    </div>
    <h1 class="welcome-title" data-i18n="welcome.title">Find your photos!</h1>
    <p class="welcome-text" data-i18n="welcome.text">
      In the next step you will be asked to enable the camera, to allow our system to deliver your event photos.
    </p>
    <button class="btn-primary" id="welcomeContinueBtn" data-i18n="welcome.continue">Continue</button>
    <p class="welcome-privacy" data-i18n="welcome.privacy">
      We operate in full respect of Privacy and use your face exclusively to find photos that feature you.
    </p>
  </div>

  <!-- Selfie Screen -->
  <div class="screen selfie-screen" id="selfieScreen">
    <div class="selfie-header">
      <h2 data-i18n="selfie.title">Take your selfie</h2>
    </div>
    <div class="selfie-preview">
      <div class="selfie-video">
        <video id="video" autoplay playsinline muted webkit-playsinline></video>
        <canvas id="canvas" style="display:none;"></canvas>
        <div id="videoPlaceholder" style="display: none; text-align: center; padding: 20px; color: var(--text-muted);">
          <p style="font-size: 14px;" data-i18n="selfie.error">Camera not available</p>
          <button class="btn-primary" id="retryCameraBtn" style="margin-top: 15px; padding: 12px 24px; font-size: 14px;" data-i18n="selfie.retry">Retry</button>
        </div>
      </div>
      <div class="selfie-controls">
        <button class="camera-btn" id="captureBtn" disabled>
          <svg viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="10"/>
          </svg>
        </button>
        <button class="btn-retake" id="switchCameraBtn" style="display:none;">Cambia camera</button>
      </div>
    </div>
    <!-- Upload Status Area - sempre visibile quando attiva -->
    <div class="upload-status" id="uploadStatus">
      <div class="upload-status-text">
        <span class="upload-spinner"></span>
        <span id="uploadStatusText">Caricamento in corso...</span>
      </div>
      <div class="upload-progress-container">
        <div class="upload-progress-bar" id="uploadProgressBar"></div>
      </div>
      <div class="upload-percentage" id="uploadPercentage">0%</div>
    </div>
  </div>

  <!-- Confirm Selfie Screen -->
  <div class="screen confirm-screen" id="confirmScreen">
    <h2 class="confirm-title" data-i18n="confirm.title">Confirm selfie</h2>
    <div class="confirm-preview">
      <img id="confirmPreview" alt="Selfie preview">
    </div>
    <p class="confirm-privacy" data-i18n="confirm.privacy">
      By selecting "Confirm" you consent to the processing of biometric data for the purposes of Detection and Recognition as per Privacy Policy.
    </p>
    <div class="confirm-buttons">
      <button class="btn-confirm" id="confirmBtn" data-i18n="confirm.confirm">Confirm</button>
      <button class="btn-retake" id="retakeBtn" data-i18n="confirm.retake">Take again</button>
    </div>
    <!-- Loading indicator per ricerca foto -->
    <div id="confirmLoadingIndicator" style="display: none; text-align: center; margin-top: 20px;">
      <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top-color: var(--purple); border-radius: 50%; animation: spin 1s linear infinite;"></div>
      <p style="color: var(--text-muted); margin-top: 15px;" data-i18n="upload.loading">Loading photos...</p>
    </div>
  </div>

  <!-- Add People Screen -->
  <div class="screen add-people-screen" id="addPeopleScreen">
    <h2 class="add-people-title">Ottimo!</h2>
    <p style="color: var(--text-muted); margin-bottom: 30px;">Vuoi aggiungere al tuo album altri membri della famiglia?</p>
    <div class="people-list" id="peopleList">
      <div class="person-avatar">
        <img id="mainPersonAvatar" alt="Persona principale">
      </div>
      <button class="add-person-btn" id="addPersonBtn">+</button>
    </div>
    <div class="add-people-buttons">
      <button class="btn-primary" id="addPersonConfirmBtn">S√¨, aggiungi un'altra persona</button>
      <button class="btn-retake" id="skipAddPersonBtn">Non ora, vai all'album</button>
    </div>
    <!-- Loading indicator -->
    <div id="loadingIndicator" style="display: none; text-align: center; margin-top: 20px;">
      <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top-color: var(--purple); border-radius: 50%; animation: spin 1s linear infinite;"></div>
      <p style="color: var(--text-muted); margin-top: 15px;">Caricamento foto in corso...</p>
    </div>
  </div>

  <!-- Album Screen -->
  <div class="screen album-screen" id="albumScreen">
    <div class="album-header">
      <button class="album-back" id="albumBackBtn">‚Üê</button>
      <button class="album-cart" id="albumCartBtn">
        üõí <span id="albumCartCount">0</span> - <span id="albumCartPrice">‚Ç¨0</span>
      </button>
    </div>
    <div class="album-profile">
      <div class="profile-avatar">
        <!-- Logo rimosso per evitare 404 - usa solo testo -->
      </div>
      <div class="profile-info">
        <h3>Tenerife Stars Pictures</h3>
        <p data-i18n="album.sessionBy">Your photo session was taken by Metaproos</p>
      </div>
    </div>
    <div class="album-tabs">
      <button class="album-tab active" id="myContentTab" data-i18n="album.myContent">My content</button>
      <button class="album-tab" id="pricesTab" data-i18n="album.priceList">Price list ‚Üó</button>
    </div>
    <div class="album-photo-count" id="albumPhotoCount" style="display: none;">
      <span data-i18n="album.found" data-i18n-params='{"count": 0}'>You found <span id="photoCountNumber">0</span> photos</span>
    </div>
    
    <!-- Listino Prezzi -->
    <div class="prices-list" id="pricesList">
      <h2 class="prices-title" data-i18n="prices.title">Price List</h2>
      <p class="prices-subtitle" data-i18n="prices.subtitle">Choose the offer you prefer</p>
      
      <div class="price-item">
        <div class="price-item-info">
          <div class="price-item-count">1 <span data-i18n="prices.photo">photo</span></div>
          <div class="price-item-desc" data-i18n="prices.single">Single photo</div>
        </div>
        <div class="price-item-value">‚Ç¨20</div>
      </div>
      
      <div class="price-item">
        <div class="price-item-info">
          <div class="price-item-count">2 <span data-i18n="prices.photo">photos</span></div>
          <div class="price-item-desc" data-i18n="prices.double">Double</div>
        </div>
        <div class="price-item-value">‚Ç¨40</div>
      </div>
      
      <div class="price-item highlight">
        <div class="price-item-info">
          <div class="price-item-count">3 <span data-i18n="prices.photo">photos</span> <span class="price-item-badge" data-i18n="prices.badgeDiscount">Discount</span></div>
          <div class="price-item-desc" data-i18n="prices.special">Special offer</div>
        </div>
        <div class="price-item-value">‚Ç¨35</div>
      </div>
      
      <div class="price-item">
        <div class="price-item-info">
          <div class="price-item-count">4 <span data-i18n="prices.photo">photos</span></div>
          <div class="price-item-desc" data-i18n="prices.package">Package</div>
        </div>
        <div class="price-item-value">‚Ç¨40</div>
      </div>
      
      <div class="price-item">
        <div class="price-item-info">
          <div class="price-item-count">5 <span data-i18n="prices.photo">photos</span></div>
          <div class="price-item-desc" data-i18n="prices.package">Package</div>
        </div>
        <div class="price-item-value">‚Ç¨45</div>
      </div>
      
      <div class="price-item highlight">
        <div class="price-item-info">
          <div class="price-item-count">6-11 <span data-i18n="prices.photo">photos</span> <span class="price-item-badge" data-i18n="prices.badgeBest">Best</span></div>
          <div class="price-item-desc" data-i18n="prices.complete">Complete package</div>
        </div>
        <div class="price-item-value">‚Ç¨50</div>
      </div>
      
      <div class="price-item highlight">
        <div class="price-item-info">
          <div class="price-item-count">12+ <span data-i18n="prices.photo">photos</span> <span class="price-item-badge" data-i18n="prices.badgeTop">Top</span></div>
          <div class="price-item-desc" data-i18n="prices.best">All photos at the best price</div>
        </div>
        <div class="price-item-value">‚Ç¨60</div>
      </div>
    </div>
    
    <div class="album-grid" id="albumGrid">
      <!-- Foto verranno aggiunte qui -->
    </div>
    
    <!-- Overlay caricamento album -->
    <div class="album-loading-overlay" id="albumLoadingOverlay">
      <div class="album-loading-content">
        <div class="album-loading-spinner"></div>
        <p id="albumLoadingText">Loading photos...</p>
      </div>
    </div>
    
  </div>
  
  <!-- Sticky Offer Bar -->
  <div class="sticky-offer-bar" id="stickyOfferBar">
    <div class="sticky-offer-content">
      <div class="sticky-offer-text" id="stickyOfferText">Acquista tutte le foto</div>
      <div class="sticky-offer-price" id="stickyOfferPrice">‚Ç¨0</div>
    </div>
    <div class="sticky-offer-actions">
      <button class="sticky-offer-btn" id="stickyOfferBuyBtn">Acquista</button>
    </div>
  </div>
  
  <!-- Paid Photos Countdown Banner -->
  <div class="paid-countdown-banner" id="paidCountdownBanner" style="display: none;">
    <div class="paid-countdown-content">
      <span class="paid-countdown-icon">‚è∞</span>
      <span class="paid-countdown-text" id="paidCountdownText">Le tue foto pagate scadranno tra <strong id="paidCountdownDays">30</strong> giorni</span>
    </div>
  </div>

  <!-- Lightbox per foto -->
  <div class="ios-share-modal" id="photoLightbox" style="z-index: 2000;">
    <div style="position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
      <button id="lightboxClose" style="position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.6); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 24px; cursor: pointer; z-index: 10;">‚úï</button>
      <div style="position: absolute; top: 20px; left: 20px; color: white; font-size: 16px; z-index: 10; background: rgba(0,0,0,0.6); padding: 8px 16px; border-radius: 20px;" id="photoCounter">1/1</div>
      <button id="lightboxPrev" style="position: absolute; left: 20px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.6); color: white; border: none; width: 50px; height: 50px; border-radius: 50%; font-size: 24px; cursor: pointer; z-index: 10; display: none;">‚Üê</button>
      <button id="lightboxNext" style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.6); color: white; border: none; width: 50px; height: 50px; border-radius: 50%; font-size: 24px; cursor: pointer; z-index: 10; display: none;">‚Üí</button>
      <button id="lightboxDownload" style="position: absolute; bottom: 20px; right: 20px; background: rgba(123, 116, 255, 0.9); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; z-index: 10; display: none;">üì• Scarica</button>
      <img id="lightboxImage" style="max-width: 100%; max-height: 100%; object-fit: contain; user-select: none; -webkit-user-drag: none;" alt="Foto">
    </div>
  </div>
  
  <!-- Modal Carrello -->
  <div class="ios-share-modal" id="cartModal">
    <div class="ios-share-modal-content" style="max-width: 500px; width: 90%;">
      <h3 style="margin-top: 0; font-size: 20px; color: var(--text-light);">üõí Carrello</h3>
      <div id="cartItems" style="max-height: 400px; overflow-y: auto; margin: 20px 0;">
        <p style="text-align: center; color: var(--text-muted);">Il carrello √® vuoto</p>
      </div>
      <div style="border-top: 2px solid rgba(255,255,255,0.1); padding-top: 15px; margin-top: 15px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 18px; font-weight: 600; color: var(--text-light);">
          <span>Totale:</span>
          <span id="cartTotal">‚Ç¨0.00</span>
        </div>
        <button class="btn-primary" id="checkoutBtn" style="width: 100%; margin-bottom: 10px;" disabled>üí≥ Vai al Pagamento</button>
        <button class="btn-retake" id="closeCartBtn" style="width: 100%;">Chiudi</button>
      </div>
    </div>
  </div>

  <!-- Modal Offerte -->
  <div class="ios-share-modal" id="offersModal">
    <div class="ios-share-modal-content" style="max-width: 500px; width: 90%; background: var(--bg-dark2); border: 2px solid var(--accent);">
      <h3 style="margin-top: 0; font-size: 24px; color: var(--text-light); text-align: center;">üéÅ Offerta Speciale!</h3>
      <div id="offersContent" style="text-align: center; padding: 20px 0;">
        <p style="font-size: 18px; color: var(--text-light); margin-bottom: 15px;">
          Hai trovato <strong id="offersPhotoCount" style="color: var(--accent-light);">0</strong> foto!
        </p>
        <div id="offersMessage" style="font-size: 16px; color: var(--text-muted); margin-bottom: 20px;">
          <!-- Messaggio offerta dinamico -->
        </div>
        <div style="background: linear-gradient(135deg, var(--purple), var(--pink)); color: #fff; padding: 20px; border-radius: 12px; margin: 20px 0;">
          <div style="font-size: 32px; font-weight: 900; margin-bottom: 10px;" id="offersPrice">‚Ç¨0</div>
          <div style="font-size: 14px; opacity: 0.9;">per tutte le tue foto</div>
        </div>
        <button class="btn-primary" id="offersBuyBtn" style="width: 100%; margin-bottom: 10px; font-size: 18px; padding: 16px;">
          üí≥ Acquista Tutte le Foto
        </button>
        <button class="btn-retake" id="offersCloseBtn" style="width: 100%;">
          Scegli Foto Singole
        </button>
      </div>
    </div>
  </div>

  <script>
    // ========== SISTEMA TRADUZIONI ==========
    const translations = {
      en: {
        language: { title: "Choose your language", subtitle: "Select your preferred language" },
        email: { title: "Enter your email", subtitle: "Your email is required to save and recover your photos", placeholder: "your@email.com", continue: "Continue", error: "Invalid email address", required: "Email is required for checkout" },
        welcome: { title: "Find your photos!", text: "In the next step you will be asked to enable the camera, to allow our system to deliver your event photos.", continue: "Continue", privacy: "We operate in full respect of Privacy and use your face exclusively to find photos that feature you." },
        selfie: { title: "Take your selfie", error: "Camera not available", retry: "Retry" },
        confirm: { title: "Confirm selfie", privacy: "By selecting \"Confirm\" you consent to the processing of biometric data for the purposes of Detection and Recognition as per Privacy Policy.", confirm: "Confirm", retake: "Take again" },
        upload: { loading: "Loading photos...", sending: "Sending selfie to server...", analyzing: "Analyzing photos...", found: "Found {count} photos!" },
        album: { myContent: "My content", priceList: "Price list ‚Üó", found: "You found {count} photos", buyAll: "Buy all photos at", digital: "in digital format", sessionBy: "Your photo session was taken by Metaproos" },
        prices: { title: "Price List", subtitle: "Choose the offer you prefer", photo: "photos", single: "Single photo", double: "Double", special: "Special offer", package: "Package", complete: "Complete package", best: "All photos at the best price", badgeDiscount: "Discount", badgeBest: "Best", badgeTop: "Top" },
        cart: { title: "Cart", empty: "Cart is empty", total: "Total:", checkout: "Go to Payment", close: "Close" },
        sticky: { buy1: "Buy your photo", buyFew: "Buy all {count} photos", buyMany: "Buy all {count} photos and save", buyAll: "Buy all {count} photos at the best price", buy: "Buy" },
        errors: { noPhotos: "No photos found. Try again.", connection: "Connection error. Check your internet connection and try again.", camera: "Camera error", cameraNotReady: "Camera not ready yet. Wait a moment and try again." }
      },
      it: {
        language: { title: "Scegli la tua lingua", subtitle: "Seleziona la lingua preferita" },
        email: { title: "Inserisci la tua email", subtitle: "La tua email √® obbligatoria per salvare e recuperare le tue foto", placeholder: "tua@email.com", continue: "Continua", error: "Email non valida", required: "L'email √® obbligatoria per il checkout" },
        welcome: { title: "Trova le tue foto!", text: "Nel prossimo passaggio ti sar√† chiesto di abilitare la fotocamera, per permettere al nostro sistema di consegnare le tue foto dell'evento.", continue: "Continua", privacy: "Operiamo nel totale rispetto della Privacy ed utilizziamo il tuo viso esclusivamente per trovare le foto che ti ritraggono." },
        selfie: { title: "Scatta il tuo selfie", error: "La fotocamera non √® disponibile", retry: "Riprova" },
        confirm: { title: "Conferma selfie", privacy: "Selezionando \"Conferma\" acconsenti al trattamento dei dati biometrici per le finalit√† di Rilevazione e Riconoscimento come da Privacy Policy.", confirm: "Conferma", retake: "Scatta di nuovo" },
        upload: { loading: "Caricamento foto in corso...", sending: "Invio selfie al server...", analyzing: "Analisi foto in corso...", found: "Trovate {count} foto!" },
        album: { myContent: "I miei contenuti", priceList: "Listino prezzi ‚Üó", found: "Hai trovato {count} foto", buyAll: "Acquista tutte le foto a", digital: "in formato digitale", sessionBy: "La tua sessione fotografica √® stata realizzata da Metaproos" },
        prices: { title: "Listino Prezzi", subtitle: "Scegli l'offerta che preferisci", photo: "foto", single: "Foto singola", double: "Doppia", special: "Offerta speciale", package: "Pacchetto", complete: "Pacchetto completo", best: "Tutte le foto al prezzo migliore", badgeDiscount: "Sconto", badgeBest: "Migliore", badgeTop: "Top" },
        cart: { title: "Carrello", empty: "Il carrello √® vuoto", total: "Totale:", checkout: "Vai al Pagamento", close: "Chiudi" },
        sticky: { buy1: "Acquista la tua foto", buyFew: "Acquista tutte le {count} foto", buyMany: "Acquista tutte le {count} foto e risparmia", buyAll: "Acquista tutte le {count} foto al prezzo migliore", buy: "Acquista" },
        errors: { noPhotos: "Nessuna foto trovata. Riprova.", connection: "Errore di connessione. Controlla la tua connessione internet e riprova.", camera: "Errore accesso camera", cameraNotReady: "La fotocamera non √® ancora pronta. Attendi un attimo e riprova." }
      },
      fr: {
        language: { title: "Choisissez votre langue", subtitle: "S√©lectionnez votre langue pr√©f√©r√©e" },
        email: { title: "Entrez votre email", subtitle: "Votre email est requis pour enregistrer et r√©cup√©rer vos photos", placeholder: "votre@email.com", continue: "Continuer", error: "Adresse email invalide", required: "L'email est requise pour le paiement" },
        welcome: { title: "Trouvez vos photos!", text: "Dans la prochaine √©tape, il vous sera demand√© d'activer la cam√©ra pour permettre √† notre syst√®me de vous livrer les photos de l'√©v√©nement.", continue: "Continuer", privacy: "Nous op√©rons dans le plein respect de la vie priv√©e et utilisons votre visage exclusivement pour trouver les photos qui vous repr√©sentent." },
        selfie: { title: "Prenez votre selfie", error: "Cam√©ra non disponible", retry: "R√©essayer" },
        confirm: { title: "Confirmer le selfie", privacy: "En s√©lectionnant \"Confirmer\", vous acceptez le traitement des donn√©es biom√©triques aux fins de D√©tection et Reconnaissance conform√©ment √† la Politique de Confidentialit√©.", confirm: "Confirmer", retake: "Reprendre" },
        upload: { loading: "Chargement des photos...", sending: "Envoi du selfie au serveur...", analyzing: "Analyse des photos...", found: "{count} photos trouv√©es!" },
        album: { myContent: "Mes contenus", priceList: "Liste des prix ‚Üó", found: "Vous avez trouv√© {count} photos", buyAll: "Acheter toutes les photos √†", digital: "en format num√©rique", sessionBy: "Votre s√©ance photo a √©t√© r√©alis√©e par Metaproos" },
        prices: { title: "Liste des Prix", subtitle: "Choisissez l'offre que vous pr√©f√©rez", photo: "photos", single: "Photo unique", double: "Double", special: "Offre sp√©ciale", package: "Forfait", complete: "Forfait complet", best: "Toutes les photos au meilleur prix", badgeDiscount: "R√©duction", badgeBest: "Meilleur", badgeTop: "Top" },
        cart: { title: "Panier", empty: "Le panier est vide", total: "Total:", checkout: "Aller au Paiement", close: "Fermer" },
        sticky: { buy1: "Achetez votre photo", buyFew: "Achetez toutes les {count} photos", buyMany: "Achetez toutes les {count} photos et √©conomisez", buyAll: "Achetez toutes les {count} photos au meilleur prix", buy: "Acheter" },
        errors: { noPhotos: "Aucune photo trouv√©e. R√©essayez.", connection: "Erreur de connexion. V√©rifiez votre connexion internet et r√©essayez.", camera: "Erreur d'acc√®s √† la cam√©ra", cameraNotReady: "La cam√©ra n'est pas encore pr√™te. Attendez un instant et r√©essayez." }
      },
      de: {
        language: { title: "W√§hlen Sie Ihre Sprache", subtitle: "W√§hlen Sie Ihre bevorzugte Sprache" },
        email: { title: "Geben Sie Ihre E-Mail ein", subtitle: "Ihre E-Mail ist erforderlich, um Ihre Fotos zu speichern und wiederherzustellen", placeholder: "ihre@email.com", continue: "Weiter", error: "Ung√ºltige E-Mail-Adresse", required: "E-Mail ist f√ºr den Checkout erforderlich" },
        welcome: { title: "Finden Sie Ihre Fotos!", text: "Im n√§chsten Schritt werden Sie aufgefordert, die Kamera zu aktivieren, damit unser System Ihnen Ihre Event-Fotos liefern kann.", continue: "Weiter", privacy: "Wir arbeiten im vollsten Respekt der Privatsph√§re und verwenden Ihr Gesicht ausschlie√ülich, um Fotos zu finden, auf denen Sie abgebildet sind." },
        selfie: { title: "Machen Sie Ihr Selfie", error: "Kamera nicht verf√ºgbar", retry: "Erneut versuchen" },
        confirm: { title: "Selfie best√§tigen", privacy: "Durch Auswahl von \"Best√§tigen\" stimmen Sie der Verarbeitung biometrischer Daten zu den Zwecken der Erkennung und Identifizierung gem√§√ü Datenschutzrichtlinie zu.", confirm: "Best√§tigen", retake: "Erneut aufnehmen" },
        upload: { loading: "Fotos werden geladen...", sending: "Selfie wird an Server gesendet...", analyzing: "Fotos werden analysiert...", found: "{count} Fotos gefunden!" },
        album: { myContent: "Meine Inhalte", priceList: "Preisliste ‚Üó", found: "Sie haben {count} Fotos gefunden", buyAll: "Alle Fotos kaufen f√ºr", digital: "im digitalen Format", sessionBy: "Ihre Fotosession wurde von Metaproos durchgef√ºhrt" },
        prices: { title: "Preisliste", subtitle: "W√§hlen Sie das Angebot, das Sie bevorzugen", photo: "Fotos", single: "Einzelfoto", double: "Doppel", special: "Sonderangebot", package: "Paket", complete: "Vollst√§ndiges Paket", best: "Alle Fotos zum besten Preis", badgeDiscount: "Rabatt", badgeBest: "Beste", badgeTop: "Top" },
        cart: { title: "Warenkorb", empty: "Der Warenkorb ist leer", total: "Gesamt:", checkout: "Zur Zahlung", close: "Schlie√üen" },
        sticky: { buy1: "Kaufen Sie Ihr Foto", buyFew: "Kaufen Sie alle {count} Fotos", buyMany: "Kaufen Sie alle {count} Fotos und sparen", buyAll: "Kaufen Sie alle {count} Fotos zum besten Preis", buy: "Kaufen" },
        errors: { noPhotos: "Keine Fotos gefunden. Versuchen Sie es erneut.", connection: "Verbindungsfehler. √úberpr√ºfen Sie Ihre Internetverbindung und versuchen Sie es erneut.", camera: "Kamerafehler", cameraNotReady: "Die Kamera ist noch nicht bereit. Warten Sie einen Moment und versuchen Sie es erneut." }
      },
      es: {
        language: { title: "Elige tu idioma", subtitle: "Selecciona tu idioma preferido" },
        email: { title: "Ingresa tu email", subtitle: "Tu email es obligatorio para guardar y recuperar tus fotos", placeholder: "tu@email.com", continue: "Continuar", error: "Email inv√°lido", required: "El email es obligatorio para el checkout" },
        welcome: { title: "¬°Encuentra tus fotos!", text: "En el siguiente paso se te pedir√° que habilites la c√°mara, para permitir que nuestro sistema te entregue las fotos del evento.", continue: "Continuar", privacy: "Operamos con total respeto a la Privacidad y utilizamos tu rostro exclusivamente para encontrar fotos en las que apareces." },
        selfie: { title: "Toma tu selfie", error: "C√°mara no disponible", retry: "Reintentar" },
        confirm: { title: "Confirmar selfie", privacy: "Al seleccionar \"Confirmar\" consientes el tratamiento de datos biom√©tricos para los fines de Detecci√≥n y Reconocimiento seg√∫n la Pol√≠tica de Privacidad.", confirm: "Confirmar", retake: "Tomar de nuevo" },
        upload: { loading: "Cargando fotos...", sending: "Enviando selfie al servidor...", analyzing: "Analizando fotos...", found: "¬°{count} fotos encontradas!" },
        album: { myContent: "Mis contenidos", priceList: "Lista de precios ‚Üó", found: "Has encontrado {count} fotos", buyAll: "Comprar todas las fotos por", digital: "en formato digital", sessionBy: "Tu sesi√≥n de fotos fue realizada por Metaproos" },
        prices: { title: "Lista de Precios", subtitle: "Elige la oferta que prefieras", photo: "fotos", single: "Foto √∫nica", double: "Doble", special: "Oferta especial", package: "Paquete", complete: "Paquete completo", best: "Todas las fotos al mejor precio", badgeDiscount: "Descuento", badgeBest: "Mejor", badgeTop: "Top" },
        cart: { title: "Carrito", empty: "El carrito est√° vac√≠o", total: "Total:", checkout: "Ir al Pago", close: "Cerrar" },
        sticky: { buy1: "Compra tu foto", buyFew: "Compra todas las {count} fotos", buyMany: "Compra todas las {count} fotos y ahorra", buyAll: "Compra todas las {count} fotos al mejor precio", buy: "Comprar" },
        errors: { noPhotos: "No se encontraron fotos. Int√©ntalo de nuevo.", connection: "Error de conexi√≥n. Verifica tu conexi√≥n a internet e int√©ntalo de nuevo.", camera: "Error de acceso a la c√°mara", cameraNotReady: "La c√°mara a√∫n no est√° lista. Espera un momento e int√©ntalo de nuevo." }
      }
    };

    // Lingua corrente (default: inglese)
    let currentLang = localStorage.getItem('selectedLanguage') || 'en';

    // Funzione per ottenere traduzione
    function t(key, params = {}) {
      const keys = key.split('.');
      let value = translations[currentLang];
      for(const k of keys) {
        value = value?.[k];
      }
      if(!value) {
        // Fallback a inglese
        value = translations.en;
        for(const k of keys) {
          value = value?.[k];
        }
      }
      // Sostituisci parametri {count}, etc.
      if(typeof value === 'string' && params) {
        return value.replace(/\{(\w+)\}/g, (match, key) => params[key] || match);
      }
      return value || key;
    }

    // Applica traduzioni a tutti gli elementi con data-i18n
    function applyTranslations() {
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        const text = t(key);
        if(text) {
          el.textContent = text;
        }
      });
      
      // Traduzioni dinamiche per elementi senza data-i18n
      updateDynamicTexts();
    }

    // Aggiorna testi dinamici
    function updateDynamicTexts() {
      // Welcome screen
      const welcomeTitle = document.querySelector('.welcome-title');
      const welcomeText = document.querySelector('.welcome-text');
      const welcomePrivacy = document.querySelector('.welcome-privacy');
      const welcomeBtn = document.getElementById('welcomeContinueBtn');
      if(welcomeTitle) welcomeTitle.textContent = t('welcome.title');
      if(welcomeText) welcomeText.textContent = t('welcome.text');
      if(welcomePrivacy) welcomePrivacy.textContent = t('welcome.privacy');
      if(welcomeBtn) welcomeBtn.textContent = t('welcome.continue');
      
      // Selfie screen
      const selfieHeader = document.querySelector('.selfie-header h2');
      if(selfieHeader) selfieHeader.textContent = t('selfie.title');
      
      // Confirm screen
      const confirmTitle = document.querySelector('.confirm-title');
      const confirmPrivacy = document.querySelector('.confirm-privacy');
      const confirmBtn = document.getElementById('confirmBtn');
      const retakeBtn = document.getElementById('retakeBtn');
      if(confirmTitle) confirmTitle.textContent = t('confirm.title');
      if(confirmPrivacy) confirmPrivacy.textContent = t('confirm.privacy');
      if(confirmBtn) confirmBtn.textContent = t('confirm.confirm');
      if(retakeBtn) retakeBtn.textContent = t('confirm.retake');
      
      // Album tabs
      const myContentTab = document.getElementById('myContentTab');
      const pricesTab = document.getElementById('pricesTab');
      if(myContentTab) myContentTab.textContent = t('album.myContent');
      if(pricesTab) pricesTab.textContent = t('album.priceList');
      
      // Buy all button rimosso - ora si usa solo il banner sticky
      
      // Cart modal
      const cartTitle = document.querySelector('#cartModal h3');
      const cartEmpty = document.querySelector('#cartItems p');
      const cartTotal = document.querySelector('#cartModal [data-i18n="cart.total"]');
      const checkoutBtn = document.getElementById('checkoutBtn');
      const closeCartBtn = document.getElementById('closeCartBtn');
      if(cartTitle) cartTitle.innerHTML = `üõí ${t('cart.title')}`;
      if(cartEmpty) cartEmpty.textContent = t('cart.empty');
      if(cartTotal) cartTotal.textContent = t('cart.total');
      if(checkoutBtn) checkoutBtn.textContent = `üí≥ ${t('cart.checkout')}`;
      if(closeCartBtn) closeCartBtn.textContent = t('cart.close');
      
      // Upload status text
      const uploadStatusText = document.getElementById('uploadStatusText');
      if(uploadStatusText && !uploadStatusText.dataset.i18nApplied) {
        uploadStatusText.textContent = t('upload.loading');
        uploadStatusText.dataset.i18nApplied = 'true';
      }
    }

    // Variabili globali
    let currentScreen = 'language';
    let stream = null;
    let useFront = true;
    let capturedBlob = null;
    let sessionId = localStorage.getItem("cart_session_id") || "session_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);
    localStorage.setItem("cart_session_id", sessionId);
    let currentCart = { photo_ids: [], count: 0, price_euros: 0 };
    let allPhotos = [];
    let currentPhotoIndex = 0;
    let paidPhotos = []; // Array di photo_id pagate

    // Elementi DOM
    const welcomeScreen = document.getElementById("welcomeScreen");
    const selfieScreen = document.getElementById("selfieScreen");
    const confirmScreen = document.getElementById("confirmScreen");
    const addPeopleScreen = document.getElementById("addPeopleScreen");
    const albumScreen = document.getElementById("albumScreen");
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const confirmPreview = document.getElementById("confirmPreview");
    const mainPersonAvatar = document.getElementById("mainPersonAvatar");
    const albumGrid = document.getElementById("albumGrid");
    const albumCartBtn = document.getElementById("albumCartBtn");
    const albumCartCount = document.getElementById("albumCartCount");
    const albumCartPrice = document.getElementById("albumCartPrice");
    // buyAllBtn rimosso - ora si usa solo il banner sticky
    const buyAllPrice = document.getElementById("buyAllPrice"); // Mantenuto per compatibilit√† se usato altrove
    const photoLightbox = document.getElementById("photoLightbox");
    const lightboxImage = document.getElementById("photoLightbox").querySelector("img");
    const photoCounter = document.getElementById("photoCounter");

    // Funzioni screen management
    function showScreen(screenName) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      const screen = document.getElementById(screenName + 'Screen');
      if(screen) screen.classList.add('active');
      currentScreen = screenName;
    }

    // Variabile globale per email utente
    let userEmail = null;
    
    // Event listeners per selezione lingua
    document.querySelectorAll('.language-option').forEach(option => {
      option.addEventListener('click', () => {
        const lang = option.getAttribute('data-lang');
        currentLang = lang;
        localStorage.setItem('selectedLanguage', lang);
        applyTranslations();
        showScreen('email');
      });
    });

    // Controlla se c'√® un parametro email nell'URL (ritorno dopo pagamento)
    const urlParams = new URLSearchParams(window.location.search);
    const emailParam = urlParams.get('email');
    const refreshParam = urlParams.get('refresh');
    
    if(emailParam) {
      userEmail = emailParam;
      localStorage.setItem('userEmail', emailParam);
      
      // Se refresh=paid, ricarica le foto pagate
      if(refreshParam === 'paid' && userEmail) {
        // Ricarica foto pagate dal server
        fetch(`/user/photos?email=${encodeURIComponent(userEmail)}`)
          .then(res => res.json())
          .then(data => {
            if(data.ok && data.paid_photos) {
              paidPhotos = data.paid_photos;
              // Se ci sono foto trovate, mostra l'album
              if(data.found_photos && data.found_photos.length > 0) {
                allPhotos = data.found_photos.map(p => ({
                  photo_id: p.photo_id,
                  score: 0,
                  has_face: true,
                  paid: p.status === 'paid'
                }));
                photosLoadedCount = 0;
                displayPhotos();
                showStickyOfferBar(allPhotos.length);
                showScreen('album');
              }
            }
          })
          .catch(e => console.error("Error loading paid photos:", e));
      }
    }
    
    // Controlla se la lingua √® gi√† stata selezionata
    if(localStorage.getItem('selectedLanguage')) {
      currentLang = localStorage.getItem('selectedLanguage');
      // Se refresh=paid, non cambiare schermata (l'album viene mostrato dal codice sopra)
      if(refreshParam === 'paid') {
        // L'album viene gi√† mostrato dal codice sopra, non fare nulla
        // Applica traduzioni dopo che il DOM √® pronto
        setTimeout(() => applyTranslations(), 100);
      } else {
        // Se email gi√† salvata, vai direttamente a welcome (a meno che non siamo gi√† nell'album)
        if(localStorage.getItem('userEmail') && !refreshParam) {
          userEmail = localStorage.getItem('userEmail');
          showScreen('welcome');
        } else if(!refreshParam) {
          showScreen('email');
        }
        // Applica traduzioni dopo che il DOM √® pronto
        setTimeout(() => applyTranslations(), 100);
      }
    } else {
      showScreen('language');
      // Applica traduzioni anche per la schermata language
      setTimeout(() => applyTranslations(), 100);
    }
    
    // Event listener per email screen
    const emailInput = document.getElementById('emailInput');
    const emailError = document.getElementById('emailError');
    const emailContinueBtn = document.getElementById('emailContinueBtn');
    
    emailContinueBtn.addEventListener('click', () => {
      const email = emailInput.value.trim();
      
      // Validazione email
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if(!email || !emailRegex.test(email)) {
        emailError.classList.add('show');
        emailInput.style.borderColor = '#ff4444';
        return;
      }
      
      // Salva email
      userEmail = email;
      localStorage.setItem('userEmail', email);
      emailError.classList.remove('show');
      emailInput.style.borderColor = 'rgba(255, 255, 255, 0.1)';
      
      // Vai a welcome screen
      showScreen('welcome');
    });
    
    // Enter key su input email
    emailInput.addEventListener('keypress', (e) => {
      if(e.key === 'Enter') {
        emailContinueBtn.click();
      }
    });

    // Event listeners
    document.getElementById("welcomeContinueBtn").addEventListener("click", async () => {
      // Prima verifica se utente esiste
      if(userEmail && capturedBlob) {
        try {
          const fd = new FormData();
          fd.append("selfie", capturedBlob, "selfie.jpg");
          
          const checkResponse = await fetch(`/check_user?email=${encodeURIComponent(userEmail)}`, {
            method: 'POST',
            body: fd
          });
          
          const checkData = await checkResponse.json();
          
          if(checkData.ok && checkData.exists && checkData.match) {
            // Utente esistente con selfie matchato - carica foto esistenti
            if(checkData.found_photos && checkData.found_photos.length > 0) {
              allPhotos = checkData.found_photos.map(p => ({
                photo_id: p.photo_id,
                score: 0,
                has_face: true,
                paid: p.status === 'paid'
              }));
              
              // Salva foto pagate
              if(checkData.paid_photos && checkData.paid_photos.length > 0) {
                paidPhotos = checkData.paid_photos;
              } else {
                // Estrai da found_photos quelle con status='paid'
                paidPhotos = checkData.found_photos
                  .filter(p => p.status === 'paid')
                  .map(p => p.photo_id);
              }
              
              photosLoadedCount = 0;
              displayPhotos();
              showStickyOfferBar(allPhotos.length);
              showScreen('album');
              return;
            }
          }
        } catch(e) {
          console.error("Error checking user:", e);
          // Continua con il flusso normale
        }
      }
      
      showScreen('selfie');
      // Aspetta un attimo che lo schermo sia visibile, poi avvia la camera
      setTimeout(async () => {
        await startCamera();
      }, 100);
    });

    document.getElementById("captureBtn").addEventListener("click", captureSelfie);
    document.getElementById("confirmBtn").addEventListener("click", confirmSelfie);
    document.getElementById("retakeBtn").addEventListener("click", () => {
      startCamera();
      showScreen('selfie');
    });
    document.getElementById("retryCameraBtn")?.addEventListener("click", async () => {
      const placeholder = document.getElementById('videoPlaceholder');
      const video = document.getElementById('video');
      if(placeholder) placeholder.style.display = 'none';
      if(video) video.style.display = 'block';
      await startCamera();
    });
    document.getElementById("skipAddPersonBtn").addEventListener("click", () => {
      // Se le foto sono gi√† state caricate, mostra direttamente l'album
      if(allPhotos && allPhotos.length > 0) {
        displayPhotos();
        updateCart();
        showScreen('album');
      } else {
        matchPhotos();
      }
    });
    document.getElementById("addPersonConfirmBtn").addEventListener("click", () => {
      // Per ora salta, poi implementeremo aggiunta persone
      // Se le foto sono gi√† state caricate, mostra direttamente l'album
      if(allPhotos && allPhotos.length > 0) {
        displayPhotos();
        updateCart();
        showScreen('album');
      } else {
        matchPhotos();
      }
    });
    // Pulsante buyAllBtn rimosso - ora si usa solo il banner sticky
    document.getElementById("albumBackBtn").addEventListener("click", () => {
      showScreen('welcome');
    });
    document.getElementById("albumCartBtn").addEventListener("click", () => {
      document.getElementById('cartModal').classList.add('active');
      updateCartModal();
    });
    
    // Gestione tab album
    document.getElementById("myContentTab").addEventListener("click", () => {
      document.getElementById("myContentTab").classList.add('active');
      document.getElementById("pricesTab").classList.remove('active');
      document.getElementById("albumGrid").style.display = 'grid';
      document.getElementById("pricesList").classList.remove('active');
    });
    
    document.getElementById("pricesTab").addEventListener("click", () => {
      document.getElementById("pricesTab").classList.add('active');
      document.getElementById("myContentTab").classList.remove('active');
      document.getElementById("albumGrid").style.display = 'none';
      document.getElementById("pricesList").classList.add('active');
    });
    document.getElementById("closeCartBtn").addEventListener("click", () => {
      document.getElementById('cartModal').classList.remove('active');
    });
    document.getElementById("checkoutBtn").addEventListener("click", checkout);
    
    // Chiudi modal cliccando fuori
    document.getElementById('cartModal').addEventListener('click', (e) => {
      if(e.target.id === 'cartModal') {
        document.getElementById('cartModal').classList.remove('active');
      }
    });
    
    document.getElementById('offersModal').addEventListener('click', (e) => {
      if(e.target.id === 'offersModal') {
        document.getElementById('offersModal').classList.remove('active');
      }
    });

    // Funzioni camera
    async function startCamera() {
      try {
        // Verifica supporto camera
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          alert(t('errors.camera'));
          return;
        }

        // Ferma stream precedente se esiste
        if(stream) {
          stream.getTracks().forEach(track => track.stop());
        }

        console.log("Richiesta accesso camera...");
        stream = await navigator.mediaDevices.getUserMedia({
          video: { 
            facingMode: useFront ? 'user' : 'environment',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          },
          audio: false
        });
        
        console.log("Stream ottenuto, assegno al video...");
        video.srcObject = stream;
        
        // Aspetta che il video sia pronto (importante su mobile)
        await new Promise((resolve, reject) => {
          let resolved = false;
          
          const onPlaying = () => {
            if(!resolved && video.videoWidth > 0 && video.videoHeight > 0) {
              console.log("Video in riproduzione, dimensioni:", video.videoWidth, "x", video.videoHeight);
              resolved = true;
              resolve();
            }
          };
          
          const checkReady = () => {
            if(video.readyState >= 2 && !resolved) { // HAVE_CURRENT_DATA o superiore
              console.log("Video metadata caricati, dimensioni:", video.videoWidth, "x", video.videoHeight);
              video.play().then(() => {
                console.log("Video play() chiamato");
                // Su iOS a volte serve aspettare l'evento 'playing'
                video.addEventListener('playing', onPlaying, { once: true });
                // Fallback: controlla dopo un delay
                setTimeout(() => {
                  if(!resolved && video.videoWidth > 0 && video.videoHeight > 0) {
                    onPlaying();
                  }
                }, 500);
              }).catch((playErr) => {
                console.error("Errore play():", playErr);
                // Su iOS potrebbe essere necessario un interazione utente
                if(playErr.name === 'NotAllowedError') {
                  reject(new Error("Premi sul video per avviare la fotocamera"));
                } else {
                  reject(playErr);
                }
              });
            }
          };
          
          video.onloadedmetadata = checkReady;
          video.onplaying = onPlaying;
          video.onerror = (e) => {
            console.error("Errore video:", e);
            if(!resolved) {
              resolved = true;
              reject(new Error("Errore nel caricamento del video"));
            }
          };
          
          // Avvia il check
          if(video.readyState >= 2) {
            checkReady();
          } else {
            video.onloadedmetadata = checkReady;
          }
          
          // Timeout dopo 10 secondi
          setTimeout(() => {
            if(!resolved) {
              resolved = true;
              reject(new Error("Timeout caricamento video"));
            }
          }, 10000);
        });
        
        // Abilita il pulsante di cattura
        const captureBtn = document.getElementById('captureBtn');
        if(captureBtn) {
          captureBtn.disabled = false;
        }
        
        // Nascondi placeholder se visibile
        const placeholder = document.getElementById('videoPlaceholder');
        if(placeholder) {
          placeholder.style.display = 'none';
        }
        
      } catch (err) {
        console.error("Errore accesso camera:", err);
        
        // Mostra placeholder
        const placeholder = document.getElementById('videoPlaceholder');
        const video = document.getElementById('video');
        if(placeholder && video) {
          placeholder.style.display = 'block';
          video.style.display = 'none';
        }
        
        // Disabilita pulsante cattura
        const captureBtn = document.getElementById('captureBtn');
        if(captureBtn) {
          captureBtn.disabled = true;
        }
        
        let errorMsg = "Errore accesso camera.";
        if(err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
          errorMsg = "Permesso camera negato. Abilita l'accesso alla fotocamera nelle impostazioni del browser.";
        } else if(err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
          errorMsg = "Nessuna fotocamera trovata.";
        } else if(err.name === 'NotReadableError' || err.name === 'TrackStartError') {
          errorMsg = "La fotocamera √® gi√† in uso da un'altra app.";
        } else {
          errorMsg = "Errore accesso camera: " + err.message;
        }
        
        // Mostra messaggio nel placeholder
        if(placeholder) {
          const msgEl = placeholder.querySelector('p');
          if(msgEl) {
            msgEl.textContent = errorMsg;
          }
        }
      }
    }

    function captureSelfie() {
      try {
        // Verifica che il video sia pronto
        if(!video || !video.videoWidth || !video.videoHeight) {
          console.error("Video non pronto:", {
            video: !!video,
            width: video?.videoWidth,
            height: video?.videoHeight,
            readyState: video?.readyState
          });
          alert("La fotocamera non √® ancora pronta. Attendi un attimo e riprova.");
          return;
        }

        console.log("Cattura selfie, dimensioni video:", video.videoWidth, "x", video.videoHeight);
        
        // Aspect ratio fisso 3:4 (verticale) - stesso del contenitore video
        const targetAspectRatio = 3 / 4;
        const videoAspectRatio = video.videoWidth / video.videoHeight;
        
        let sourceX = 0;
        let sourceY = 0;
        let sourceWidth = video.videoWidth;
        let sourceHeight = video.videoHeight;
        
        // Calcola dimensioni canvas con aspect ratio 3:4
        let canvasWidth, canvasHeight;
        
        if(videoAspectRatio > targetAspectRatio) {
          // Video pi√π largo: crop ai lati, mantieni altezza
          canvasHeight = video.videoHeight;
          canvasWidth = Math.round(canvasHeight * targetAspectRatio);
          sourceX = Math.round((video.videoWidth - canvasWidth) / 2);
          sourceY = 0;
          sourceWidth = canvasWidth;  // Usa la larghezza del crop, non quella del video
          sourceHeight = canvasHeight; // Usa l'altezza del crop
        } else {
          // Video pi√π alto: crop sopra/sotto, mantieni larghezza
          canvasWidth = video.videoWidth;
          canvasHeight = Math.round(canvasWidth / targetAspectRatio);
          sourceX = 0;
          sourceY = Math.round((video.videoHeight - canvasHeight) / 2);
          sourceWidth = canvasWidth;  // Usa la larghezza del crop
          sourceHeight = canvasHeight; // Usa l'altezza del crop
        }
        
        // Imposta dimensioni canvas
        canvas.width = canvasWidth;
        canvas.height = canvasHeight;
        
        const ctx = canvas.getContext('2d');
        
        // Disegna il frame corrente del video sul canvas con crop centrato
        // Usa la stessa area che viene mostrata nel video (object-fit: cover)
        ctx.drawImage(
          video,
          sourceX, sourceY, sourceWidth, sourceHeight,  // Area sorgente (crop) - CORRETTO
          0, 0, canvasWidth, canvasHeight                // Area destinazione (canvas)
        );
        
        console.log("Canvas creato, dimensioni:", canvas.width, "x", canvas.height);
        console.log("Crop applicato:", { sourceX, sourceY, sourceWidth, sourceHeight });
        
        // Converti canvas in blob
        canvas.toBlob((blob) => {
          if(!blob) {
            console.error("Errore: blob non creato");
            alert("Errore nella cattura della foto. Riprova.");
            return;
          }
          
          console.log("Blob creato, dimensione:", blob.size, "bytes");
          capturedBlob = blob;
          const url = URL.createObjectURL(blob);
          confirmPreview.src = url;
          if(mainPersonAvatar) {
            mainPersonAvatar.src = url;
          }
          
          // Ferma lo stream
          if(stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
          }
          
          showScreen('confirm');
        }, 'image/jpeg', 0.9);
        
      } catch(err) {
        console.error("Errore nella cattura selfie:", err);
        alert("Errore nella cattura della foto: " + err.message);
      }
    }

    async function confirmSelfie() {
      // Se abbiamo email e selfie, registra/aggiorna utente
      if(userEmail && capturedBlob) {
        try {
          const fd = new FormData();
          fd.append("selfie", capturedBlob, "selfie.jpg");
          
          await fetch(`/register_user?email=${encodeURIComponent(userEmail)}`, {
            method: 'POST',
            body: fd
          });
          
          console.log("User registered/updated successfully");
        } catch(e) {
          console.error("Error registering user:", e);
          // Continua comunque con il matching
        }
      }
      
      // Dopo la conferma del selfie, cerca direttamente le foto
      matchPhotos();
    }

    // Funzioni matching
    async function matchPhotos() {
      if(!capturedBlob) {
        console.error("capturedBlob √® null!");
        alert("Errore: selfie non trovato. Per favore scatta di nuovo.");
        showScreen('selfie');
        startCamera();
        return;
      }
      
      // Mostra area upload status (torna allo schermo selfie se siamo in confirm)
      showScreen('selfie');
      const uploadStatus = document.getElementById('uploadStatus');
      const uploadStatusText = document.getElementById('uploadStatusText');
      const uploadProgressBar = document.getElementById('uploadProgressBar');
      const uploadPercentage = document.getElementById('uploadPercentage');
      const captureBtn = document.getElementById('captureBtn');
      
      // Mostra upload status e disabilita pulsante
      if(uploadStatus) uploadStatus.classList.add('active');
      if(uploadStatusText) uploadStatusText.textContent = t('upload.loading');
      if(uploadProgressBar) uploadProgressBar.style.width = '10%';
      if(uploadPercentage) uploadPercentage.textContent = '10%';
      if(captureBtn) {
        captureBtn.disabled = true;
        captureBtn.style.opacity = '0.5';
      }
      
      try {
        console.log("Inizio matchPhotos: invio selfie al server...");
        
        // Aggiorna progress
        if(uploadProgressBar) uploadProgressBar.style.width = '30%';
        if(uploadPercentage) uploadPercentage.textContent = '30%';
        if(uploadStatusText) uploadStatusText.textContent = t('upload.sending');
        
        const fd = new FormData();
        fd.append("selfie", capturedBlob, "selfie.jpg");
        
        // Simula progress durante upload (XMLHttpRequest per avere progress reale)
        const xhr = new XMLHttpRequest();
        
        // Promise per gestire la risposta
        const uploadPromise = new Promise((resolve, reject) => {
          xhr.upload.addEventListener('progress', (e) => {
            if(e.lengthComputable) {
              const percent = Math.round((e.loaded / e.total) * 50) + 30; // 30-80%
              if(uploadProgressBar) uploadProgressBar.style.width = percent + '%';
              if(uploadPercentage) uploadPercentage.textContent = percent + '%';
            }
          });
          
          xhr.addEventListener('load', () => {
            if(xhr.status >= 200 && xhr.status < 300) {
              resolve(xhr);
            } else {
              // Crea un errore con pi√π informazioni
              const error = new Error(`HTTP ${xhr.status}: ${xhr.statusText}`);
              error.status = xhr.status;
              error.statusText = xhr.statusText;
              error.responseText = xhr.responseText;
              reject(error);
            }
          });
          
          xhr.addEventListener('error', (e) => {
            console.error("XMLHttpRequest error event:", e);
            const error = new Error('Network error');
            error.type = 'network';
            reject(error);
          });
          
          xhr.addEventListener('timeout', () => {
            console.error("XMLHttpRequest timeout");
            const error = new Error('Request timeout');
            error.type = 'timeout';
            reject(error);
          });
          
          xhr.addEventListener('abort', () => {
            const error = new Error('Upload aborted');
            error.type = 'abort';
            reject(error);
          });
          
          // Imposta timeout di 120 secondi (Render pu√≤ essere lento al risveglio)
          xhr.timeout = 120000;
          
          // Aggiungi email se disponibile
          let url = '/match_selfie?top_k_faces=120&min_score=0.25';
          if(userEmail) {
            url += `&email=${encodeURIComponent(userEmail)}`;
          }
          
          xhr.open('POST', url);
          xhr.send(fd);
        });
        
        // Aggiorna progress
        if(uploadProgressBar) uploadProgressBar.style.width = '80%';
        if(uploadPercentage) uploadPercentage.textContent = '80%';
        if(uploadStatusText) uploadStatusText.textContent = t('upload.analyzing');
        
        await uploadPromise;
        
        const res = xhr;
        console.log("‚úÖ Risposta ricevuta, status:", res.status, "OK:", res.status >= 200 && res.status < 300);
        console.log("Response text length:", res.responseText ? res.responseText.length : 0);
        console.log("Response type:", res.responseType);
        console.log("Response headers:", res.getAllResponseHeaders());
        
        // Log primi caratteri della risposta per debug
        if(res.responseText && res.responseText.length > 0) {
          console.log("Response preview (primi 200 char):", res.responseText.substring(0, 200));
        }
        
        // Controlla se la risposta √® OK
        if(res.status < 200 || res.status >= 300) {
          console.error("‚ùå Errore HTTP:", res.status, res.statusText);
          console.error("Response text completo:", res.responseText);
          
          let errorMsg = "Errore durante l'elaborazione. Riprova tra qualche istante.";
          
          // Traduci messaggio in base alla lingua
          if(currentLang === 'en') {
            errorMsg = "Error during processing. Please try again in a moment.";
          } else if(currentLang === 'fr') {
            errorMsg = "Erreur lors du traitement. Veuillez r√©essayer dans un instant.";
          } else if(currentLang === 'de') {
            errorMsg = "Fehler bei der Verarbeitung. Bitte versuchen Sie es in einem Moment erneut.";
          } else if(currentLang === 'es') {
            errorMsg = "Error durante el procesamiento. Por favor, int√©ntelo de nuevo en un momento.";
          }
          
          try {
            if(res.responseText && res.responseText.trim()) {
              const errorData = JSON.parse(res.responseText);
              console.error("Errore dal server (JSON):", errorData);
              
              // Se il server fornisce un messaggio specifico, usalo
              if(errorData.detail) {
                errorMsg = errorData.detail;
              } else if(errorData.error && errorData.error.message) {
                errorMsg = errorData.error.message;
              } else if(errorData.message) {
                errorMsg = errorData.message;
              }
            }
          } catch(e) {
            console.error("Errore nel parsing JSON di errore:", e);
            console.error("Response text non-JSON:", res.responseText);
            
            // Messaggi specifici per diversi status code
            if(res.status === 500) {
              errorMsg = "Errore del server. Riprova tra qualche istante.";
              if(currentLang === 'en') errorMsg = "Server error. Please try again in a moment.";
              else if(currentLang === 'fr') errorMsg = "Erreur serveur. Veuillez r√©essayer dans un instant.";
              else if(currentLang === 'de') errorMsg = "Serverfehler. Bitte versuchen Sie es in einem Moment erneut.";
              else if(currentLang === 'es') errorMsg = "Error del servidor. Por favor, int√©ntelo de nuevo en un momento.";
            } else if(res.status === 503) {
              errorMsg = "Servizio temporaneamente non disponibile. Riprova tra qualche istante.";
              if(currentLang === 'en') errorMsg = "Service temporarily unavailable. Please try again in a moment.";
              else if(currentLang === 'fr') errorMsg = "Service temporairement indisponible. Veuillez r√©essayer dans un instant.";
              else if(currentLang === 'de') errorMsg = "Dienst vor√ºbergehend nicht verf√ºgbar. Bitte versuchen Sie es in einem Moment erneut.";
              else if(currentLang === 'es') errorMsg = "Servicio temporalmente no disponible. Por favor, int√©ntelo de nuevo en un momento.";
            } else if(res.status === 0 || res.statusText === '') {
              // Status 0 o vuoto spesso indica un problema di rete
              errorMsg = t('errors.connection');
            } else {
              errorMsg = `Errore ${res.status}: ${res.statusText || 'Errore sconosciuto'}`;
            }
          }
          console.error("üí• Errore finale mostrato all'utente:", errorMsg);
          
          // Aggiungi dettagli tecnici al messaggio per debug
          const debugInfo = `\n\n[Dettagli tecnici: Status ${res.status}, ${res.statusText || 'N/A'}]`;
          const fullErrorMsg = errorMsg + debugInfo;
          
          // Nascondi upload status
          if(uploadStatus) uploadStatus.classList.remove('active');
          if(captureBtn) {
            captureBtn.disabled = false;
            captureBtn.style.opacity = '1';
          }
          
          alert(fullErrorMsg);
          showScreen('selfie');
          startCamera();
          return;
        }
        
        // Aggiorna progress finale
        if(uploadProgressBar) uploadProgressBar.style.width = '100%';
        if(uploadPercentage) uploadPercentage.textContent = '100%';
        if(uploadStatusText) uploadStatusText.textContent = 'Completato!';
        
        // Verifica che la risposta non sia vuota
        if(!res.responseText || res.responseText.trim() === '') {
          console.error("Risposta vuota dal server");
          throw new Error('Empty response from server');
        }
        
        let data;
        try {
          data = JSON.parse(res.responseText);
          console.log("Dati ricevuti:", { 
            ok: data.ok, 
            count: data.count, 
            resultsLength: data.results ? data.results.length : 0,
            matchesLength: data.matches ? data.matches.length : 0
          });
        } catch(parseError) {
          console.error("Errore parsing JSON:", parseError);
          console.error("Response text (primi 500 caratteri):", res.responseText.substring(0, 500));
          throw new Error(`Invalid JSON response: ${parseError.message}`);
        }
        
        // Usa results o matches (per compatibilit√†)
        const photos = data.results || data.matches || [];
        
        if(data.ok && photos.length > 0) {
          console.log(`Trovate ${photos.length} foto`);
          if(uploadStatusText) uploadStatusText.textContent = t('upload.found', { count: photos.length });
          
          allPhotos = photos;
          photosLoadedCount = 0; // Reset counter
          
          // NON aggiungere automaticamente al carrello - l'utente decide cosa aggiungere
          
          console.log("Mostro album...");
          
          // Nascondi upload status prima di cambiare schermo
          setTimeout(() => {
            if(uploadStatus) uploadStatus.classList.remove('active');
            if(captureBtn) {
              captureBtn.disabled = false;
              captureBtn.style.opacity = '1';
            }
          }, 500);
          
          // Cambia schermo PRIMA di caricare le foto (cos√¨ l'utente vede subito la griglia)
          showScreen('album');
          
          // Aggiorna carrello
          updateCart();
          
          // Carica le foto (con lazy loading)
          displayPhotos();
          
          // Mostra banner dopo che lo schermo √® visibile
          setTimeout(() => {
            showStickyOfferBar(photos.length);
          }, 100);
        } else {
          console.warn("Nessuna foto trovata o risposta non valida:", data);
          // Nascondi upload status
          if(uploadStatus) uploadStatus.classList.remove('active');
          if(captureBtn) {
            captureBtn.disabled = false;
            captureBtn.style.opacity = '1';
          }
          
          // NON tornare alla welcome se siamo gi√† nell'album
          // Solo se siamo ancora nella schermata selfie/confirm
          if(currentScreen !== 'album') {
            alert(t('errors.noPhotos'));
            showScreen('selfie');
            startCamera();
          } else {
            // Se siamo gi√† nell'album, mostra solo un messaggio
            alert(t('errors.noPhotos'));
          }
        }
      } catch(err) {
        console.error("Errore nel caricamento foto:", err);
        console.error("Stack trace:", err.stack);
        console.error("Tipo errore:", err.name, "Messaggio:", err.message);
        console.error("Error type:", err.type, "Status:", err.status);
        
        // Nascondi upload status
        if(uploadStatus) uploadStatus.classList.remove('active');
        if(captureBtn) {
          captureBtn.disabled = false;
          captureBtn.style.opacity = '1';
        }
        
        // Determina il tipo di errore e mostra messaggio appropriato
        let errorMessage = t('errors.connection'); // Default
        
        // Controlla il tipo di errore specifico
        if(err.type === 'network') {
          // Errore di rete reale (XMLHttpRequest error event)
          errorMessage = t('errors.connection');
        } else if(err.type === 'timeout') {
          // Timeout della richiesta
          errorMessage = "La richiesta ha impiegato troppo tempo. Riprova.";
          if(currentLang === 'en') errorMessage = "Request took too long. Please try again.";
          else if(currentLang === 'fr') errorMessage = "La requ√™te a pris trop de temps. Veuillez r√©essayer.";
          else if(currentLang === 'de') errorMessage = "Die Anfrage hat zu lange gedauert. Bitte versuchen Sie es erneut.";
          else if(currentLang === 'es') errorMessage = "La solicitud tard√≥ demasiado. Por favor, int√©ntelo de nuevo.";
        } else if(err.type === 'abort') {
          // Upload annullato
          errorMessage = "Upload annullato. Riprova.";
          if(currentLang === 'en') errorMessage = "Upload cancelled. Please try again.";
          else if(currentLang === 'fr') errorMessage = "T√©l√©chargement annul√©. Veuillez r√©essayer.";
          else if(currentLang === 'de') errorMessage = "Upload abgebrochen. Bitte versuchen Sie es erneut.";
          else if(currentLang === 'es') errorMessage = "Carga cancelada. Por favor, int√©ntelo de nuevo.";
        } else if(err.status) {
          // Errore HTTP con status code
          if(err.status === 500) {
            errorMessage = "Errore del server. Riprova tra qualche istante.";
            if(currentLang === 'en') errorMessage = "Server error. Please try again in a moment.";
            else if(currentLang === 'fr') errorMessage = "Erreur serveur. Veuillez r√©essayer dans un instant.";
            else if(currentLang === 'de') errorMessage = "Serverfehler. Bitte versuchen Sie es in einem Moment erneut.";
            else if(currentLang === 'es') errorMessage = "Error del servidor. Por favor, int√©ntelo de nuevo en un momento.";
          } else if(err.status === 503) {
            errorMessage = "Servizio temporaneamente non disponibile. Riprova tra qualche istante.";
            if(currentLang === 'en') errorMessage = "Service temporarily unavailable. Please try again in a moment.";
            else if(currentLang === 'fr') errorMessage = "Service temporairement indisponible. Veuillez r√©essayer dans un instant.";
            else if(currentLang === 'de') errorMessage = "Dienst vor√ºbergehend nicht verf√ºgbar. Bitte versuchen Sie es in einem Moment erneut.";
            else if(currentLang === 'es') errorMessage = "Servicio temporalmente no disponible. Por favor, int√©ntelo de nuevo en un momento.";
          } else {
            errorMessage = `Errore ${err.status}: ${err.statusText || 'Errore del server'}`;
          }
        } else if(err.name === 'TypeError' && (err.message.includes('fetch') || err.message.includes('network') || err.message.includes('Failed to fetch'))) {
          // Errore di rete (fetch API)
          errorMessage = t('errors.connection');
        } else if(err.message && err.message.includes('Network error')) {
          // Errore di rete esplicito
          errorMessage = t('errors.connection');
        } else {
          // Altro tipo di errore (parsing, ecc.)
          errorMessage = "Errore durante l'elaborazione. Riprova tra qualche istante.";
          if(currentLang === 'en') {
            errorMessage = "Error during processing. Please try again in a moment.";
          } else if(currentLang === 'fr') {
            errorMessage = "Erreur lors du traitement. Veuillez r√©essayer dans un instant.";
          } else if(currentLang === 'de') {
            errorMessage = "Fehler bei der Verarbeitung. Bitte versuchen Sie es in einem Moment erneut.";
          } else if(currentLang === 'es') {
            errorMessage = "Error durante el procesamiento. Por favor, int√©ntelo de nuevo en un momento.";
          }
        }
        
        // In caso di errore, torna sempre alla schermata selfie per riprovare
        // NON mostrare l'album vuoto
        alert(errorMessage);
        showScreen('selfie');
        startCamera();
        
        // Reset delle variabili per evitare stati inconsistenti
        allPhotos = [];
        photosLoadedCount = 0;
      }
    }

    // Intersection Observer per lazy loading
    let imageObserver = null;
    
    function initImageObserver() {
      if(imageObserver) {
        imageObserver.disconnect();
      }
      
      imageObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if(entry.isIntersecting) {
            const img = entry.target;
            const photoId = img.dataset.photoId;
            const index = parseInt(img.dataset.index);
            
            // Carica l'immagine solo quando entra nel viewport
            if(!img.dataset.loaded) {
              img.dataset.loaded = 'true';
              const imgElement = new Image();
              
              imgElement.onload = () => {
                img.src = imgElement.src;
                img.classList.add('loaded');
                // Rimuovi skeleton
                const skeleton = img.parentElement.querySelector('.photo-skeleton');
                if(skeleton) skeleton.remove();
              };
              
              imgElement.onerror = () => {
                console.error('Errore caricamento foto:', photoId);
                img.style.display = 'none';
                const skeleton = img.parentElement.querySelector('.photo-skeleton');
                if(skeleton) {
                  skeleton.style.background = 'rgba(255,0,0,0.1)';
                  skeleton.innerHTML = '<div style="padding: 10px; text-align: center; color: #ff4444; font-size: 12px;">Error</div>';
                }
              };
              
              // Usa paid=true se la foto √® pagata
              const isPaid = paidPhotos.includes(photoId);
              imgElement.src = `/photo/${encodeURIComponent(photoId)}?paid=${isPaid}`;
            }
            
            imageObserver.unobserve(img);
          }
        });
      }, {
        rootMargin: '50px' // Inizia a caricare 50px prima che entri nel viewport
      });
    }
    
    function checkAllPhotosLoaded() {
      photosLoadedCount++;
      // Quando tutte le prime immagini sono caricate, nascondi overlay
      const preloadCount = Math.min(9, allPhotos.length);
      if(photosLoadedCount >= preloadCount) {
        const loadingOverlay = document.getElementById('albumLoadingOverlay');
        if(loadingOverlay) {
          loadingOverlay.classList.remove('active');
        }
        enableAlbumInteractions();
      }
    }
    
    function disableAlbumInteractions() {
      // Disabilita SOLO i pulsanti, NON lo scroll
      // NON bloccare pointer-events sull'albumScreen per permettere lo scroll
      
      // Disabilita pulsanti specifici
      const albumCartBtn = document.getElementById('albumCartBtn');
      const albumBackBtn = document.getElementById('albumBackBtn');
      const myContentTab = document.getElementById('myContentTab');
      const pricesTab = document.getElementById('pricesTab');
      if(albumCartBtn) {
        albumCartBtn.style.pointerEvents = 'none';
        albumCartBtn.style.opacity = '0.5';
      }
      if(albumBackBtn) {
        albumBackBtn.style.pointerEvents = 'none';
        albumBackBtn.style.opacity = '0.5';
      }
      if(myContentTab) {
        myContentTab.style.pointerEvents = 'none';
        myContentTab.style.opacity = '0.5';
      }
      if(pricesTab) {
        pricesTab.style.pointerEvents = 'none';
        pricesTab.style.opacity = '0.5';
      }
      
      // Disabilita click sulle foto durante il caricamento
      const photos = albumGrid.querySelectorAll('.album-photo');
      photos.forEach(photo => {
        photo.style.pointerEvents = 'none';
      });
    }
    
    function enableAlbumInteractions() {
      // Riabilita pulsanti
      const albumCartBtn = document.getElementById('albumCartBtn');
      const albumBackBtn = document.getElementById('albumBackBtn');
      const myContentTab = document.getElementById('myContentTab');
      const pricesTab = document.getElementById('pricesTab');
      if(albumCartBtn) {
        albumCartBtn.style.pointerEvents = 'auto';
        albumCartBtn.style.opacity = '1';
      }
      if(albumBackBtn) {
        albumBackBtn.style.pointerEvents = 'auto';
        albumBackBtn.style.opacity = '1';
      }
      if(myContentTab) {
        myContentTab.style.pointerEvents = 'auto';
        myContentTab.style.opacity = '1';
      }
      if(pricesTab) {
        pricesTab.style.pointerEvents = 'auto';
        pricesTab.style.opacity = '1';
      }
      
      // Riabilita click sulle foto
      const photos = albumGrid.querySelectorAll('.album-photo');
      photos.forEach(photo => {
        photo.style.pointerEvents = 'auto';
      });
    }
    
    function displayPhotos() {
      // Verifica che ci siano foto da mostrare
      if(!allPhotos || allPhotos.length === 0) {
        console.warn("displayPhotos chiamato ma non ci sono foto!");
        // Torna al selfie se non ci sono foto
        alert(t('errors.noPhotos'));
        showScreen('selfie');
        startCamera();
        return;
      }
      
      const loadingOverlay = document.getElementById('albumLoadingOverlay');
      const loadingText = document.getElementById('albumLoadingText');
      
      // Reset counter
      photosLoadedCount = 0;
      
      // Mostra overlay di caricamento
      if(loadingOverlay) {
        loadingOverlay.classList.add('active');
        if(loadingText) loadingText.textContent = t('upload.loading');
      }
      
      // Disabilita interazioni
      disableAlbumInteractions();
      
      albumGrid.innerHTML = '';
      
      // Preload delle prime 6-9 immagini (quelle visibili subito)
      const preloadCount = Math.min(9, allPhotos.length);
      
      allPhotos.forEach((photo, index) => {
        const div = document.createElement('div');
        div.className = 'album-photo';
        
        const img = document.createElement('img');
        img.dataset.photoId = photo.photo_id;
        img.dataset.index = index;
        img.alt = photo.photo_id;
        
        // Skeleton loader
        const skeleton = document.createElement('div');
        skeleton.className = 'photo-skeleton';
        
        // Per le prime immagini, carica subito
        if(index < preloadCount) {
          img.dataset.loaded = 'true';
          const imgElement = new Image();
          imgElement.onload = () => {
            img.src = imgElement.src;
            img.classList.add('loaded');
            skeleton.remove();
            checkAllPhotosLoaded();
          };
          imgElement.onerror = () => {
            console.error('Errore caricamento foto:', photo.photo_id);
            skeleton.style.background = 'rgba(255,0,0,0.1)';
            skeleton.innerHTML = '<div style="padding: 10px; text-align: center; color: #ff4444; font-size: 12px;">Error</div>';
            checkAllPhotosLoaded();
          };
          // Usa paid=true se la foto √® pagata
          const isPaid = paidPhotos.includes(photo.photo_id);
          imgElement.src = `/photo/${encodeURIComponent(photo.photo_id)}?paid=${isPaid}`;
        }
        
        const addCartBtn = document.createElement('button');
        addCartBtn.className = 'add-cart';
        addCartBtn.dataset.photoId = photo.photo_id;
        
        // Se la foto √® pagata, non mostrare il pulsante carrello
        const isPaid = paidPhotos.includes(photo.photo_id);
        if(isPaid) {
          addCartBtn.style.display = 'none';
          // Aggiungi badge "Pagata"
          const paidBadge = document.createElement('div');
          paidBadge.className = 'photo-paid-badge';
          paidBadge.textContent = '‚úì Pagata';
          paidBadge.style.cssText = 'position: absolute; top: 8px; right: 8px; background: rgba(34, 197, 94, 0.9); color: white; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; z-index: 5;';
          div.appendChild(paidBadge);
        } else {
          // Verifica se la foto √® gi√† nel carrello
          if(currentCart.photo_ids && currentCart.photo_ids.includes(photo.photo_id)) {
            addCartBtn.classList.add('in-cart');
          }
          addCartBtn.onclick = () => toggleCart(photo.photo_id, addCartBtn);
        }
        
        div.appendChild(skeleton);
        div.appendChild(img);
        div.appendChild(addCartBtn);
        
        img.addEventListener('click', () => openLightbox(index));
        albumGrid.appendChild(div);
      });
      
      // Inizializza observer dopo che tutti gli elementi sono nel DOM
      setTimeout(() => {
        initImageObserver();
        // Osserva tutte le immagini non ancora caricate
        albumGrid.querySelectorAll('img:not([data-loaded="true"])').forEach(img => {
          imageObserver.observe(img);
        });
      }, 100);
      
      // Nascondi overlay dopo un breve delay (le prime immagini si caricheranno velocemente)
      setTimeout(() => {
        if(loadingOverlay) {
          loadingOverlay.classList.remove('active');
        }
        enableAlbumInteractions();
      }, 500);
    }

    function showStickyOfferBar(photoCount) {
      const stickyBar = document.getElementById('stickyOfferBar');
      const stickyText = document.getElementById('stickyOfferText');
      const stickyPrice = document.getElementById('stickyOfferPrice');
      const stickyBuyBtn = document.getElementById('stickyOfferBuyBtn');
      const photoCountBanner = document.getElementById('albumPhotoCount');
      const photoCountNumber = document.getElementById('photoCountNumber');
      const albumScreen = document.getElementById('albumScreen');
      
      if(!stickyBar) {
        console.warn("Sticky offer bar non trovato");
        return;
      }
      
      // Verifica che lo schermo album sia attivo
      if(!albumScreen || !albumScreen.classList.contains('active')) {
        console.warn("Schermo album non attivo, aspetto...");
        setTimeout(() => showStickyOfferBar(photoCount), 200);
        return;
      }
      
      // Mostra banner conteggio foto sopra la griglia
      if(photoCountBanner && photoCountNumber) {
        photoCountNumber.textContent = photoCount;
        const foundText = t('album.found', { count: photoCount });
        photoCountBanner.innerHTML = foundText.replace('{count}', photoCount);
        photoCountBanner.style.display = 'block';
      }
      
      // Calcola prezzo
      const priceCents = calculatePrice(photoCount);
      const priceEuros = (priceCents / 100).toFixed(2);
      
      // Messaggio personalizzato in base al numero di foto (tradotto)
      let message = "";
      if(photoCount === 1) {
        message = t('sticky.buy1');
      } else if(photoCount <= 5) {
        message = t('sticky.buyFew', { count: photoCount });
      } else if(photoCount <= 11) {
        message = t('sticky.buyMany', { count: photoCount });
      } else {
        message = t('sticky.buyAll', { count: photoCount });
      }
      
      if(stickyText) {
        stickyText.textContent = message;
      }
      
      if(stickyPrice) {
        stickyPrice.textContent = `‚Ç¨${priceEuros}`;
      }
      
      if(stickyBuyBtn) {
        stickyBuyBtn.textContent = t('sticky.buy');
      }
      
      // Event listener per pulsante acquista (se non gi√† presente)
      if(stickyBuyBtn && !stickyBuyBtn.dataset.listenerAdded) {
        stickyBuyBtn.addEventListener('click', () => {
          checkoutAllPhotos(); // Usa funzione separata per acquistare TUTTE le foto
        });
        stickyBuyBtn.dataset.listenerAdded = 'true';
      }
      
      // Pulsante chiudi rimosso - il banner rimane sempre visibile
      
      // Mostra banner con animazione
      stickyBar.style.display = 'flex';
      stickyBar.classList.add('active');
      
      // Mostra countdown banner se ci sono foto pagate
      showPaidCountdownBanner();
    }
    
    function showPaidCountdownBanner() {
      const countdownBanner = document.getElementById('paidCountdownBanner');
      const countdownText = document.getElementById('paidCountdownText');
      const countdownDays = document.getElementById('paidCountdownDays');
      
      if(!countdownBanner || paidPhotos.length === 0) {
        return;
      }
      
      // Calcola giorni rimanenti (30 giorni dalla data di pagamento)
      // Per ora usiamo una stima: assumiamo che le foto siano state pagate oggi
      // In futuro potremmo recuperare la data di scadenza dal server
      const daysRemaining = 30; // Default, in futuro recuperare da server
      
      if(daysRemaining > 0) {
        // Traduci il messaggio
        let message = "";
        if(currentLang === 'en') {
          message = `Your paid photos will expire in <strong>${daysRemaining}</strong> days`;
        } else if(currentLang === 'it') {
          message = `Le tue foto pagate scadranno tra <strong>${daysRemaining}</strong> giorni`;
        } else if(currentLang === 'fr') {
          message = `Vos photos pay√©es expireront dans <strong>${daysRemaining}</strong> jours`;
        } else if(currentLang === 'de') {
          message = `Ihre bezahlten Fotos laufen in <strong>${daysRemaining}</strong> Tagen ab`;
        } else if(currentLang === 'es') {
          message = `Tus fotos pagadas expirar√°n en <strong>${daysRemaining}</strong> d√≠as`;
        } else {
          message = `Le tue foto pagate scadranno tra <strong>${daysRemaining}</strong> giorni`;
        }
        
        if(countdownText) {
          countdownText.innerHTML = message;
        }
        if(countdownDays) {
          countdownDays.textContent = daysRemaining;
        }
        
        // Mostra banner con animazione
        setTimeout(() => {
          countdownBanner.classList.add('show');
        }, 500);
      }
    }

    function openLightbox(index) {
      // Previeni l'apertura se le foto stanno ancora caricando
      const loadingOverlay = document.getElementById('albumLoadingOverlay');
      if(loadingOverlay && loadingOverlay.classList.contains('active')) {
        return; // Non fare nulla se sta caricando
      }
      
      currentPhotoIndex = index;
      const photo = allPhotos[index];
      
      // Preload dell'immagine prima di mostrarla
      const img = new Image();
      img.onload = () => {
        lightboxImage.src = img.src;
        updateLightboxCounter();
        photoLightbox.classList.add('active');
      };
      img.onerror = () => {
        alert(t('errors.connection'));
      };
      
      // Usa paid=true se la foto √® pagata
      const isPaid = paidPhotos.includes(photo.photo_id);
      img.src = `/photo/${encodeURIComponent(photo.photo_id)}?paid=${isPaid}`;
      
      // Mostra/nascondi frecce
      const prevBtn = document.getElementById('lightboxPrev');
      const nextBtn = document.getElementById('lightboxNext');
      const downloadBtn = document.getElementById('lightboxDownload');
      prevBtn.style.display = allPhotos.length > 1 ? 'flex' : 'none';
      nextBtn.style.display = allPhotos.length > 1 ? 'flex' : 'none';
      
      // Mostra pulsante download solo se foto √® pagata
      if(isPaid) {
        downloadBtn.style.display = 'block';
        downloadBtn.onclick = () => downloadPhoto(photo.photo_id);
      } else {
        downloadBtn.style.display = 'none';
      }
    }
    
    function updateLightboxCounter() {
      photoCounter.textContent = `${currentPhotoIndex + 1}/${allPhotos.length}`;
    }
    
    function nextPhoto() {
      if(currentPhotoIndex < allPhotos.length - 1) {
        currentPhotoIndex++;
        const photo = allPhotos[currentPhotoIndex];
        const isPaid = paidPhotos.includes(photo.photo_id);
        lightboxImage.src = `/photo/${encodeURIComponent(photo.photo_id)}?paid=${isPaid}`;
        updateLightboxCounter();
        updateDownloadButton(photo.photo_id);
      }
    }
    
    function prevPhoto() {
      if(currentPhotoIndex > 0) {
        currentPhotoIndex--;
        const photo = allPhotos[currentPhotoIndex];
        const isPaid = paidPhotos.includes(photo.photo_id);
        lightboxImage.src = `/photo/${encodeURIComponent(photo.photo_id)}?paid=${isPaid}`;
        updateLightboxCounter();
        updateDownloadButton(photo.photo_id);
      }
    }
    
    function updateDownloadButton(photoId) {
      const downloadBtn = document.getElementById('lightboxDownload');
      if(paidPhotos.includes(photoId)) {
        downloadBtn.style.display = 'block';
        downloadBtn.onclick = () => downloadPhoto(photoId);
      } else {
        downloadBtn.style.display = 'none';
      }
    }
    
    async function downloadPhoto(photoId) {
      try {
        // Passa email se disponibile per verifica pagamento
        const emailParam = userEmail ? `&email=${encodeURIComponent(userEmail)}` : '';
        const photoUrl = `/photo/${encodeURIComponent(photoId)}?paid=true${emailParam}`;
        
        // Rileva se siamo su mobile
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        
        if(isMobile && navigator.share) {
          // Web Share API per mobile
          try {
            const response = await fetch(photoUrl);
            const blob = await response.blob();
            const file = new File([blob], `${photoId}.jpg`, { type: 'image/jpeg' });
            
            if(navigator.canShare && navigator.canShare({ files: [file] })) {
              await navigator.share({
                files: [file],
                title: 'Tenerife Stars Pictures',
                text: 'La mia foto da Tenerife Stars Pictures'
              });
              return;
            }
          } catch(e) {
            console.log("Web Share API non disponibile, uso download diretto");
          }
        }
        
        // Download diretto per desktop o fallback mobile
        const link = document.createElement('a');
        link.href = photoUrl;
        link.download = `${photoId}.jpg`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } catch(e) {
        console.error("Error downloading photo:", e);
        alert(t('errors.download') || "Error downloading photo");
      }
    }

    async function toggleCart(photoId, buttonElement) {
      try {
        // Verifica se la foto √® gi√† nel carrello
        const isInCart = currentCart.photo_ids && currentCart.photo_ids.includes(photoId);
        
        let res;
        if(isInCart) {
          // Rimuovi dal carrello
          res = await fetch(`/cart/remove?session_id=${encodeURIComponent(sessionId)}&photo_id=${encodeURIComponent(photoId)}`, {
            method: "DELETE"
          });
        } else {
          // Aggiungi al carrello
          res = await fetch(`/cart/add?session_id=${encodeURIComponent(sessionId)}&photo_id=${encodeURIComponent(photoId)}`, {
            method: "POST"
          });
        }
        
        const data = await res.json();
        if(data.ok) {
          currentCart = data;
          updateCart();
          updateCartModal();
          
          // Aggiorna lo stato visivo del pulsante
          if(buttonElement) {
            if(isInCart) {
              buttonElement.classList.remove('in-cart');
            } else {
              buttonElement.classList.add('in-cart');
            }
          } else {
            // Se non abbiamo il riferimento diretto, cerca il pulsante
            const btn = document.querySelector(`.add-cart[data-photo-id="${photoId}"]`);
            if(btn) {
              if(isInCart) {
                btn.classList.remove('in-cart');
              } else {
                btn.classList.add('in-cart');
              }
            }
          }
        }
      } catch(err) {
        console.error("Error toggling cart:", err);
      }
    }
    
    async function addToCart(photoId) {
      // Manteniamo questa funzione per compatibilit√†, ma usa toggleCart
      const btn = document.querySelector(`.add-cart[data-photo-id="${photoId}"]`);
      await toggleCart(photoId, btn);
    }

    function updateCart() {
      albumCartCount.textContent = currentCart.count || 0;
      albumCartPrice.textContent = `‚Ç¨${(currentCart.price_euros || 0).toFixed(2)}`;
      // buyAllPrice rimosso insieme al pulsante buyAllBtn
      if(buyAllPrice) {
        buyAllPrice.textContent = `‚Ç¨${(currentCart.price_euros || 0).toFixed(2)}`;
      }
    }
    
    function updateCartModal() {
      const cartItems = document.getElementById('cartItems');
      const cartTotal = document.getElementById('cartTotal');
      const checkoutBtn = document.getElementById('checkoutBtn');
      
      if(currentCart.photo_ids && currentCart.photo_ids.length > 0) {
        cartItems.innerHTML = '';
        currentCart.photo_ids.forEach(photoId => {
          const div = document.createElement('div');
          div.style.cssText = 'display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1);';
          div.innerHTML = `
            <div style="display: flex; align-items: center; gap: 12px;">
              <img src="/photo/${encodeURIComponent(photoId)}?paid=false" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;" />
              <span style="font-size: 14px; color: var(--text-light);">${photoId}</span>
            </div>
            <button onclick="removeFromCart('${photoId}')" style="background: #ff4444; color: #fff; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 14px;">Rimuovi</button>
          `;
          cartItems.appendChild(div);
        });
        cartTotal.textContent = `‚Ç¨${currentCart.price_euros.toFixed(2)}`;
        checkoutBtn.disabled = false;
      } else {
        cartItems.innerHTML = '<p style="text-align: center; color: var(--text-muted);">Il carrello √® vuoto</p>';
        cartTotal.textContent = "‚Ç¨0.00";
        checkoutBtn.disabled = true;
      }
    }
    
    async function removeFromCart(photoId) {
      try {
        const res = await fetch(`/cart/remove?session_id=${encodeURIComponent(sessionId)}&photo_id=${encodeURIComponent(photoId)}`, {
          method: "DELETE"
        });
        const data = await res.json();
        if(data.ok) {
          currentCart = data;
          updateCart();
          updateCartModal();
          
          // Aggiorna lo stato visivo del pulsante nella griglia
          const btn = document.querySelector(`.add-cart[data-photo-id="${photoId}"]`);
          if(btn) {
            btn.classList.remove('in-cart');
          }
        }
      } catch(err) {
        console.error("Error removing from cart:", err);
      }
    }

    function calculatePrice(count) {
      if(count === 1) return 2000;
      if(count === 2) return 4000;
      if(count === 3) return 3500;
      if(count === 4) return 4000;
      if(count === 5) return 4500;
      if(count >= 6 && count <= 11) return 5000;
      return 6000;
    }

    async function checkout() {
      // Checkout normale: usa il carrello corrente
      if(!currentCart.photo_ids || currentCart.photo_ids.length === 0) {
        alert(t('cart.empty'));
        return;
      }
      
      if(!userEmail) {
        alert(t('email.required') || "Email is required");
        showScreen('email');
        return;
      }
      
      const res = await fetch(`/checkout?session_id=${encodeURIComponent(sessionId)}&email=${encodeURIComponent(userEmail)}`, {
        method: "POST"
      });
      
      const data = await res.json();
      if(data.checkout_url) {
        window.location.href = data.checkout_url;
      }
    }
    
    async function checkoutAllPhotos() {
      // Checkout per TUTTE le foto: ignora il carrello e usa tutte le foto trovate
      if(!allPhotos || allPhotos.length === 0) {
        alert("Nessuna foto disponibile!");
        return;
      }
      
      // Crea un carrello temporaneo con TUTTE le foto
      const allPhotoIds = allPhotos.map(photo => photo.photo_id);
      const totalCount = allPhotoIds.length;
      const totalPriceCents = calculatePrice(totalCount);
      const totalPriceEuros = (totalPriceCents / 100).toFixed(2);
      
      // Aggiungi tutte le foto al carrello temporaneamente per il checkout
      // Usiamo una sessione separata o aggiungiamo direttamente tutte le foto
      try {
        // Prima, aggiungi tutte le foto al carrello (sovrascrive il carrello corrente)
        // Oppure crea una nuova sessione per questo checkout
        const checkoutSessionId = "checkout_all_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);
        
        // Aggiungi tutte le foto una per una al carrello di checkout
        for(const photoId of allPhotoIds) {
          await fetch(`/cart/add?session_id=${encodeURIComponent(checkoutSessionId)}&photo_id=${encodeURIComponent(photoId)}`, {
            method: "POST"
          });
        }
        
        // Verifica email
        if(!userEmail) {
          alert(t('email.required') || "Email is required");
          showScreen('email');
          return;
        }
        
        // Ora fai il checkout con questa sessione che contiene tutte le foto
        const res = await fetch(`/checkout?session_id=${encodeURIComponent(checkoutSessionId)}&email=${encodeURIComponent(userEmail)}`, {
          method: "POST"
        });
        
        const data = await res.json();
        if(data.checkout_url) {
          window.location.href = data.checkout_url;
        } else {
          alert("Errore durante il checkout. Riprova.");
        }
      } catch(err) {
        console.error("Errore checkout tutte le foto:", err);
        alert("Errore durante il checkout. Riprova.");
      }
    }

    // Lightbox controls
    document.getElementById('lightboxClose').addEventListener('click', () => {
      photoLightbox.classList.remove('active');
    });
    
    document.getElementById('lightboxPrev').addEventListener('click', prevPhoto);
    document.getElementById('lightboxNext').addEventListener('click', nextPhoto);
    
    // Navigazione con tastiera
    document.addEventListener('keydown', (e) => {
      if(photoLightbox.classList.contains('active')) {
        if(e.key === 'ArrowLeft') prevPhoto();
        if(e.key === 'ArrowRight') nextPhoto();
        if(e.key === 'Escape') photoLightbox.classList.remove('active');
      }
    });

    photoLightbox.addEventListener('click', (e) => {
      if(e.target === photoLightbox) {
        photoLightbox.classList.remove('active');
      }
    });
    
    // Blocca salvataggio foto
    lightboxImage.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      alert('‚ö†Ô∏è Acquista la foto per scaricarla!');
    });
    
    lightboxImage.addEventListener('dragstart', (e) => {
      e.preventDefault();
    });
    

    // Boot
    window.addEventListener('load', () => {
      if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert("Questo browser non supporta la camera.");
      }
    });
  </script>
</body>
</html>

