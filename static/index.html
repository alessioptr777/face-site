<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Tenerife Stars Pictures - Trova le tue foto</title>
  <style>
    :root{
      --bg-dark: #0a0e27;
      --bg-dark2: #1a1f3a;
      --bg-gradient: linear-gradient(180deg, #1a1f3a 0%, #0a0e27 100%);
      --text-light: #ffffff;
      --text-muted: #a0a8c0;
      --accent: #6366f1;
      --accent-light: #818cf8;
      --purple: #a855f7;
      --pink: #ec4899;
      --radius: 16px;
      --shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    *{box-sizing:border-box; margin:0; padding:0}
    html, body{
      margin:0;
      padding:0;
      height: 100%;
      overflow: hidden;
    }
    body{
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
      color:var(--text-light);
      height: 100dvh;
      height: 100vh; /* Fallback per browser che non supportano dvh */
      background: var(--bg-gradient);
      overflow: hidden;
      position: fixed;
      width: 100%;
    }
    
    /* Utility */
    .screen{
      height: 100dvh;
      height: 100vh; /* Fallback */
      display: none;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }
    .screen.active{
      display: flex;
    }
    
    /* Welcome Screen */
    .welcome-screen{
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      text-align: center;
    }
    
    .welcome-icon{
      width: 120px;
      height: 120px;
      margin-bottom: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .welcome-icon svg{
      width: 100%;
      height: 100%;
      stroke: var(--accent-light);
      fill: none;
      stroke-width: 2;
    }
    
    .welcome-title{
      font-size: 32px;
      font-weight: 700;
      color: var(--text-light);
      margin-bottom: 20px;
    }
    
    .welcome-text{
      font-size: 16px;
      color: var(--text-muted);
      line-height: 1.6;
      max-width: 400px;
      margin: 0 auto 40px;
    }
    
    .welcome-privacy{
      font-size: 14px;
      color: var(--text-muted);
      max-width: 400px;
      margin: 20px auto 0;
    }
    
    .btn-primary{
      background: linear-gradient(135deg, var(--accent) 0%, var(--purple) 100%);
      color: white;
      border: none;
      padding: 16px 48px;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .btn-primary:active{
      transform: scale(0.98);
    }
    
    /* Selfie Screen */
    .selfie-screen{
      padding: 10px;
      overflow: hidden;
    }
    
    .selfie-header{
      flex-shrink: 0;
      padding: 10px 0;
      text-align: center;
    }
    
    .selfie-header h2{
      font-size: 20px;
      font-weight: 600;
      color: var(--text-light);
      margin: 0;
    }
    
    .selfie-preview{
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      min-height: 0; /* Importante per flex */
      overflow: hidden;
    }
    
    .selfie-video{
      width: 100%;
      max-width: 100%;
      aspect-ratio: 3 / 4; /* Aspect ratio fisso 3:4 verticale */
      border-radius: 16px;
      overflow: hidden;
      background: #000;
      flex-shrink: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    
    .selfie-video video{
      width: 100%;
      height: 100%;
      object-fit: cover; /* Copre tutto il contenitore senza bande nere */
      display: block;
      object-position: center center; /* Centra verticalmente sul volto */
    }
    
    .selfie-controls{
      flex-shrink: 0;
      margin-top: 15px;
      margin-bottom: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }
    
    /* Upload Status Area - sempre visibile */
    .upload-status{
      flex-shrink: 0;
      padding: 12px 20px;
      background: rgba(0, 0, 0, 0.3);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: none;
      flex-direction: column;
      gap: 8px;
    }
    
    .upload-status.active{
      display: flex;
    }
    
    .upload-status-text{
      font-size: 14px;
      color: var(--text-light);
      text-align: center;
      font-weight: 500;
    }
    
    .upload-progress-container{
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      overflow: hidden;
    }
    
    .upload-progress-bar{
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--purple));
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 3px;
    }
    
    .upload-percentage{
      font-size: 12px;
      color: var(--text-muted);
      text-align: center;
    }
    
    .upload-spinner{
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }
    
    .camera-btn{
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: white;
      border: 4px solid var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    
    .camera-btn svg{
      width: 40px;
      height: 40px;
      stroke: var(--accent);
      stroke-width: 2;
    }
    
    /* Confirm Selfie Screen */
    .confirm-screen{
      padding: 10px 20px;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    
    .confirm-title{
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 30px;
      text-align: center;
    }
    
    .confirm-preview{
      width: 100%;
      max-width: 300px;
      aspect-ratio: 3 / 4; /* Stesso aspect ratio del selfie catturato */
      border-radius: 20px;
      overflow: hidden;
      margin-bottom: 15px;
      box-shadow: var(--shadow);
      flex-shrink: 1;
      background: #000;
    }
    
    .confirm-preview img{
      width: 100%;
      height: 100%;
      object-fit: cover; /* Stesso comportamento del video */
      object-position: center center;
      display: block;
    }
    
    .confirm-privacy{
      max-width: 400px;
      text-align: center;
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 30px;
      line-height: 1.6;
    }
    
    .confirm-privacy a{
      color: var(--accent-light);
      text-decoration: underline;
    }
    
    .confirm-buttons{
      display: flex;
      flex-direction: column;
      gap: 12px;
      width: 100%;
      max-width: 400px;
    }
    
    .btn-confirm{
      background: var(--accent);
      color: white;
      border: none;
      padding: 16px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }
    
    .btn-retake{
      background: transparent;
      color: var(--text-light);
      border: 2px solid var(--text-muted);
      padding: 16px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }
    
    /* Add People Screen */
    .add-people-screen{
      padding: 40px 20px;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    
    .add-people-title{
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 30px;
    }
    
    .people-list{
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-bottom: 40px;
      flex-wrap: wrap;
    }
    
    .person-avatar{
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--bg-dark2);
      border: 3px solid var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    
    .person-avatar img{
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .add-person-btn{
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--accent);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 32px;
      color: white;
    }
    
    .add-people-buttons{
      display: flex;
      flex-direction: column;
      gap: 12px;
      width: 100%;
      max-width: 400px;
    }
    
    /* Album Screen */
    .album-screen{
      padding: 0;
    }
    
    .album-header{
      background: var(--bg-dark2);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .album-back{
      background: none;
      border: none;
      color: var(--text-light);
      font-size: 24px;
      cursor: pointer;
      padding: 8px;
    }
    
    .album-cart{
      background: var(--accent);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    
    .album-profile{
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .profile-avatar{
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: var(--bg-dark2);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .profile-avatar img{
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .profile-info h3{
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .profile-info p{
      font-size: 14px;
      color: var(--text-muted);
    }
    
    .album-tabs{
      display: flex;
      padding: 0 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .album-tab{
      background: none;
      border: none;
      color: var(--text-muted);
      padding: 16px 20px;
      font-size: 16px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }
    
    .album-tab.active{
      color: var(--text-light);
      border-bottom-color: var(--accent);
    }
    
    .album-grid{
      padding: 20px;
      padding-bottom: 100px; /* Spazio per il banner sticky */
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
    }
    
    .album-photo{
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      aspect-ratio: 1;
      background: var(--bg-dark2);
    }
    
    .album-photo img{
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .album-photo .add-cart{
      position: absolute;
      bottom: 8px;
      right: 8px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(0,0,0,0.6);
      border: none;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
    }
    
    .album-buy-all{
      margin: 20px;
      background: linear-gradient(135deg, var(--purple) 0%, var(--pink) 100%);
      color: white;
      border: none;
      padding: 20px;
      border-radius: 16px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 20px rgba(168, 85, 247, 0.4);
    }
    
    .album-buy-all .price{
      font-size: 24px;
    }
    
    .album-buy-all .subtitle{
      font-size: 14px;
      opacity: 0.9;
      margin-top: 4px;
    }
    
    /* Modal styles */
    .ios-share-modal{
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1001;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    
    .ios-share-modal.active{
      opacity: 1;
      visibility: visible;
    }
    
    .ios-share-modal-content{
      background: var(--bg-dark2);
      padding: 30px;
      border-radius: 20px;
      text-align: center;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Sticky Offer Bar */
    .sticky-offer-bar{
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, var(--purple) 0%, var(--pink) 100%);
      padding: 12px 16px;
      padding-bottom: calc(12px + env(safe-area-inset-bottom)); /* Safe area iPhone */
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
      z-index: 999;
      display: none;
      transform: translateY(100%);
      transition: transform 0.3s ease-out;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .sticky-offer-bar.active{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      animation: slideUp 0.4s ease-out forwards;
    }
    
    @keyframes slideUp {
      from {
        transform: translateY(100%);
      }
      to {
        transform: translateY(0);
      }
    }
    
    .sticky-offer-content{
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .sticky-offer-text{
      font-size: 14px;
      font-weight: 600;
      color: white;
      line-height: 1.3;
    }
    
    .sticky-offer-price{
      font-size: 18px;
      font-weight: 700;
      color: white;
    }
    
    .sticky-offer-actions{
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .sticky-offer-btn{
      background: white;
      color: var(--purple);
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: transform 0.2s, opacity 0.2s;
    }
    
    .sticky-offer-btn:active{
      transform: scale(0.95);
      opacity: 0.8;
    }
    
    .sticky-offer-close{
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
      flex-shrink: 0;
      transition: background 0.2s;
    }
    
    .sticky-offer-close:active{
      background: rgba(255, 255, 255, 0.3);
    }
    
    /* Album photo count banner sopra la griglia */
    .album-photo-count{
      padding: 12px 20px;
      background: rgba(168, 85, 247, 0.1);
      border-bottom: 1px solid rgba(168, 85, 247, 0.2);
      text-align: center;
      font-size: 16px;
      font-weight: 600;
      color: var(--accent-light);
    }
  </style>
</head>
<body>
  <!-- Welcome Screen -->
  <div class="screen welcome-screen active" id="welcomeScreen">
    <div class="welcome-icon">
      <svg viewBox="0 0 100 100">
        <rect x="20" y="25" width="60" height="50" rx="8"/>
        <circle cx="50" cy="45" r="12"/>
        <rect x="35" y="60" width="30" height="8" rx="4"/>
        <circle cx="70" cy="35" r="4"/>
      </svg>
    </div>
    <h1 class="welcome-title">Trova le tue foto!</h1>
    <p class="welcome-text">
      Nel prossimo passaggio ti sar√† chiesto di abilitare la fotocamera, per permettere al nostro sistema di consegnare le tue foto dell'evento.
    </p>
    <button class="btn-primary" id="welcomeContinueBtn">Continua</button>
    <p class="welcome-privacy">
      Operiamo nel totale rispetto della Privacy ed utilizziamo il tuo viso esclusivamente per trovare le foto che ti ritraggono.
    </p>
  </div>

  <!-- Selfie Screen -->
  <div class="screen selfie-screen" id="selfieScreen">
    <div class="selfie-header">
      <h2>Scatta il tuo selfie</h2>
    </div>
    <div class="selfie-preview">
      <div class="selfie-video">
        <video id="video" autoplay playsinline muted webkit-playsinline></video>
        <canvas id="canvas" style="display:none;"></canvas>
        <div id="videoPlaceholder" style="display: none; text-align: center; padding: 20px; color: var(--text-muted);">
          <p style="font-size: 14px;">La fotocamera non √® disponibile</p>
          <button class="btn-primary" id="retryCameraBtn" style="margin-top: 15px; padding: 12px 24px; font-size: 14px;">Riprova</button>
        </div>
      </div>
      <div class="selfie-controls">
        <button class="camera-btn" id="captureBtn" disabled>
          <svg viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="10"/>
          </svg>
        </button>
        <button class="btn-retake" id="switchCameraBtn" style="display:none;">Cambia camera</button>
      </div>
    </div>
    <!-- Upload Status Area - sempre visibile quando attiva -->
    <div class="upload-status" id="uploadStatus">
      <div class="upload-status-text">
        <span class="upload-spinner"></span>
        <span id="uploadStatusText">Caricamento in corso...</span>
      </div>
      <div class="upload-progress-container">
        <div class="upload-progress-bar" id="uploadProgressBar"></div>
      </div>
      <div class="upload-percentage" id="uploadPercentage">0%</div>
    </div>
  </div>

  <!-- Confirm Selfie Screen -->
  <div class="screen confirm-screen" id="confirmScreen">
    <h2 class="confirm-title">Conferma selfie</h2>
    <div class="confirm-preview">
      <img id="confirmPreview" alt="Selfie preview">
    </div>
    <p class="confirm-privacy">
      Selezionando "Conferma" acconsenti al trattamento dei dati biometrici per le finalit√† di Rilevazione e Riconoscimento come da <a href="#">Privacy Policy</a>.
    </p>
    <div class="confirm-buttons">
      <button class="btn-confirm" id="confirmBtn">Conferma</button>
      <button class="btn-retake" id="retakeBtn">Scatta di nuovo</button>
    </div>
    <!-- Loading indicator per ricerca foto -->
    <div id="confirmLoadingIndicator" style="display: none; text-align: center; margin-top: 20px;">
      <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top-color: var(--purple); border-radius: 50%; animation: spin 1s linear infinite;"></div>
      <p style="color: var(--text-muted); margin-top: 15px;">Ricerca foto in corso...</p>
    </div>
  </div>

  <!-- Add People Screen -->
  <div class="screen add-people-screen" id="addPeopleScreen">
    <h2 class="add-people-title">Ottimo!</h2>
    <p style="color: var(--text-muted); margin-bottom: 30px;">Vuoi aggiungere al tuo album altri membri della famiglia?</p>
    <div class="people-list" id="peopleList">
      <div class="person-avatar">
        <img id="mainPersonAvatar" alt="Persona principale">
      </div>
      <button class="add-person-btn" id="addPersonBtn">+</button>
    </div>
    <div class="add-people-buttons">
      <button class="btn-primary" id="addPersonConfirmBtn">S√¨, aggiungi un'altra persona</button>
      <button class="btn-retake" id="skipAddPersonBtn">Non ora, vai all'album</button>
    </div>
    <!-- Loading indicator -->
    <div id="loadingIndicator" style="display: none; text-align: center; margin-top: 20px;">
      <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top-color: var(--purple); border-radius: 50%; animation: spin 1s linear infinite;"></div>
      <p style="color: var(--text-muted); margin-top: 15px;">Caricamento foto in corso...</p>
    </div>
  </div>

  <!-- Album Screen -->
  <div class="screen album-screen" id="albumScreen">
    <div class="album-header">
      <button class="album-back" id="albumBackBtn">‚Üê</button>
      <button class="album-cart" id="albumCartBtn">
        üõí <span id="albumCartCount">0</span> - <span id="albumCartPrice">‚Ç¨0</span>
      </button>
    </div>
    <div class="album-profile">
      <div class="profile-avatar">
        <img src="/static/logo.png" alt="Tenerife Stars Pictures" onerror="this.style.display='none'">
      </div>
      <div class="profile-info">
        <h3>Tenerife Stars Pictures</h3>
        <p>Tu sesi√≥n de fotos fue realizada por Metaproos</p>
      </div>
    </div>
    <div class="album-tabs">
      <button class="album-tab active" id="myContentTab">I miei contenuti</button>
      <button class="album-tab" id="pricesTab">Listino prezzi ‚Üó</button>
    </div>
    <div class="album-photo-count" id="albumPhotoCount" style="display: none;">
      Hai trovato <span id="photoCountNumber">0</span> foto
    </div>
    <div class="album-grid" id="albumGrid">
      <!-- Foto verranno aggiunte qui -->
    </div>
    <button class="album-buy-all" id="buyAllBtn">
      <div>
        <div>Acquista tutte le foto a <span class="price" id="buyAllPrice">‚Ç¨0</span></div>
        <div class="subtitle">in formato digitale</div>
      </div>
      <span>‚Üí</span>
    </button>
  </div>
  
  <!-- Sticky Offer Bar -->
  <div class="sticky-offer-bar" id="stickyOfferBar">
    <div class="sticky-offer-content">
      <div class="sticky-offer-text" id="stickyOfferText">Acquista tutte le foto</div>
      <div class="sticky-offer-price" id="stickyOfferPrice">‚Ç¨0</div>
    </div>
    <div class="sticky-offer-actions">
      <button class="sticky-offer-btn" id="stickyOfferBuyBtn">Acquista</button>
      <button class="sticky-offer-close" id="stickyOfferCloseBtn">‚úï</button>
    </div>
  </div>

  <!-- Lightbox per foto -->
  <div class="ios-share-modal" id="photoLightbox" style="z-index: 2000;">
    <div style="position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
      <button id="lightboxClose" style="position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.6); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 24px; cursor: pointer; z-index: 10;">‚úï</button>
      <div style="position: absolute; top: 20px; left: 20px; color: white; font-size: 16px; z-index: 10; background: rgba(0,0,0,0.6); padding: 8px 16px; border-radius: 20px;" id="photoCounter">1/1</div>
      <button id="lightboxPrev" style="position: absolute; left: 20px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.6); color: white; border: none; width: 50px; height: 50px; border-radius: 50%; font-size: 24px; cursor: pointer; z-index: 10; display: none;">‚Üê</button>
      <button id="lightboxNext" style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.6); color: white; border: none; width: 50px; height: 50px; border-radius: 50%; font-size: 24px; cursor: pointer; z-index: 10; display: none;">‚Üí</button>
      <img id="lightboxImage" style="max-width: 100%; max-height: 100%; object-fit: contain; user-select: none; -webkit-user-drag: none;" alt="Foto">
    </div>
  </div>
  
  <!-- Modal Carrello -->
  <div class="ios-share-modal" id="cartModal">
    <div class="ios-share-modal-content" style="max-width: 500px; width: 90%;">
      <h3 style="margin-top: 0; font-size: 20px; color: var(--text-light);">üõí Carrello</h3>
      <div id="cartItems" style="max-height: 400px; overflow-y: auto; margin: 20px 0;">
        <p style="text-align: center; color: var(--text-muted);">Il carrello √® vuoto</p>
      </div>
      <div style="border-top: 2px solid rgba(255,255,255,0.1); padding-top: 15px; margin-top: 15px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 18px; font-weight: 600; color: var(--text-light);">
          <span>Totale:</span>
          <span id="cartTotal">‚Ç¨0.00</span>
        </div>
        <button class="btn-primary" id="checkoutBtn" style="width: 100%; margin-bottom: 10px;" disabled>üí≥ Vai al Pagamento</button>
        <button class="btn-retake" id="closeCartBtn" style="width: 100%;">Chiudi</button>
      </div>
    </div>
  </div>

  <!-- Modal Offerte -->
  <div class="ios-share-modal" id="offersModal">
    <div class="ios-share-modal-content" style="max-width: 500px; width: 90%; background: var(--bg-dark2); border: 2px solid var(--accent);">
      <h3 style="margin-top: 0; font-size: 24px; color: var(--text-light); text-align: center;">üéÅ Offerta Speciale!</h3>
      <div id="offersContent" style="text-align: center; padding: 20px 0;">
        <p style="font-size: 18px; color: var(--text-light); margin-bottom: 15px;">
          Hai trovato <strong id="offersPhotoCount" style="color: var(--accent-light);">0</strong> foto!
        </p>
        <div id="offersMessage" style="font-size: 16px; color: var(--text-muted); margin-bottom: 20px;">
          <!-- Messaggio offerta dinamico -->
        </div>
        <div style="background: linear-gradient(135deg, var(--purple), var(--pink)); color: #fff; padding: 20px; border-radius: 12px; margin: 20px 0;">
          <div style="font-size: 32px; font-weight: 900; margin-bottom: 10px;" id="offersPrice">‚Ç¨0</div>
          <div style="font-size: 14px; opacity: 0.9;">per tutte le tue foto</div>
        </div>
        <button class="btn-primary" id="offersBuyBtn" style="width: 100%; margin-bottom: 10px; font-size: 18px; padding: 16px;">
          üí≥ Acquista Tutte le Foto
        </button>
        <button class="btn-retake" id="offersCloseBtn" style="width: 100%;">
          Scegli Foto Singole
        </button>
      </div>
    </div>
  </div>

  <script>
    // Variabili globali
    let currentScreen = 'welcome';
    let stream = null;
    let useFront = true;
    let capturedBlob = null;
    let sessionId = localStorage.getItem("cart_session_id") || "session_" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);
    localStorage.setItem("cart_session_id", sessionId);
    let currentCart = { photo_ids: [], count: 0, price_euros: 0 };
    let allPhotos = [];
    let currentPhotoIndex = 0;

    // Elementi DOM
    const welcomeScreen = document.getElementById("welcomeScreen");
    const selfieScreen = document.getElementById("selfieScreen");
    const confirmScreen = document.getElementById("confirmScreen");
    const addPeopleScreen = document.getElementById("addPeopleScreen");
    const albumScreen = document.getElementById("albumScreen");
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const confirmPreview = document.getElementById("confirmPreview");
    const mainPersonAvatar = document.getElementById("mainPersonAvatar");
    const albumGrid = document.getElementById("albumGrid");
    const albumCartBtn = document.getElementById("albumCartBtn");
    const albumCartCount = document.getElementById("albumCartCount");
    const albumCartPrice = document.getElementById("albumCartPrice");
    const buyAllBtn = document.getElementById("buyAllBtn");
    const buyAllPrice = document.getElementById("buyAllPrice");
    const photoLightbox = document.getElementById("photoLightbox");
    const lightboxImage = document.getElementById("photoLightbox").querySelector("img");
    const photoCounter = document.getElementById("photoCounter");

    // Funzioni screen management
    function showScreen(screenName) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      const screen = document.getElementById(screenName + 'Screen');
      if(screen) screen.classList.add('active');
      currentScreen = screenName;
    }

    // Event listeners
    document.getElementById("welcomeContinueBtn").addEventListener("click", async () => {
      showScreen('selfie');
      // Aspetta un attimo che lo schermo sia visibile, poi avvia la camera
      setTimeout(async () => {
        await startCamera();
      }, 100);
    });

    document.getElementById("captureBtn").addEventListener("click", captureSelfie);
    document.getElementById("confirmBtn").addEventListener("click", confirmSelfie);
    document.getElementById("retakeBtn").addEventListener("click", () => {
      startCamera();
      showScreen('selfie');
    });
    document.getElementById("retryCameraBtn")?.addEventListener("click", async () => {
      const placeholder = document.getElementById('videoPlaceholder');
      const video = document.getElementById('video');
      if(placeholder) placeholder.style.display = 'none';
      if(video) video.style.display = 'block';
      await startCamera();
    });
    document.getElementById("skipAddPersonBtn").addEventListener("click", () => {
      // Se le foto sono gi√† state caricate, mostra direttamente l'album
      if(allPhotos && allPhotos.length > 0) {
        displayPhotos();
        updateCart();
        showScreen('album');
      } else {
        matchPhotos();
      }
    });
    document.getElementById("addPersonConfirmBtn").addEventListener("click", () => {
      // Per ora salta, poi implementeremo aggiunta persone
      // Se le foto sono gi√† state caricate, mostra direttamente l'album
      if(allPhotos && allPhotos.length > 0) {
        displayPhotos();
        updateCart();
        showScreen('album');
      } else {
        matchPhotos();
      }
    });
    document.getElementById("buyAllBtn").addEventListener("click", checkout);
    document.getElementById("albumBackBtn").addEventListener("click", () => {
      showScreen('welcome');
    });
    document.getElementById("albumCartBtn").addEventListener("click", () => {
      document.getElementById('cartModal').classList.add('active');
      updateCartModal();
    });
    document.getElementById("closeCartBtn").addEventListener("click", () => {
      document.getElementById('cartModal').classList.remove('active');
    });
    document.getElementById("checkoutBtn").addEventListener("click", checkout);
    
    // Chiudi modal cliccando fuori
    document.getElementById('cartModal').addEventListener('click', (e) => {
      if(e.target.id === 'cartModal') {
        document.getElementById('cartModal').classList.remove('active');
      }
    });
    
    document.getElementById('offersModal').addEventListener('click', (e) => {
      if(e.target.id === 'offersModal') {
        document.getElementById('offersModal').classList.remove('active');
      }
    });

    // Funzioni camera
    async function startCamera() {
      try {
        // Verifica supporto camera
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          alert("Questo browser non supporta l'accesso alla fotocamera. Prova con Chrome o Safari.");
          return;
        }

        // Ferma stream precedente se esiste
        if(stream) {
          stream.getTracks().forEach(track => track.stop());
        }

        console.log("Richiesta accesso camera...");
        stream = await navigator.mediaDevices.getUserMedia({
          video: { 
            facingMode: useFront ? 'user' : 'environment',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          },
          audio: false
        });
        
        console.log("Stream ottenuto, assegno al video...");
        video.srcObject = stream;
        
        // Aspetta che il video sia pronto (importante su mobile)
        await new Promise((resolve, reject) => {
          let resolved = false;
          
          const onPlaying = () => {
            if(!resolved && video.videoWidth > 0 && video.videoHeight > 0) {
              console.log("Video in riproduzione, dimensioni:", video.videoWidth, "x", video.videoHeight);
              resolved = true;
              resolve();
            }
          };
          
          const checkReady = () => {
            if(video.readyState >= 2 && !resolved) { // HAVE_CURRENT_DATA o superiore
              console.log("Video metadata caricati, dimensioni:", video.videoWidth, "x", video.videoHeight);
              video.play().then(() => {
                console.log("Video play() chiamato");
                // Su iOS a volte serve aspettare l'evento 'playing'
                video.addEventListener('playing', onPlaying, { once: true });
                // Fallback: controlla dopo un delay
                setTimeout(() => {
                  if(!resolved && video.videoWidth > 0 && video.videoHeight > 0) {
                    onPlaying();
                  }
                }, 500);
              }).catch((playErr) => {
                console.error("Errore play():", playErr);
                // Su iOS potrebbe essere necessario un interazione utente
                if(playErr.name === 'NotAllowedError') {
                  reject(new Error("Premi sul video per avviare la fotocamera"));
                } else {
                  reject(playErr);
                }
              });
            }
          };
          
          video.onloadedmetadata = checkReady;
          video.onplaying = onPlaying;
          video.onerror = (e) => {
            console.error("Errore video:", e);
            if(!resolved) {
              resolved = true;
              reject(new Error("Errore nel caricamento del video"));
            }
          };
          
          // Avvia il check
          if(video.readyState >= 2) {
            checkReady();
          } else {
            video.onloadedmetadata = checkReady;
          }
          
          // Timeout dopo 10 secondi
          setTimeout(() => {
            if(!resolved) {
              resolved = true;
              reject(new Error("Timeout caricamento video"));
            }
          }, 10000);
        });
        
        // Abilita il pulsante di cattura
        const captureBtn = document.getElementById('captureBtn');
        if(captureBtn) {
          captureBtn.disabled = false;
        }
        
        // Nascondi placeholder se visibile
        const placeholder = document.getElementById('videoPlaceholder');
        if(placeholder) {
          placeholder.style.display = 'none';
        }
        
      } catch (err) {
        console.error("Errore accesso camera:", err);
        
        // Mostra placeholder
        const placeholder = document.getElementById('videoPlaceholder');
        const video = document.getElementById('video');
        if(placeholder && video) {
          placeholder.style.display = 'block';
          video.style.display = 'none';
        }
        
        // Disabilita pulsante cattura
        const captureBtn = document.getElementById('captureBtn');
        if(captureBtn) {
          captureBtn.disabled = true;
        }
        
        let errorMsg = "Errore accesso camera.";
        if(err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
          errorMsg = "Permesso camera negato. Abilita l'accesso alla fotocamera nelle impostazioni del browser.";
        } else if(err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
          errorMsg = "Nessuna fotocamera trovata.";
        } else if(err.name === 'NotReadableError' || err.name === 'TrackStartError') {
          errorMsg = "La fotocamera √® gi√† in uso da un'altra app.";
        } else {
          errorMsg = "Errore accesso camera: " + err.message;
        }
        
        // Mostra messaggio nel placeholder
        if(placeholder) {
          const msgEl = placeholder.querySelector('p');
          if(msgEl) {
            msgEl.textContent = errorMsg;
          }
        }
      }
    }

    function captureSelfie() {
      try {
        // Verifica che il video sia pronto
        if(!video || !video.videoWidth || !video.videoHeight) {
          console.error("Video non pronto:", {
            video: !!video,
            width: video?.videoWidth,
            height: video?.videoHeight,
            readyState: video?.readyState
          });
          alert("La fotocamera non √® ancora pronta. Attendi un attimo e riprova.");
          return;
        }

        console.log("Cattura selfie, dimensioni video:", video.videoWidth, "x", video.videoHeight);
        
        // Aspect ratio fisso 3:4 (verticale) - stesso del contenitore video
        const targetAspectRatio = 3 / 4;
        const videoAspectRatio = video.videoWidth / video.videoHeight;
        
        let sourceX = 0;
        let sourceY = 0;
        let sourceWidth = video.videoWidth;
        let sourceHeight = video.videoHeight;
        
        // Calcola dimensioni canvas con aspect ratio 3:4
        let canvasWidth, canvasHeight;
        
        if(videoAspectRatio > targetAspectRatio) {
          // Video pi√π largo: crop ai lati, mantieni altezza
          canvasHeight = video.videoHeight;
          canvasWidth = Math.round(canvasHeight * targetAspectRatio);
          sourceX = Math.round((video.videoWidth - canvasWidth) / 2);
          sourceY = 0;
          sourceWidth = canvasWidth;  // Usa la larghezza del crop, non quella del video
          sourceHeight = canvasHeight; // Usa l'altezza del crop
        } else {
          // Video pi√π alto: crop sopra/sotto, mantieni larghezza
          canvasWidth = video.videoWidth;
          canvasHeight = Math.round(canvasWidth / targetAspectRatio);
          sourceX = 0;
          sourceY = Math.round((video.videoHeight - canvasHeight) / 2);
          sourceWidth = canvasWidth;  // Usa la larghezza del crop
          sourceHeight = canvasHeight; // Usa l'altezza del crop
        }
        
        // Imposta dimensioni canvas
        canvas.width = canvasWidth;
        canvas.height = canvasHeight;
        
        const ctx = canvas.getContext('2d');
        
        // Disegna il frame corrente del video sul canvas con crop centrato
        // Usa la stessa area che viene mostrata nel video (object-fit: cover)
        ctx.drawImage(
          video,
          sourceX, sourceY, sourceWidth, sourceHeight,  // Area sorgente (crop) - CORRETTO
          0, 0, canvasWidth, canvasHeight                // Area destinazione (canvas)
        );
        
        console.log("Canvas creato, dimensioni:", canvas.width, "x", canvas.height);
        console.log("Crop applicato:", { sourceX, sourceY, sourceWidth, sourceHeight });
        
        // Converti canvas in blob
        canvas.toBlob((blob) => {
          if(!blob) {
            console.error("Errore: blob non creato");
            alert("Errore nella cattura della foto. Riprova.");
            return;
          }
          
          console.log("Blob creato, dimensione:", blob.size, "bytes");
          capturedBlob = blob;
          const url = URL.createObjectURL(blob);
          confirmPreview.src = url;
          if(mainPersonAvatar) {
            mainPersonAvatar.src = url;
          }
          
          // Ferma lo stream
          if(stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
          }
          
          showScreen('confirm');
        }, 'image/jpeg', 0.9);
        
      } catch(err) {
        console.error("Errore nella cattura selfie:", err);
        alert("Errore nella cattura della foto: " + err.message);
      }
    }

    function confirmSelfie() {
      // Dopo la conferma del selfie, cerca direttamente le foto
      matchPhotos();
    }

    // Funzioni matching
    async function matchPhotos() {
      if(!capturedBlob) {
        console.error("capturedBlob √® null!");
        alert("Errore: selfie non trovato. Per favore scatta di nuovo.");
        showScreen('selfie');
        startCamera();
        return;
      }
      
      // Mostra area upload status (torna allo schermo selfie se siamo in confirm)
      showScreen('selfie');
      const uploadStatus = document.getElementById('uploadStatus');
      const uploadStatusText = document.getElementById('uploadStatusText');
      const uploadProgressBar = document.getElementById('uploadProgressBar');
      const uploadPercentage = document.getElementById('uploadPercentage');
      const captureBtn = document.getElementById('captureBtn');
      
      // Mostra upload status e disabilita pulsante
      if(uploadStatus) uploadStatus.classList.add('active');
      if(uploadStatusText) uploadStatusText.textContent = 'Caricamento selfie...';
      if(uploadProgressBar) uploadProgressBar.style.width = '10%';
      if(uploadPercentage) uploadPercentage.textContent = '10%';
      if(captureBtn) {
        captureBtn.disabled = true;
        captureBtn.style.opacity = '0.5';
      }
      
      try {
        console.log("Inizio matchPhotos: invio selfie al server...");
        
        // Aggiorna progress
        if(uploadProgressBar) uploadProgressBar.style.width = '30%';
        if(uploadPercentage) uploadPercentage.textContent = '30%';
        if(uploadStatusText) uploadStatusText.textContent = 'Invio selfie al server...';
        
        const fd = new FormData();
        fd.append("selfie", capturedBlob, "selfie.jpg");
        
        // Simula progress durante upload (XMLHttpRequest per avere progress reale)
        const xhr = new XMLHttpRequest();
        
        // Promise per gestire la risposta
        const uploadPromise = new Promise((resolve, reject) => {
          xhr.upload.addEventListener('progress', (e) => {
            if(e.lengthComputable) {
              const percent = Math.round((e.loaded / e.total) * 50) + 30; // 30-80%
              if(uploadProgressBar) uploadProgressBar.style.width = percent + '%';
              if(uploadPercentage) uploadPercentage.textContent = percent + '%';
            }
          });
          
          xhr.addEventListener('load', () => {
            if(xhr.status >= 200 && xhr.status < 300) {
              resolve(xhr);
            } else {
              reject(new Error(`HTTP ${xhr.status}: ${xhr.statusText}`));
            }
          });
          
          xhr.addEventListener('error', () => reject(new Error('Network error')));
          xhr.addEventListener('abort', () => reject(new Error('Upload aborted')));
          
          xhr.open('POST', '/match_selfie?top_k_faces=120&min_score=0.08');
          xhr.send(fd);
        });
        
        // Aggiorna progress
        if(uploadProgressBar) uploadProgressBar.style.width = '80%';
        if(uploadPercentage) uploadPercentage.textContent = '80%';
        if(uploadStatusText) uploadStatusText.textContent = 'Analisi foto in corso...';
        
        await uploadPromise;
        
        const res = xhr;
        console.log("Risposta ricevuta, status:", res.status, res.status >= 200 && res.status < 300);
        
        // Controlla se la risposta √® OK
        if(res.status < 200 || res.status >= 300) {
          let errorMsg = "Errore server. Riprova tra poco.";
          try {
            const errorData = JSON.parse(res.responseText);
            console.error("Errore dal server:", errorData);
            if(errorData.detail) {
              errorMsg = `Errore: ${errorData.detail}`;
            } else if(errorData.error && errorData.error.message) {
              errorMsg = `Errore: ${errorData.error.message}`;
            }
          } catch(e) {
            console.error("Errore nel parsing JSON di errore:", e);
            errorMsg = `Errore ${res.status}: ${res.statusText}`;
          }
          console.error("Errore risposta server:", res.status, errorMsg);
          
          // Nascondi upload status
          if(uploadStatus) uploadStatus.classList.remove('active');
          if(captureBtn) {
            captureBtn.disabled = false;
            captureBtn.style.opacity = '1';
          }
          
          alert(errorMsg);
          showScreen('selfie');
          startCamera();
          return;
        }
        
        // Aggiorna progress finale
        if(uploadProgressBar) uploadProgressBar.style.width = '100%';
        if(uploadPercentage) uploadPercentage.textContent = '100%';
        if(uploadStatusText) uploadStatusText.textContent = 'Completato!';
        
        const data = JSON.parse(res.responseText);
        console.log("Dati ricevuti:", { 
          ok: data.ok, 
          count: data.count, 
          resultsLength: data.results ? data.results.length : 0,
          matchesLength: data.matches ? data.matches.length : 0
        });
        
        // Usa results o matches (per compatibilit√†)
        const photos = data.results || data.matches || [];
        
        if(data.ok && photos.length > 0) {
          console.log(`Trovate ${photos.length} foto, aggiungo al carrello...`);
          if(uploadStatusText) uploadStatusText.textContent = `Trovate ${photos.length} foto, aggiungo al carrello...`;
          
          allPhotos = photos;
          
          // Aggiungi automaticamente tutte le foto al carrello
          for(const photo of allPhotos) {
            try {
              await addToCart(photo.photo_id);
            } catch(cartErr) {
              console.error("Errore aggiungendo foto al carrello:", photo.photo_id, cartErr);
              // Continua anche se una foto fallisce
            }
          }
          
          console.log("Foto aggiunte al carrello, mostro album...");
          
          // Nascondi upload status prima di cambiare schermo
          setTimeout(() => {
            if(uploadStatus) uploadStatus.classList.remove('active');
            if(captureBtn) {
              captureBtn.disabled = false;
              captureBtn.style.opacity = '1';
            }
          }, 500);
          
          displayPhotos();
          updateCart();
          showStickyOfferBar(photos.length);
          showScreen('album');
        } else {
          console.warn("Nessuna foto trovata o risposta non valida:", data);
          // Nascondi upload status
          if(uploadStatus) uploadStatus.classList.remove('active');
          if(captureBtn) {
            captureBtn.disabled = false;
            captureBtn.style.opacity = '1';
          }
          
          alert("Nessuna foto trovata. Riprova.");
          showScreen('selfie');
          startCamera();
        }
      } catch(err) {
        console.error("Errore nel caricamento foto:", err);
        console.error("Stack trace:", err.stack);
        
        // Nascondi upload status
        if(uploadStatus) uploadStatus.classList.remove('active');
        if(captureBtn) {
          captureBtn.disabled = false;
          captureBtn.style.opacity = '1';
        }
        
        alert("Errore di connessione. Controlla la tua connessione internet e riprova.");
        showScreen('selfie');
        startCamera();
      }
    }

    function displayPhotos() {
      albumGrid.innerHTML = '';
      allPhotos.forEach((photo, index) => {
        const div = document.createElement('div');
        div.className = 'album-photo';
        div.innerHTML = `
          <img src="/photo/${encodeURIComponent(photo.photo_id)}?paid=false" alt="${photo.photo_id}">
          <button class="add-cart" onclick="addToCart('${photo.photo_id}')">+</button>
        `;
        div.querySelector('img').addEventListener('click', () => openLightbox(index));
        albumGrid.appendChild(div);
      });
    }

    function showStickyOfferBar(photoCount) {
      const stickyBar = document.getElementById('stickyOfferBar');
      const stickyText = document.getElementById('stickyOfferText');
      const stickyPrice = document.getElementById('stickyOfferPrice');
      const stickyBuyBtn = document.getElementById('stickyOfferBuyBtn');
      const stickyCloseBtn = document.getElementById('stickyOfferCloseBtn');
      const photoCountBanner = document.getElementById('albumPhotoCount');
      const photoCountNumber = document.getElementById('photoCountNumber');
      
      if(!stickyBar) {
        console.warn("Sticky offer bar non trovato");
        return;
      }
      
      // Mostra banner conteggio foto sopra la griglia
      if(photoCountBanner && photoCountNumber) {
        photoCountNumber.textContent = photoCount;
        photoCountBanner.style.display = 'block';
      }
      
      // Calcola prezzo
      const priceCents = calculatePrice(photoCount);
      const priceEuros = (priceCents / 100).toFixed(2);
      
      // Messaggio personalizzato in base al numero di foto
      let message = "";
      if(photoCount === 1) {
        message = "Acquista la tua foto";
      } else if(photoCount <= 5) {
        message = `Acquista tutte le ${photoCount} foto`;
      } else if(photoCount <= 11) {
        message = `Acquista tutte le ${photoCount} foto e risparmia`;
      } else {
        message = `Acquista tutte le ${photoCount} foto al prezzo migliore`;
      }
      
      if(stickyText) {
        stickyText.textContent = message;
      }
      
      if(stickyPrice) {
        stickyPrice.textContent = `‚Ç¨${priceEuros}`;
      }
      
      // Event listener per pulsante acquista (se non gi√† presente)
      if(stickyBuyBtn && !stickyBuyBtn.dataset.listenerAdded) {
        stickyBuyBtn.addEventListener('click', () => {
          checkout();
        });
        stickyBuyBtn.dataset.listenerAdded = 'true';
      }
      
      // Event listener per pulsante chiudi (se non gi√† presente)
      if(stickyCloseBtn && !stickyCloseBtn.dataset.listenerAdded) {
        stickyCloseBtn.addEventListener('click', () => {
          stickyBar.classList.remove('active');
        });
        stickyCloseBtn.dataset.listenerAdded = 'true';
      }
      
      // Mostra banner con animazione
      setTimeout(() => {
        stickyBar.classList.add('active');
      }, 300); // Piccolo delay per far vedere prima le foto
    }

    function openLightbox(index) {
      currentPhotoIndex = index;
      const photo = allPhotos[index];
      lightboxImage.src = `/photo/${encodeURIComponent(photo.photo_id)}?paid=false`;
      updateLightboxCounter();
      photoLightbox.classList.add('active');
      
      // Mostra/nascondi frecce
      const prevBtn = document.getElementById('lightboxPrev');
      const nextBtn = document.getElementById('lightboxNext');
      prevBtn.style.display = allPhotos.length > 1 ? 'flex' : 'none';
      nextBtn.style.display = allPhotos.length > 1 ? 'flex' : 'none';
    }
    
    function updateLightboxCounter() {
      photoCounter.textContent = `${currentPhotoIndex + 1}/${allPhotos.length}`;
    }
    
    function nextPhoto() {
      if(currentPhotoIndex < allPhotos.length - 1) {
        currentPhotoIndex++;
        const photo = allPhotos[currentPhotoIndex];
        lightboxImage.src = `/photo/${encodeURIComponent(photo.photo_id)}?paid=false`;
        updateLightboxCounter();
      }
    }
    
    function prevPhoto() {
      if(currentPhotoIndex > 0) {
        currentPhotoIndex--;
        const photo = allPhotos[currentPhotoIndex];
        lightboxImage.src = `/photo/${encodeURIComponent(photo.photo_id)}?paid=false`;
        updateLightboxCounter();
      }
    }

    async function addToCart(photoId) {
      try {
        const res = await fetch(`/cart/add?session_id=${encodeURIComponent(sessionId)}&photo_id=${encodeURIComponent(photoId)}`, {
          method: "POST"
        });
        const data = await res.json();
        if(data.ok) {
          currentCart = data;
          updateCart();
        }
      } catch(err) {
        console.error("Error adding to cart:", err);
      }
    }

    function updateCart() {
      albumCartCount.textContent = currentCart.count || 0;
      albumCartPrice.textContent = `‚Ç¨${(currentCart.price_euros || 0).toFixed(2)}`;
      buyAllPrice.textContent = `‚Ç¨${(currentCart.price_euros || 0).toFixed(2)}`;
    }
    
    function updateCartModal() {
      const cartItems = document.getElementById('cartItems');
      const cartTotal = document.getElementById('cartTotal');
      const checkoutBtn = document.getElementById('checkoutBtn');
      
      if(currentCart.photo_ids && currentCart.photo_ids.length > 0) {
        cartItems.innerHTML = '';
        currentCart.photo_ids.forEach(photoId => {
          const div = document.createElement('div');
          div.style.cssText = 'display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1);';
          div.innerHTML = `
            <div style="display: flex; align-items: center; gap: 12px;">
              <img src="/photo/${encodeURIComponent(photoId)}?paid=false" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;" />
              <span style="font-size: 14px; color: var(--text-light);">${photoId}</span>
            </div>
            <button onclick="removeFromCart('${photoId}')" style="background: #ff4444; color: #fff; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 14px;">Rimuovi</button>
          `;
          cartItems.appendChild(div);
        });
        cartTotal.textContent = `‚Ç¨${currentCart.price_euros.toFixed(2)}`;
        checkoutBtn.disabled = false;
      } else {
        cartItems.innerHTML = '<p style="text-align: center; color: var(--text-muted);">Il carrello √® vuoto</p>';
        cartTotal.textContent = "‚Ç¨0.00";
        checkoutBtn.disabled = true;
      }
    }
    
    async function removeFromCart(photoId) {
      try {
        const res = await fetch(`/cart/remove?session_id=${encodeURIComponent(sessionId)}&photo_id=${encodeURIComponent(photoId)}`, {
          method: "DELETE"
        });
        const data = await res.json();
        if(data.ok) {
          currentCart = data;
          updateCart();
          updateCartModal();
        }
      } catch(err) {
        console.error("Error removing from cart:", err);
      }
    }

    function calculatePrice(count) {
      if(count === 1) return 2000;
      if(count === 2) return 4000;
      if(count === 3) return 3500;
      if(count === 4) return 4000;
      if(count === 5) return 4500;
      if(count >= 6 && count <= 11) return 5000;
      return 6000;
    }

    async function checkout() {
      if(!currentCart.photo_ids || currentCart.photo_ids.length === 0) {
        alert("Aggiungi foto al carrello!");
        return;
      }
      
      const res = await fetch(`/checkout?session_id=${encodeURIComponent(sessionId)}`, {
        method: "POST"
      });
      
      const data = await res.json();
      if(data.checkout_url) {
        window.location.href = data.checkout_url;
      }
    }

    // Lightbox controls
    document.getElementById('lightboxClose').addEventListener('click', () => {
      photoLightbox.classList.remove('active');
    });
    
    document.getElementById('lightboxPrev').addEventListener('click', prevPhoto);
    document.getElementById('lightboxNext').addEventListener('click', nextPhoto);
    
    // Navigazione con tastiera
    document.addEventListener('keydown', (e) => {
      if(photoLightbox.classList.contains('active')) {
        if(e.key === 'ArrowLeft') prevPhoto();
        if(e.key === 'ArrowRight') nextPhoto();
        if(e.key === 'Escape') photoLightbox.classList.remove('active');
      }
    });

    photoLightbox.addEventListener('click', (e) => {
      if(e.target === photoLightbox) {
        photoLightbox.classList.remove('active');
      }
    });
    
    // Blocca salvataggio foto
    lightboxImage.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      alert('‚ö†Ô∏è Acquista la foto per scaricarla!');
    });
    
    lightboxImage.addEventListener('dragstart', (e) => {
      e.preventDefault();
    });
    

    // Boot
    window.addEventListener('load', () => {
      if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert("Questo browser non supporta la camera.");
      }
    });
  </script>
</body>
</html>

