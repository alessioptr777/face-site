<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Metaproos - Trova le tue foto</title>
  <style>
    :root{
      --bg1:#5f58ff;
      --bg2:#7b74ff;
      --card:#ffffff;
      --text:#0b1630;
      --muted:#6b7a90;
      --accent:#3a86ff;
      --green:#2bb673;
      --green2:#1ea463;
      --shadow: 0 18px 45px rgba(10,20,60,.18);
      --radius: 28px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
      color:var(--text);
      min-height:100vh;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(255,255,255,.35), transparent 45%),
                  linear-gradient(180deg,var(--bg2),var(--bg1));
      padding:18px;
      padding-bottom: 100px;
    }
    
    .shell{
      max-width: 1400px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
    }
    
    @media (min-width: 980px){
      .shell{
        grid-template-columns: 420px 1fr;
        align-items: start;
      }
      body{
        padding-bottom: 18px;
      }
    }
    
    .leftCol, .rightCol{
      width: 100%;
    }
    
    .card{
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 26px 18px 18px;
      position:relative;
      overflow:hidden;
      margin-bottom: 20px;
    }
    
    .brandCard{
      text-align: center;
      padding: 32px 24px;
    }
    
    .brandLogo{
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), var(--bg1));
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 16px;
      font-size: 36px;
      font-weight: 900;
      color: #fff;
      box-shadow: 0 8px 24px rgba(58,134,255,.3);
    }
    
    .brandTitle{
      font-size: 32px;
      font-weight: 900;
      margin: 0 0 8px;
      color: var(--text);
      letter-spacing: -0.5px;
    }
    
    .brandSubtitle{
      font-size: 16px;
      color: var(--muted);
      margin: 0;
      font-weight: 500;
    }
    
    .title{
      text-align:center;
      font-size: 28px;
      font-weight: 800;
      letter-spacing:.2px;
      margin: 0 0 18px;
    }
    
    .how{
      display:flex;
      gap:14px;
      align-items:flex-start;
      padding:14px 14px 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.75);
      border: 1px solid rgba(30,60,120,.08);
      margin: 0 6px 18px;
    }
    .how .bar{
      width:4px;
      border-radius: 20px;
      background: linear-gradient(180deg, rgba(58,134,255,.9), rgba(58,134,255,.25));
      margin-top: 6px;
      flex:0 0 4px;
      height: 132px;
    }
    .how h3{
      margin:0 0 8px;
      font-size: 18px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .steps{
      margin:0;
      padding:0;
      list-style:none;
      display:grid;
      gap:10px;
      color: var(--text);
    }
    .steps li{
      display:flex;
      gap:10px;
      align-items:flex-start;
      font-size: 16px;
      line-height:1.25;
    }
    .ico{
      width:22px;height:22px;
      border-radius: 50%;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      flex:0 0 22px;
      background: rgba(58,134,255,.12);
      color: var(--accent);
      font-weight:700;
      font-size:13px;
      margin-top:1px;
    }

    .circleWrap{
      display:flex;
      justify-content:center;
      margin: 10px 0 10px;
    }
    .circle{
      width: 250px;
      height: 250px;
      border-radius: 50%;
      background: rgba(255,255,255,.75);
      border: 10px solid rgba(255,255,255,.85);
      box-shadow: 0 18px 40px rgba(0,0,0,.18);
      position:relative;
      overflow:hidden;
    }
    video{
      width:100%;
      height:100%;
      object-fit: cover;
      transform: scaleX(-1);
      background: #000;
    }
    canvas{display:none}
    .circleHint{
      text-align:center;
      color: var(--muted);
      font-style: italic;
      margin: 8px 8px 10px;
      font-size: 15px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }

    .btn{
      width: calc(100% - 20px);
      margin: 12px auto 8px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding: 14px 16px;
      border-radius: 14px;
      border: 0;
      background: linear-gradient(180deg, var(--green), var(--green2));
      color: #fff;
      font-size: 18px;
      font-weight: 800;
      box-shadow: 0 14px 30px rgba(30,164,99,.32);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      position: relative;
      z-index: 10;
    }
    .btn:active{transform: translateY(1px)}
    .btn[disabled]{
      opacity:.55;
      cursor:not-allowed;
      box-shadow:none;
    }
    .smallRow{
      display:flex;
      justify-content:center;
      gap:10px;
      margin-top:6px;
    }
    .mini{
      border:0;
      background: rgba(11,22,48,.06);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 700;
      cursor:pointer;
      position: relative;
      z-index: 10;
    }
    .mini:active{transform: translateY(1px)}

    .status{
      text-align:center;
      margin: 10px 10px 2px;
      color: var(--muted);
      font-size: 14px;
      min-height: 18px;
    }

    .results{
      margin-top: 14px;
      padding: 10px 6px 4px;
      min-height: 200px;
    }
    .resultsTitle{
      font-weight: 900;
      font-size: 20px;
      margin: 0 0 16px;
      color: var(--text);
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
      padding: 0 6px 10px;
    }
    .ph{
      background: rgba(255,255,255,.85);
      border: 1px solid rgba(20,40,90,.10);
      border-radius: 14px;
      overflow:hidden;
      position:relative;
      box-shadow: 0 8px 20px rgba(0,0,0,.08);
    }
    .ph img{
      width:100%;
      height:140px;
      object-fit: cover;
      display:block;
      background:#f2f4f8;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .ph img:hover{
      opacity: 0.9;
    }
    .meta{
      padding: 8px 8px 9px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      font-size: 12px;
      color: var(--muted);
    }
    .dl{
      border:0;
      background: rgba(58,134,255,.10);
      color: var(--accent);
      font-weight: 900;
      border-radius: 10px;
      padding: 7px 10px;
      cursor:pointer;
      white-space:nowrap;
    }
    .dl:active{transform: translateY(1px)}

    /* Lightbox per foto a schermo intero */
    .lightbox{
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.95);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 20px;
      backdrop-filter: blur(10px);
    }
    .lightbox.active{
      display: flex;
      flex-direction: column;
    }
    .lightboxImg{
      max-width: 100%;
      max-height: calc(100vh - 120px);
      object-fit: contain;
      border-radius: 8px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    }
    .lightboxControls{
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 12px;
      z-index: 2001;
    }
    .lightboxBtn{
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 0;
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      color: #fff;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .lightboxBtn:hover{
      background: rgba(255,255,255,0.3);
    }
    .lightboxBtn:active{
      transform: scale(0.95);
    }
    .lightboxSave{
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      padding: 14px 28px;
      border-radius: 999px;
      border: 0;
      background: linear-gradient(180deg, var(--green), var(--green2));
      color: #fff;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 8px 24px rgba(30,164,99,.4);
      z-index: 2001;
    }
    .lightboxSave:active{
      transform: translateX(-50%) scale(0.98);
    }

    .footerNote{
      text-align:center;
      font-size:12px;
      color: rgba(255,255,255,.9);
      margin-top: 10px;
      opacity:.9;
    }
    
    .bottomBar{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 14px 16px calc(14px + env(safe-area-inset-bottom));
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(0,0,0,.08);
      display: flex;
      justify-content: center;
      gap: 12px;
      align-items: center;
      z-index: 1000;
      box-shadow: 0 -4px 20px rgba(0,0,0,.08);
    }
    
    .bottomBar .btn{
      width: auto;
      flex: 1;
      max-width: 200px;
      margin: 0;
      font-size: 16px;
      padding: 12px 16px;
    }
    
    @media (min-width: 980px){
      .bottomBar{
        display: none;
      }
    }

    @media (max-width:380px){
      .brandTitle{font-size: 28px}
      .title{font-size: 24px}
      .circle{width:230px;height:230px}
      .grid{grid-template-columns: repeat(2, 1fr);}
      .ph img{height:140px}
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="leftCol">
      <div class="card brandCard">
        <div class="brandLogo">M</div>
        <h1 class="brandTitle">Metaproos</h1>
        <p class="brandSubtitle">Trova le tue foto in 10 secondi</p>
      </div>

      <div class="card">
        <div class="title">Trova le Tue Foto</div>

        <div class="how">
          <div class="bar"></div>
          <div>
            <h3><span class="ico">i</span>Come Funziona</h3>
            <ul class="steps">
              <li><span class="ico">üë§</span>La camera si attiva automaticamente</li>
              <li><span class="ico">üì∑</span>Scatta un selfie chiaro</li>
              <li><span class="ico">üîç</span>Il sistema trova le tue foto</li>
              <li><span class="ico">‚¨áÔ∏è</span>Scarica le foto in alta qualit√†</li>
            </ul>
          </div>
        </div>

        <div class="circleWrap">
          <div class="circle" aria-label="Anteprima camera">
            <video id="video" autoplay playsinline muted></video>
            <canvas id="canvas"></canvas>
          </div>
        </div>

        <div class="circleHint">üí° Posizionati bene davanti alla camera e guarda l'obiettivo</div>

        <button class="btn" id="shootBtn">
          üì∏ Scatta Selfie
        </button>

        <div class="smallRow">
          <button class="mini" id="switchBtn" type="button">Cambia camera</button>
          <button class="mini" id="retryBtn" type="button">Riprova</button>
        </div>

        <div class="status" id="status"></div>
      </div>

      <div class="footerNote">Se la camera non parte, apri il sito in Safari/Chrome e consenti l'accesso alla camera.</div>
    </div>

    <div class="rightCol">
      <div class="card">
        <div class="results" id="results" style="display:none;">
          <div class="resultsTitle">Risultati</div>
          <div class="grid" id="grid"></div>
        </div>
        <div id="resultsPlaceholder" style="text-align: center; padding: 40px 20px; color: var(--muted);">
          <p style="font-size: 16px; margin: 0;">Scatta un selfie per vedere le tue foto qui</p>
        </div>
      </div>
    </div>
  </div>

  <div class="bottomBar">
    <button class="btn" id="bottomShootBtn">üì∏ Scatta Selfie</button>
  </div>

  <!-- Lightbox per foto a schermo intero -->
  <div class="lightbox" id="lightbox">
    <div class="lightboxControls">
      <button class="lightboxBtn" id="lightboxClose" aria-label="Chiudi">‚úï</button>
    </div>
    <img class="lightboxImg" id="lightboxImg" alt="Foto a schermo intero" />
    <button class="lightboxSave" id="lightboxSave">üíæ Salva in Galleria</button>
  </div>

  <script>
    // --- CONFIG ---
    const API_MATCH = "/match_selfie";
    const TOP_K = 120;
    const MIN_SCORE = 0.08;

    // --- UI refs ---
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const shootBtn = document.getElementById("shootBtn");
    const switchBtn = document.getElementById("switchBtn");
    const retryBtn = document.getElementById("retryBtn");
    const statusEl = document.getElementById("status");
    const resultsEl = document.getElementById("results");
    const gridEl = document.getElementById("grid");
    const bottomShootBtn = document.getElementById("bottomShootBtn");
    const resultsPlaceholder = document.getElementById("resultsPlaceholder");
    const lightbox = document.getElementById("lightbox");
    const lightboxImg = document.getElementById("lightboxImg");
    const lightboxClose = document.getElementById("lightboxClose");
    const lightboxSave = document.getElementById("lightboxSave");

    let stream = null;
    let useFront = true;
    let currentPhotoUrl = null;

    function setStatus(msg){
      statusEl.textContent = msg || "";
    }

    async function stopStream(){
      if (stream){
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
    }

    async function startCamera(){
      setStatus("Apro la camera...");
      shootBtn.disabled = true;
      bottomShootBtn.disabled = true;

      await stopStream();

      try{
        const constraints = {
          audio:false,
          video: {
            facingMode: useFront ? "user" : "environment"
          }
        };

        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;

        await video.play().catch(()=>{});

        shootBtn.disabled = false;
        bottomShootBtn.disabled = false;
        setStatus("");
      }catch(err){
        console.error(err);
        shootBtn.disabled = true;
        bottomShootBtn.disabled = true;
        setStatus("Camera non disponibile. Controlla permessi e riprova.");
      }
    }

    function captureBlob(){
      const w = video.videoWidth;
      const h = video.videoHeight;
      if(!w || !h) return null;

      canvas.width = w;
      canvas.height = h;

      const ctx = canvas.getContext("2d");
      if (useFront){
        ctx.translate(w, 0);
        ctx.scale(-1, 1);
      }
      ctx.drawImage(video, 0, 0, w, h);

      return new Promise(resolve=>{
        canvas.toBlob(b=>resolve(b), "image/jpeg", 0.92);
      });
    }
    
    function clearResults(){
      gridEl.innerHTML = "";
      resultsEl.style.display = "none";
      if (resultsPlaceholder) {
        resultsPlaceholder.style.display = "block";
      }
    }

    function addPhotoCard(photoId, score){
      const wrap = document.createElement("div");
      wrap.className = "ph";

      const img = document.createElement("img");
      const photoUrl = "/photo/" + encodeURIComponent(photoId);
      img.src = photoUrl;
      img.alt = photoId;

      // Click sulla foto ‚Üí apre lightbox
      img.onclick = () => {
        openLightbox(photoUrl, photoId);
      };

      img.onerror = () => {
        img.style.display = "none";
        const err = document.createElement("div");
        err.style.padding = "14px";
        err.style.fontSize = "12px";
        err.style.color = "#b00020";
        err.textContent = "Immagine non trovata: " + photoId;
        wrap.prepend(err);
      };

      const meta = document.createElement("div");
      meta.className = "meta";

      const left = document.createElement("div");
      left.textContent = (score !== null && score !== undefined)
        ? ("score " + Number(score).toFixed(3))
        : "";

      wrap.appendChild(img);
      wrap.appendChild(meta);
      gridEl.appendChild(wrap);
    }

    function openLightbox(photoUrl, photoId){
      currentPhotoUrl = photoUrl;
      lightboxImg.src = photoUrl;
      lightboxImg.alt = photoId;
      lightbox.classList.add("active");
      document.body.style.overflow = "hidden"; // Previeni scroll
    }

    function closeLightbox(){
      lightbox.classList.remove("active");
      document.body.style.overflow = ""; // Ripristina scroll
      currentPhotoUrl = null;
    }

    function saveToGallery(){
      if(!currentPhotoUrl) return;
      
      // Su mobile, apri l'immagine in una nuova tab cos√¨ l'utente pu√≤ salvare facilmente
      // Su iOS Safari e Android Chrome, questo permette di salvare nella galleria
      const a = document.createElement("a");
      a.href = currentPhotoUrl;
      a.target = "_blank";
      a.rel = "noopener";
      
      // Prova anche con download attribute (funziona su alcuni browser)
      const filename = currentPhotoUrl.split("/").pop();
      a.download = filename;
      
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      
      // Chiudi il lightbox dopo un breve delay
      setTimeout(() => {
        closeLightbox();
      }, 300);
    }

    // Event listeners per lightbox
    lightboxClose.addEventListener("click", closeLightbox);
    lightboxSave.addEventListener("click", saveToGallery);
    
    // Chiudi con ESC
    document.addEventListener("keydown", (e) => {
      if(e.key === "Escape" && lightbox.classList.contains("active")){
        closeLightbox();
      }
    });
    
    // Chiudi cliccando sullo sfondo (ma non sull'immagine)
    lightbox.addEventListener("click", (e) => {
      if(e.target === lightbox){
        closeLightbox();
      }
    });

    async function matchSelfie(blob){
      setStatus("Cerco le tue foto...");
      clearResults();
      shootBtn.disabled = true;
      bottomShootBtn.disabled = true;

      try{
        const url = API_MATCH + "?top_k_faces=" + encodeURIComponent(TOP_K) + "&min_score=" + encodeURIComponent(MIN_SCORE);

        const fd = new FormData();
        fd.append("selfie", blob, "selfie.jpg");

        const res = await fetch(url, { method:"POST", body: fd });
        
        if(!res.ok){
          const errorData = await res.json().catch(()=>({}));
          console.error("API error", res.status, errorData);
          setStatus("Errore server. Riprova tra poco.");
          shootBtn.disabled = false;
          bottomShootBtn.disabled = false;
          return;
        }

        const data = await res.json().catch(()=>null);
        if(!data || data.ok !== true){
          console.error("API error", res.status, data);
          setStatus("Errore server. Riprova tra poco.");
          shootBtn.disabled = false;
          bottomShootBtn.disabled = false;
          return;
        }

        const results = data.matches || data.results || [];
        const count = data.count || results.length;

        if(!results.length){
          setStatus("Nessuna foto trovata. Prova con pi√π luce e guarda la camera.");
          shootBtn.disabled = false;
          bottomShootBtn.disabled = false;
          return;
        }

        setStatus("Trovate " + count + " foto.");
        resultsEl.style.display = "block";
        if (resultsPlaceholder) {
          resultsPlaceholder.style.display = "none";
        }

        results.forEach(r => addPhotoCard(r.photo_id, r.score));
        
        // Scroll automatico ai risultati su mobile
        setTimeout(() => {
          resultsEl.scrollIntoView({ behavior: "smooth", block: "start" });
        }, 100);

        shootBtn.disabled = false;
        bottomShootBtn.disabled = false;
      }catch(err){
        console.error(err);
        setStatus("Errore di rete. Riprova.");
        shootBtn.disabled = false;
        bottomShootBtn.disabled = false;
      }
    }

    // --- EVENTS ---
    async function handleShoot(){
      const blob = await captureBlob();
      if(!blob){
        setStatus("Aspetta 1 secondo: la camera si sta avviando.");
        return;
      }
      await matchSelfie(blob);
    }

    shootBtn.addEventListener("click", handleShoot);
    bottomShootBtn.addEventListener("click", handleShoot);

    switchBtn.addEventListener("click", async ()=>{
      useFront = !useFront;
      clearResults();
      await startCamera();
    });

    retryBtn.addEventListener("click", async ()=>{
      clearResults();
      await startCamera();
    });

    // --- BOOT ---
    window.addEventListener("load", async ()=>{
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
        setStatus("Questo browser non supporta la camera.");
        shootBtn.disabled = true;
        bottomShootBtn.disabled = true;
        return;
      }
      await startCamera();
    });
  </script>
</body>
</html>
