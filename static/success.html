<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Payment completed</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #7b74ff 0%, #5f58ff 100%);
            color: #fff;
            min-height: 100vh;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            text-align: center;
            padding: 40px 20px 30px;
        }
        .success-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }
        h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        .subtitle {
            font-size: 18px;
            opacity: 0.9;
            margin-bottom: 30px;
        }
        .loading {
            text-align: center;
            padding: 60px 20px;
            font-size: 18px;
        }
        .error {
            text-align: center;
            padding: 60px 20px;
            background: rgba(255, 0, 0, 0.2);
            border-radius: 12px;
            margin: 20px;
        }
        .photos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            padding: 20px 0;
        }
        .photo-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            position: relative;
        }
        .photo-img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            max-height: 300px;
            object-fit: contain;
            background: rgba(0, 0, 0, 0.2);
            cursor: pointer;
            -webkit-touch-callout: default;
            -webkit-user-select: none;
            user-select: none;
        }
        .photo-actions {
            display: flex;
            gap: 10px;
            width: 100%;
        }
        .btn-open, .btn-download {
            flex: 1;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, opacity 0.2s;
        }
        .btn-open {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }
        .btn-download {
            background: rgba(255, 255, 255, 0.9);
            color: #5f58ff;
        }
        .btn-open:active, .btn-download:active {
            transform: scale(0.95);
            opacity: 0.8;
        }
        .btn-download-desktop {
            display: none;
        }
        @media (min-width: 768px) {
            .btn-download-desktop {
                display: block;
            }
        }
        .back-button {
            display: block;
            width: 100%;
            max-width: 400px;
            margin: 40px auto;
            padding: 16px 24px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        .photo-viewer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .photo-viewer.active {
            display: flex;
        }
        .photo-viewer img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            -webkit-touch-callout: default;
        }
        .photo-viewer-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="success-icon">âœ…</div>
            <h1 id="successTitle">Payment completed</h1>
            <p class="subtitle" id="successSubtitle">Your photos are ready to download</p>
        </div>
        
        <div id="loading" class="loading">Loading your photos...</div>
        <div id="error" class="error" style="display: none;"></div>
        
        <div id="photosContainer" style="display: none;">
            <div class="photos-grid" id="photosGrid"></div>
            <a href="/" class="back-button" id="backButton">Back to photos</a>
        </div>
    </div>
    
    <div class="photo-viewer" id="photoViewer">
        <button class="photo-viewer-close" id="viewerClose">Ã—</button>
        <img id="viewerImage" src="" alt="Photo">
    </div>
    
    <script>
        // I18N translations
        const I18N = {
            en: {
                success_title: "Payment completed",
                success_subtitle: "Your photos are ready to download",
                loading_photos: "Loading your photos...",
                error_loading: "Error loading photos. Please try again.",
                btn_open: "Open",
                btn_download: "Download",
                btn_back: "Back to photos",
                btn_buy_more: "Buy more photos"
            },
            it: {
                success_title: "Pagamento completato",
                success_subtitle: "Le tue foto sono pronte per il download",
                loading_photos: "Caricamento delle tue foto...",
                error_loading: "Errore nel caricamento delle foto. Riprova.",
                btn_open: "Apri",
                btn_download: "Scarica",
                btn_back: "Torna alle foto",
                btn_buy_more: "Acquista altre foto"
            },
            es: {
                success_title: "Pago completado",
                success_subtitle: "Tus fotos estÃ¡n listas para descargar",
                loading_photos: "Cargando tus fotos...",
                error_loading: "Error al cargar las fotos. IntÃ©ntalo de nuevo.",
                btn_open: "Abrir",
                btn_download: "Descargar",
                btn_back: "Volver a las fotos",
                btn_buy_more: "Comprar mÃ¡s fotos"
            },
            fr: {
                success_title: "Paiement terminÃ©",
                success_subtitle: "Vos photos sont prÃªtes Ã  tÃ©lÃ©charger",
                loading_photos: "Chargement de vos photos...",
                error_loading: "Erreur lors du chargement des photos. RÃ©essayez.",
                btn_open: "Ouvrir",
                btn_download: "TÃ©lÃ©charger",
                btn_back: "Retour aux photos",
                btn_buy_more: "Acheter plus de photos"
            },
            de: {
                success_title: "Zahlung abgeschlossen",
                success_subtitle: "Ihre Fotos sind zum Download bereit",
                loading_photos: "Lade Ihre Fotos...",
                error_loading: "Fehler beim Laden der Fotos. Bitte versuchen Sie es erneut.",
                btn_open: "Ã–ffnen",
                btn_download: "Herunterladen",
                btn_back: "ZurÃ¼ck zu den Fotos",
                btn_buy_more: "Mehr Fotos kaufen"
            },
            nl: {
                success_title: "Betaling voltooid",
                success_subtitle: "Uw foto's zijn klaar om te downloaden",
                loading_photos: "Uw foto's laden...",
                error_loading: "Fout bij het laden van de foto's. Probeer het opnieuw.",
                btn_open: "Openen",
                btn_download: "Downloaden",
                btn_back: "Terug naar foto's",
                btn_buy_more: "Meer foto's kopen"
            }
        };
        
        // Detect language from URL or localStorage
        function getLanguage() {
            const urlParams = new URLSearchParams(window.location.search);
            const lang = urlParams.get('lang') || localStorage.getItem('selectedLanguage') || 'en';
            return I18N[lang] ? lang : 'en';
        }
        
        function t(key) {
            const lang = getLanguage();
            return I18N[lang]?.[key] || I18N.en[key] || key;
        }
        
        // Detect if we're in DEV mode (localhost)
        function isDevMode() {
            const hostname = window.location.hostname;
            return hostname === 'localhost' || hostname === '127.0.0.1' || hostname === '0.0.0.0';
        }
        
        // Detect if we're in DEV mode (localhost)
        function isDevMode() {
            const hostname = window.location.hostname;
            return hostname === 'localhost' || hostname === '127.0.0.1' || hostname === '0.0.0.0';
        }
        
        // Get session_id from URL
        function getSessionId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('session_id');
        }
        
        // Get purchase_token from localStorage
        function getPurchaseToken() {
            return localStorage.getItem('purchase_token');
        }
        
        // Save purchase_token to localStorage
        function savePurchaseToken(token) {
            if (token) {
                localStorage.setItem('purchase_token', token);
                console.log('[SUCCESS] Saved purchase_token to localStorage');
            }
        }
        
        // Load paid photos from /api/checkout/status
        async function loadPaidPhotos() {
            const sessionId = getSessionId();
            const purchaseToken = getPurchaseToken();
            const devMode = isDevMode();
            
            // In DEV mode, if no session_id and no purchase_token, use mock endpoint
            if (devMode && !sessionId && !purchaseToken) {
                try {
                    const res = await fetch('/dev/mock-success');
                    if (!res.ok) {
                        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                    }
                    
                    const data = await res.json();
                    if (!data.ok || (!data.photo_ids && !data.paid_photos)) {
                        showError('No photos found in mock data');
                        return;
                    }
                    
                    // Show dev mode indicator
                    showDevModeIndicator();
                    
                    // Store email globally
                    customerEmail = data.customer_email || null;
                    
                    // Use paid_photos if available, otherwise use photo_ids
                    const photoIds = data.paid_photos ? data.paid_photos.map(p => p.photo_id) : data.photo_ids;
                    renderPhotos(photoIds, customerEmail, null, null);
                    return;
                } catch (error) {
                    console.error('Error loading mock photos:', error);
                    showError('Error loading mock photos: ' + error.message);
                    return;
                }
            }
            
            // PROD mode or DEV with session_id/purchase_token: use /api/checkout/status
            if (!sessionId && !purchaseToken) {
                if (devMode) {
                    // In DEV, show button to load mock data
                    showDevModeIndicator();
                    return;
                } else {
                    // Migliora UX: mostra bottone "Torna alla home" quando manca token, senza sembrare un bug
                    const errorEl = document.getElementById('error');
                    if (errorEl) {
                        errorEl.innerHTML = `
                            <p style="margin-bottom: 20px;">Nessun ordine trovato.</p>
                            <a href="/" style="display: inline-block; padding: 12px 24px; background: #6366f1; color: #fff; text-decoration: none; border-radius: 8px; font-weight: 600;">Torna alla home</a>
                        `;
                        errorEl.style.display = 'block';
                    }
                    return;
                }
            }
            
            try {
                // Costruisci URL per /api/checkout/status
                let apiUrl = '/api/checkout/status?';
                if (sessionId) {
                    apiUrl += `session_id=${encodeURIComponent(sessionId)}`;
                }
                if (purchaseToken) {
                    if (sessionId) apiUrl += '&';
                    apiUrl += `purchase_token=${encodeURIComponent(purchaseToken)}`;
                }
                
                const res = await fetch(apiUrl);
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                
                const data = await res.json();
                console.log('[SUCCESS] /api/checkout/status response:', data);
                
                if (!data.ok) {
                    console.error('[SUCCESS] Response not ok:', data);
                    showError('Payment verification failed: ' + (data.detail || 'Unknown error'));
                    return;
                }
                
                if (!data.purchased_photo_ids || data.purchased_photo_ids.length === 0) {
                    console.warn('[SUCCESS] No purchased_photo_ids in response:', data);
                    showError('Nessuna foto acquistata trovata. Reindirizzamento alla galleria...');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                    return;
                }
                
                // Store email globally
                customerEmail = data.customer_email || null;
                
                // Salva purchase_token se session_id fornito (per persistenza)
                // Usa session_id come purchase_token se non c'Ã¨ un token dedicato
                if (sessionId) {
                    savePurchaseToken(sessionId);
                } else if (purchaseToken) {
                    // Mantieni il purchase_token esistente
                    savePurchaseToken(purchaseToken);
                }
                
                // Renderizza foto con unlocked_urls e remaining_photo_ids
                renderPhotos(
                    data.purchased_photo_ids, 
                    customerEmail, 
                    data.unlocked_urls || {},
                    data.remaining_photo_ids || []
                );
            } catch (error) {
                console.error('Error loading paid photos:', error);
                showError(t('error_loading'));
            }
        }
        
        // Show dev mode indicator and mock button
        function showDevModeIndicator() {
            const header = document.querySelector('.header');
            if (!header) return;
            
            const devBanner = document.createElement('div');
            devBanner.id = 'devBanner';
            devBanner.style.cssText = 'background: rgba(255, 193, 7, 0.2); border: 2px solid rgba(255, 193, 7, 0.5); border-radius: 12px; padding: 15px; margin: 20px 0; text-align: center;';
            devBanner.innerHTML = `
                <p style="margin: 0 0 10px; font-weight: 600; font-size: 16px;">ðŸ§ª ModalitÃ  test</p>
                <button id="mockOrderBtn" style="padding: 10px 20px; background: rgba(255, 193, 7, 0.9); color: #000; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                    Simula ordine pagato
                </button>
            `;
            
            header.appendChild(devBanner);
            
            document.getElementById('mockOrderBtn').onclick = async () => {
                try {
                    document.getElementById('loading').style.display = 'block';
                    document.getElementById('error').style.display = 'none';
                    document.getElementById('photosContainer').style.display = 'none';
                    
                    const res = await fetch('/dev/mock-success');
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    
                    const data = await res.json();
                    if (!data.ok) throw new Error('Mock data error');
                    
                    customerEmail = data.customer_email || null;
                    const photoIds = data.paid_photos ? data.paid_photos.map(p => p.photo_id) : data.photo_ids;
                    renderPhotos(photoIds, customerEmail, null, null);
                } catch (error) {
                    console.error('Error loading mock:', error);
                    showError('Error loading mock: ' + error.message);
                }
            };
        }
        
        // Cache per foto full quality preloadate
        const fullQualityCache = new Map();
        
        // Preload full quality in background
        function preloadFullQuality(url, photoId) {
            if (fullQualityCache.has(photoId)) {
                return; // GiÃ  in cache
            }
            
            // Marca come in caricamento
            fullQualityCache.set(photoId, { status: 'loading', url });
            
            const img = new Image();
            img.onload = () => {
                fullQualityCache.set(photoId, { status: 'ready', url, img });
                console.log(`[SUCCESS] Preloaded full quality: ${photoId}`);
            };
            img.onerror = () => {
                fullQualityCache.set(photoId, { status: 'error', url });
                console.warn(`[SUCCESS] Preload failed for ${photoId}`);
            };
            img.src = url;
        }
        
        // Render photos grid with aggressive preloading
        function renderPhotos(photoIds, email, unlockedUrls, remainingPhotoIds) {
            const grid = document.getElementById('photosGrid');
            grid.innerHTML = '';
            
            photoIds.forEach((photoId, index) => {
                // URL per full quality (per download/viewer)
                const fullQualityUrl = unlockedUrls && unlockedUrls[photoId] 
                    ? unlockedUrls[photoId]
                    : (email 
                        ? `/photo/${encodeURIComponent(photoId)}?paid=true&email=${encodeURIComponent(email)}`
                        : `/photo/${encodeURIComponent(photoId)}?paid=true`);
                
                // URL per thumbnail (caricamento veloce iniziale)
                const thumbUrl = `/photo/${encodeURIComponent(photoId)}?variant=thumb`;
                
                const photoItem = document.createElement('div');
                photoItem.className = 'photo-item';
                
                const img = document.createElement('img');
                img.alt = 'Photo';
                img.className = 'photo-img';
                img.dataset.photoId = photoId;
                img.dataset.fullUrl = fullQualityUrl;
                img.dataset.index = index;
                
                // IMPORTANTE: Safari mobile ha problemi con immagini molto grandi (20MB)
                // Carica SEMPRE thumb prima, mai full quality direttamente per la visualizzazione
                const wmUrl = `/photo/${encodeURIComponent(photoId)}?variant=wm`;
                
                // Carica thumbnail immediatamente (piÃ¹ piccolo, veloce)
                img.src = thumbUrl;
                
                // Safari mobile: usa loading solo se supportato
                if ('loading' in HTMLImageElement.prototype) {
                    img.loading = index < 6 ? 'eager' : 'lazy';
                }
                
                // fetchPriority supportato solo su browser moderni
                if (index < 6 && 'fetchPriority' in HTMLImageElement.prototype) {
                    try {
                        img.fetchPriority = 'high';
                    } catch (e) {
                        // Ignora se non supportato
                    }
                }
                
                // Preload full quality in background per tutte le foto visibili
                // Fallback per Safari che potrebbe non supportare IntersectionObserver
                if ('IntersectionObserver' in window) {
                    const observer = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                // Foto visibile: preload full quality in background
                                preloadFullQuality(fullQualityUrl, photoId);
                                observer.unobserve(entry.target);
                            }
                        });
                    }, { rootMargin: '200px' }); // Inizia preload 200px prima che entri nel viewport
                    
                    observer.observe(img);
                } else {
                    // Fallback: preload tutte le foto visibili immediatamente (Safari vecchio)
                    if (index < 12) {
                        preloadFullQuality(fullQualityUrl, photoId);
                    }
                }
                
                // Preload immediato per le prime 6 foto
                if (index < 6) {
                    preloadFullQuality(fullQualityUrl, photoId);
                }
                
                // Gestisci errori con fallback progressivo (thumb -> wm -> full quality)
                let retryCount = 0;
                const maxRetries = 5;
                img.onerror = function() {
                    retryCount++;
                    console.warn(`[SUCCESS] Error loading image for ${photoId}, retry ${retryCount}/${maxRetries}, current src: ${this.src}`);
                    
                    if (retryCount === 1) {
                        // Primo retry: prova thumb di nuovo
                        setTimeout(() => {
                            this.src = thumbUrl;
                        }, 300);
                    } else if (retryCount === 2) {
                        // Secondo retry: prova wm (watermarked, piÃ¹ piccolo di full quality)
                        console.log(`[SUCCESS] Trying WM for ${photoId}`);
                        setTimeout(() => {
                            this.src = wmUrl;
                        }, 300);
                    } else if (retryCount <= maxRetries) {
                        // Altri retry: alterna tra thumb e wm
                        const nextUrl = retryCount % 2 === 0 ? thumbUrl : wmUrl;
                        setTimeout(() => {
                            this.src = nextUrl;
                        }, 300 * retryCount);
                    } else {
                        // Ultimo tentativo: prova full quality (ma Safari potrebbe non renderizzarla)
                        console.warn(`[SUCCESS] All retries failed, trying full quality for ${photoId} (Safari might not render large images)`);
                        this.src = fullQualityUrl;
                        // Se anche questo fallisce, mostra errore
                        this.onerror = function() {
                            this.style.opacity = '0.5';
                            this.style.background = 'rgba(255,0,0,0.1)';
                            console.error(`[SUCCESS] Failed to load ${photoId} after all retries`);
                        };
                    }
                };
                
                // Log caricamento riuscito (per debug Safari)
                img.onload = function() {
                    console.log(`[SUCCESS] Loaded image for ${photoId}, size: ${this.naturalWidth}x${this.naturalHeight}`);
                };
                
                img.onclick = () => {
                    // Apri viewer immediatamente con thumb, poi sostituisci con full quality
                    openPhotoViewer(fullQualityUrl, photoId, thumbUrl);
                };
                
                const actions = document.createElement('div');
                actions.className = 'photo-actions';
                
                const btnOpen = document.createElement('button');
                btnOpen.className = 'btn-open';
                btnOpen.textContent = t('btn_open');
                btnOpen.onclick = () => {
                    // Apri viewer immediatamente
                    openPhotoViewer(fullQualityUrl, photoId, thumbUrl);
                };
                
                const btnDownload = document.createElement('button');
                btnDownload.className = 'btn-download btn-download-desktop';
                btnDownload.textContent = t('btn_download');
                btnDownload.onclick = () => {
                    // Download immediato senza aspettare
                    downloadPhotoInstant(fullQualityUrl, photoId);
                };
                
                actions.appendChild(btnOpen);
                actions.appendChild(btnDownload);
                
                photoItem.appendChild(img);
                photoItem.appendChild(actions);
                grid.appendChild(photoItem);
            });
            
            // Update translations
            document.getElementById('successTitle').textContent = t('success_title');
            document.getElementById('successSubtitle').textContent = t('success_subtitle');
            const backButton = document.getElementById('backButton');
            backButton.textContent = t('btn_back');
            
            // Update back button URL with email if available
            if (email) {
                backButton.href = `/?email=${encodeURIComponent(email)}&view_album=true`;
            } else {
                backButton.href = '/';
            }
            
            // Se ci sono remaining_photo_ids, aggiungi bottone "Acquista altre foto"
            if (remainingPhotoIds && remainingPhotoIds.length > 0) {
                // Rimuovi eventuale bottone esistente
                const existingBuyMore = document.getElementById('buyMoreBtn');
                if (existingBuyMore) {
                    existingBuyMore.remove();
                }
                
                const buyMoreBtn = document.createElement('a');
                buyMoreBtn.id = 'buyMoreBtn';
                buyMoreBtn.href = '#';
                buyMoreBtn.className = 'back-button';
                buyMoreBtn.style.cssText = 'background: rgba(255, 255, 255, 0.9); color: #5f58ff; margin-top: 20px;';
                buyMoreBtn.textContent = t('btn_buy_more') || `Acquista altre ${remainingPhotoIds.length} foto`;
                buyMoreBtn.onclick = (e) => {
                    e.preventDefault();
                    // Salva remaining_photo_ids in sessionStorage per la pagina principale
                    sessionStorage.setItem('remaining_photo_ids', JSON.stringify(remainingPhotoIds));
                    window.location.href = '/';
                };
                
                const container = document.getElementById('photosContainer');
                if (container) {
                    // Inserisci prima del back button
                    container.insertBefore(buyMoreBtn, backButton);
                }
            }
            
            // Show photos container
            document.getElementById('loading').style.display = 'none';
            document.getElementById('photosContainer').style.display = 'block';
        }
        
        // Open photo in viewer (instant: show thumb first, then full quality)
        function openPhotoViewer(photoUrl, photoId, thumbUrl) {
            const viewer = document.getElementById('photoViewer');
            const viewerImage = document.getElementById('viewerImage');
            const openUrl = photoUrl.replace(/[?&]download=true/, '').replace(/&download=true/, '');
            
            // Mostra subito la thumb se disponibile (istantaneo)
            if (thumbUrl) {
                viewerImage.src = thumbUrl;
                viewer.classList.add('active');
            } else {
                viewerImage.src = openUrl;
                viewer.classList.add('active');
            }
            
            // Controlla se full quality Ã¨ giÃ  in cache
            const cached = fullQualityCache.get(photoId);
            if (cached && cached.status === 'ready' && cached.img) {
                // Usa immagine giÃ  caricata (istantaneo)
                viewerImage.src = cached.img.src;
            } else {
                // Carica full quality in background e sostituisci quando pronta
                const fullImg = new Image();
                fullImg.onload = () => {
                    viewerImage.src = fullImg.src;
                };
                fullImg.onerror = () => {
                    console.warn(`[SUCCESS] Full quality failed in viewer for ${photoId}`);
                };
                fullImg.src = openUrl;
            }
        }
        
        // Close photo viewer
        document.getElementById('viewerClose').onclick = () => {
            document.getElementById('photoViewer').classList.remove('active');
        };
        
        // Download photo instant (SEMPRE full quality originale dal server)
        async function downloadPhotoInstant(photoUrl, photoId) {
            try {
                // IMPORTANTE: sempre scarica full quality originale dal server
                // Non usare la cache perchÃ© potrebbe degradare la qualitÃ  JPEG
                const downloadUrl = photoUrl.includes('?') 
                    ? `${photoUrl}&download=true`
                    : `${photoUrl}?download=true`;
                
                // Usa link diretto per download immediato (browser gestisce il download)
                // Il download inizia subito, anche se il file Ã¨ grande
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = photoId.split('/').pop() || `photo_${photoId}.jpg`;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // In background, continua preload per visualizzazione veloce
                const cached = fullQualityCache.get(photoId);
                if (!cached || cached.status !== 'loading') {
                    preloadFullQuality(photoUrl.replace(/[?&]download=true/, ''), photoId);
                }
            } catch (error) {
                console.error('Download error:', error);
                alert('Error downloading photo. Please try again.');
            }
        }
        
        // Show error
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            const errorEl = document.getElementById('error');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
        }
        
        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            loadPaidPhotos();
        });
    </script>
    
    <!-- BUILD ID Badge (NASCOSTO) -->
    <div id="buildIdBadge" style="display: none; position: fixed; bottom: 8px; left: 8px; background: rgba(0,0,0,0.8); color: #0f0; font-family: monospace; font-size: 10px; padding: 4px 8px; border-radius: 4px; z-index: 99998; border: 1px solid #0f0;">
        BUILD: 2026-01-23-<span id="buildRandom">a1b2c3</span>
    </div>
    
    <script>
        // Genera random 6 caratteri per BUILD ID
        (function() {
            const chars = '0123456789abcdef';
            let random = '';
            for (let i = 0; i < 6; i++) {
                random += chars[Math.floor(Math.random() * chars.length)];
            }
            const badge = document.getElementById('buildIdBadge');
            if (badge) {
                const span = badge.querySelector('#buildRandom');
                if (span) span.textContent = random;
            }
        })();
    </script>
</body>
</html>
