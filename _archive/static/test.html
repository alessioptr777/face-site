<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test FaceSite</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #0a0e27;
            color: white;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: #6366f1;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .test-section {
            background: #1a1f3a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #2d3250;
        }
        
        .test-section h2 {
            color: #818cf8;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .test-result {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 500;
        }
        
        .test-result.success {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid #22c55e;
            color: #22c55e;
        }
        
        .test-result.error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            color: #ef4444;
        }
        
        .test-result.pending {
            background: rgba(251, 191, 36, 0.2);
            border: 1px solid #fbbf24;
            color: #fbbf24;
        }
        
        button {
            background: #6366f1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin: 5px;
        }
        
        button:hover {
            background: #818cf8;
        }
        
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .photo-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            background: #2d3250;
            aspect-ratio: 1;
        }
        
        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .photo-name {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            color: white;
            padding: 8px;
            font-size: 11px;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        code {
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test FaceSite</h1>
        
        <!-- Test 1: Endpoint photos-by-date -->
        <div class="test-section">
            <h2>1. Test Endpoint /admin/photos-by-date</h2>
            <button onclick="testPhotosByDate()">Test Endpoint</button>
            <div id="test1-result"></div>
        </div>
        
        <!-- Test 2: Visualizzazione foto con nomi -->
        <div class="test-section">
            <h2>2. Test Visualizzazione Foto con Nomi</h2>
            <button onclick="testPhotoDisplay()">Carica Foto</button>
            <div id="test2-result"></div>
            <div id="photo-grid" class="photo-grid"></div>
        </div>
        
        <!-- Test 3: Caricamento immagini -->
        <div class="test-section">
            <h2>3. Test Caricamento Immagini</h2>
            <button onclick="testImageLoading()">Test Caricamento</button>
            <div id="test3-result"></div>
        </div>
        
        <!-- Test 4: Admin Panel -->
        <div class="test-section">
            <h2>4. Test Admin Panel</h2>
            <button onclick="testAdminPanel()">Test Admin</button>
            <div id="test4-result"></div>
        </div>
    </div>
    
    <script>
        const ADMIN_PASSWORD = 'admin123';
        
        async function testPhotosByDate() {
            const resultDiv = document.getElementById('test1-result');
            resultDiv.innerHTML = '<div class="test-result pending">‚è≥ Test in corso...</div>';
            
            try {
                const res = await fetch(`/admin/photos-by-date?password=${encodeURIComponent(ADMIN_PASSWORD)}`);
                const data = await res.json();
                
                if(data.ok && data.photos_by_date) {
                    const totalPhotos = data.photos_by_date.reduce((sum, item) => sum + item.count, 0);
                    resultDiv.innerHTML = `
                        <div class="test-result success">
                            ‚úÖ Endpoint funzionante!<br>
                            Date trovate: <code>${data.photos_by_date.length}</code><br>
                            Foto totali: <code>${totalPhotos}</code>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = '<div class="test-result error">‚ùå Endpoint non ha restituito dati validi</div>';
                }
            } catch(e) {
                resultDiv.innerHTML = `<div class="test-result error">‚ùå Errore: ${e.message}</div>`;
            }
        }
        
        async function testPhotoDisplay() {
            const resultDiv = document.getElementById('test2-result');
            const gridDiv = document.getElementById('photo-grid');
            resultDiv.innerHTML = '<div class="test-result pending">‚è≥ Caricamento foto...</div>';
            gridDiv.innerHTML = '';
            
            try {
                const res = await fetch(`/admin/photos-by-date?password=${encodeURIComponent(ADMIN_PASSWORD)}`);
                const data = await res.json();
                
                if(data.ok && data.photos_by_date && data.photos_by_date.length > 0) {
                    // Prendi la prima data con foto
                    const firstDate = data.photos_by_date[0];
                    const photos = firstDate.photos.slice(0, 6); // Prime 6 foto
                    
                    let loaded = 0;
                    let errors = 0;
                    
                    photos.forEach(photo => {
                        const photoItem = document.createElement('div');
                        photoItem.className = 'photo-item';
                        
                        const img = document.createElement('img');
                        img.src = `/photos/${encodeURIComponent(photo.photo_id)}`;
                        img.alt = photo.photo_id;
                        img.onload = () => {
                            loaded++;
                            updateTest2Result(loaded, errors, photos.length);
                        };
                        img.onerror = () => {
                            errors++;
                            photoItem.style.border = '2px solid #ef4444';
                            updateTest2Result(loaded, errors, photos.length);
                        };
                        
                        const photoName = document.createElement('div');
                        photoName.className = 'photo-name';
                        photoName.textContent = photo.photo_id;
                        
                        photoItem.appendChild(img);
                        photoItem.appendChild(photoName);
                        gridDiv.appendChild(photoItem);
                    });
                    
                    resultDiv.innerHTML = `<div class="test-result pending">‚è≥ Caricamento ${photos.length} foto...</div>`;
                } else {
                    resultDiv.innerHTML = '<div class="test-result error">‚ùå Nessuna foto trovata</div>';
                }
            } catch(e) {
                resultDiv.innerHTML = `<div class="test-result error">‚ùå Errore: ${e.message}</div>`;
            }
        }
        
        function updateTest2Result(loaded, errors, total) {
            const resultDiv = document.getElementById('test2-result');
            if(loaded + errors >= total) {
                if(errors === 0) {
                    resultDiv.innerHTML = `<div class="test-result success">‚úÖ Tutte le ${total} foto caricate correttamente con nomi visibili!</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="test-result error">‚ö†Ô∏è ${loaded} caricate, ${errors} errori su ${total} foto</div>`;
                }
            } else {
                resultDiv.innerHTML = `<div class="test-result pending">‚è≥ Caricate: ${loaded}/${total} (errori: ${errors})</div>`;
            }
        }
        
        async function testImageLoading() {
            const resultDiv = document.getElementById('test3-result');
            resultDiv.innerHTML = '<div class="test-result pending">‚è≥ Test caricamento immagini...</div>';
            
            try {
                const res = await fetch(`/admin/photos-by-date?password=${encodeURIComponent(ADMIN_PASSWORD)}`);
                const data = await res.json();
                
                if(data.ok && data.photos_by_date && data.photos_by_date.length > 0) {
                    const firstDate = data.photos_by_date[0];
                    if(firstDate.photos.length > 0) {
                        const testPhoto = firstDate.photos[0];
                        const img = new Image();
                        
                        img.onload = () => {
                            resultDiv.innerHTML = `
                                <div class="test-result success">
                                    ‚úÖ Immagine caricata correttamente!<br>
                                    Foto: <code>${testPhoto.photo_id}</code><br>
                                    Dimensioni: <code>${img.width}x${img.height}</code>
                                </div>
                            `;
                        };
                        
                        img.onerror = () => {
                            resultDiv.innerHTML = `<div class="test-result error">‚ùå Errore caricamento immagine: ${testPhoto.photo_id}</div>`;
                        };
                        
                        img.src = `/photos/${encodeURIComponent(testPhoto.photo_id)}`;
                    } else {
                        resultDiv.innerHTML = '<div class="test-result error">‚ùå Nessuna foto disponibile per il test</div>';
                    }
                } else {
                    resultDiv.innerHTML = '<div class="test-result error">‚ùå Nessun dato disponibile</div>';
                }
            } catch(e) {
                resultDiv.innerHTML = `<div class="test-result error">‚ùå Errore: ${e.message}</div>`;
            }
        }
        
        async function testAdminPanel() {
            const resultDiv = document.getElementById('test4-result');
            resultDiv.innerHTML = '<div class="test-result pending">‚è≥ Test admin panel...</div>';
            
            try {
                const res = await fetch('/admin');
                if(res.ok) {
                    const html = await res.text();
                    const hasDateSelector = html.includes('dateSelector');
                    const hasPhotosGrid = html.includes('photosGrid');
                    const hasLoadFunction = html.includes('loadPhotosByDate');
                    
                    if(hasDateSelector && hasPhotosGrid && hasLoadFunction) {
                        resultDiv.innerHTML = `
                            <div class="test-result success">
                                ‚úÖ Admin Panel OK!<br>
                                Selettore data: <code>${hasDateSelector ? '‚úÖ' : '‚ùå'}</code><br>
                                Griglia foto: <code>${hasPhotosGrid ? '‚úÖ' : '‚ùå'}</code><br>
                                Funzione load: <code>${hasLoadFunction ? '‚úÖ' : '‚ùå'}</code>
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML = `<div class="test-result error">‚ùå Elementi mancanti nell'admin panel</div>`;
                    }
                } else {
                    resultDiv.innerHTML = '<div class="test-result error">‚ùå Admin panel non raggiungibile</div>';
                }
            } catch(e) {
                resultDiv.innerHTML = `<div class="test-result error">‚ùå Errore: ${e.message}</div>`;
            }
        }
        
        // Esegui test automatici all'apertura
        window.addEventListener('load', () => {
            setTimeout(() => {
                testPhotosByDate();
                testAdminPanel();
            }, 500);
        });
    </script>
</body>
</html>

