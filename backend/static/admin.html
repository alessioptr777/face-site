<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Admin Panel - FaceSite</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }
        
        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }
        
        .tab:hover {
            color: #667eea;
        }
        
        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 32px;
            margin-bottom: 5px;
        }
        
        .stat-card p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .stat-card.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .stat-card.warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .stat-card.info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-success {
            background: #22c55e;
            color: white;
        }
        
        .btn-success:hover {
            background: #1eaf55;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }
        
        .upload-area.dragover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .file-label {
            display: inline-block;
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .file-label:hover {
            background: #5568d3;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e5e7eb;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
            display: none;
        }
        
        .progress-fill {
            height: 100%;
            background: #667eea;
            width: 0%;
            transition: width 0.3s;
        }
        
        .alert {
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            display: none;
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }
        
        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        
        .login-form {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .login-form input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        
        .back-photos-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .back-photo-item {
            position: relative;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .back-photo-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        
        .back-photo-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 18px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- DEBUG: Se vedi questo, la pagina si √® caricata -->
    <div style="position: fixed; top: 0; left: 0; right: 0; background: #4CAF50; color: white; padding: 10px; text-align: center; z-index: 10000; font-weight: bold;">
        ‚úÖ PAGINA CARICATA - Se vedi questo, il file HTML funziona
    </div>
    
    <div class="header">
        <h1>üîê Admin Panel</h1>
        <p>Gestione FaceSite</p>
    </div>
    
    <div id="loginScreen" class="login-form">
        <h2>Accesso Admin</h2>
        <input type="password" id="adminPassword" placeholder="Password admin" />
        <button class="btn btn-primary" onclick="login()" style="width: 100%; margin-top: 10px;">Accedi</button>
        <div id="loginError" class="alert alert-error"></div>
    </div>
    
    <div id="adminPanel" style="display: none;">
        <div class="container">
            <div class="tabs">
                <button class="tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
                <button class="tab" onclick="showTab('orders')">üí≥ Ordini</button>
                <button class="tab" onclick="showTab('sales')">üìà Analisi Vendite</button>
                <button class="tab" onclick="showTab('upload')">üì§ Carica Foto</button>
                <button class="tab" onclick="showTab('backPhotos')">üì∑ Foto di Spalle</button>
            </div>
            
            <!-- Dashboard -->
            <div id="dashboard" class="tab-content active">
                <h2>Dashboard</h2>
                <div class="stats-grid" id="statsGrid" style="grid-template-columns: repeat(2, 1fr); max-width: 600px;">
                    <div class="stat-card success">
                        <h3 id="totalRevenue">-</h3>
                        <p>Ricavi Totali</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="totalOrders">-</h3>
                        <p>Ordini Totali</p>
                    </div>
                </div>
            </div>
            
            <!-- Ordini -->
            <div id="orders" class="tab-content">
                <h2>Ordini e Pagamenti</h2>
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="fixAllOrders()">üîÑ Aggiorna Tutti gli Ordini (Marca Foto come Pagate)</button>
                    <p style="margin-top: 10px; color: #666; font-size: 14px;">Questo marcher√† tutte le foto negli ordini esistenti come pagate nella tabella user_photos. Usa questo per sincronizzare gli ordini con lo stato delle foto.</p>
                </div>
                <div id="fixOrdersResult" style="margin-bottom: 20px;"></div>
                <div id="ordersList" class="loading">Caricamento...</div>
            </div>
            
            <!-- Sales Analysis -->
            <div id="sales" class="tab-content">
                <h2>üìà Analisi Vendite</h2>
                
                <!-- Suggestions - PRIMA, pi√π visibili -->
                <div id="salesSuggestions" style="margin-bottom: 30px;"></div>
                
                <!-- Top 3 Pacchetti -->
                <h3 style="margin-top: 20px;">Top 3 Pacchetti Pi√π Venduti</h3>
                <div id="topPackages" class="loading">Caricamento...</div>
                
                <!-- Trend Mensile - Nascosto di default, mostrato su richiesta -->
                <details style="margin-top: 30px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <summary style="cursor: pointer; font-weight: 600; font-size: 16px; color: #667eea;">üìÖ Vedi Trend Mensile (Ultimi 12 Mesi)</summary>
                    <div id="monthlyTrend" class="loading" style="margin-top: 15px;">Caricamento...</div>
                </details>
            </div>
            
            <!-- Upload Foto -->
            <div id="upload" class="tab-content">
                <h2>Upload e Indicizzazione Foto</h2>
                <p>Carica le foto che vuoi vendere. Verranno automaticamente indicizzate per il face matching.</p>
                
                <!-- Selettore Data -->
                <div style="margin-bottom: 30px; padding: 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 250px;">
                            <label for="dateSelector" style="display: block; margin-bottom: 10px; font-weight: 700; font-size: 16px; color: white;">üìÖ Seleziona Data del Tour:</label>
                            <select id="dateSelector" style="width: 100%; padding: 12px; border: 2px solid white; border-radius: 8px; font-size: 16px; background: white; color: #333; font-weight: 600; cursor: pointer;">
                                <option value="">-- Seleziona una data --</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 250px;">
                            <label for="tourDateInput" style="display: block; margin-bottom: 10px; font-weight: 700; font-size: 16px; color: white;">üìÖ Oppure inserisci nuova data:</label>
                            <input type="date" id="tourDateInput" style="width: 100%; padding: 12px; border: 2px solid white; border-radius: 8px; font-size: 16px; background: white; color: #333; font-weight: 600;" />
                        </div>
                    </div>
                    <p style="margin-top: 15px; font-size: 14px; color: rgba(255,255,255,0.9); font-weight: 500;">‚ö†Ô∏è <strong>IMPORTANTE:</strong> Seleziona o inserisci la data del tour prima di caricare le foto!</p>
                </div>
                
                <!-- Statistiche Data Selezionata -->
                <div id="dateStats" style="margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea; display: none;">
                    <h3 style="margin: 0 0 10px 0; color: #333; font-size: 18px;">üìä Foto caricate per questa data: <span id="photoCount">0</span> foto</h3>
                </div>
                
                <!-- Griglia Foto per Data Selezionata -->
                <div id="photosGrid" style="margin-bottom: 30px; display: none;">
                    <h3 style="margin-bottom: 15px; color: #333; font-size: 18px;">üñºÔ∏è Foto gi√† caricate:</h3>
                    <div id="photosGridContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; max-height: 400px; overflow-y: auto; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                        <!-- Le foto verranno inserite qui dinamicamente -->
                    </div>
                </div>
                
                <!-- Area Upload -->
                <div style="margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px; color: #333; font-size: 18px;">üì§ Carica Nuove Foto:</h3>
                    <div class="upload-area" id="uploadArea" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        <p style="font-size: 18px; margin-bottom: 10px;">üìÅ Trascina le foto qui o</p>
                        <label for="photoUpload" class="file-label">Seleziona Foto</label>
                        <input type="file" id="photoUpload" multiple accept="image/*" onchange="handleFileSelect(event)" />
                    </div>
                </div>
                
                <div class="progress-bar" id="uploadProgress">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                
                <div id="uploadStatus" class="alert"></div>
                
                <div id="uploadedFiles" style="margin-top: 20px;"></div>
            </div>
            
            <!-- Foto Senza Volti -->
            <div id="backPhotos" class="tab-content">
                <h2>Foto Senza Volti (di Spalle)</h2>
                <p>Queste foto vengono escluse dal face matching perch√© non contengono volti.</p>
                
                <div class="upload-area" style="margin-bottom: 20px;">
                    <label for="backPhotoUpload" class="file-label">Aggiungi Foto Senza Volti</label>
                    <input type="file" id="backPhotoUpload" multiple accept="image/*" onchange="handleBackPhotoUpload(event)" />
                </div>
                
                <div id="backPhotosList" class="back-photos-list">
                    <div class="loading">Caricamento...</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Password admin - deve corrispondere a ADMIN_PASSWORD nel backend
        // In produzione, cambia questa password!
        const ADMIN_PASSWORD = 'admin123';
        let isAuthenticated = false;
        let adminPassword = null; // Password inserita dall'utente
        
        function login() {
            const password = document.getElementById('adminPassword').value;
            if(password === ADMIN_PASSWORD) {
                isAuthenticated = true;
                adminPassword = password; // Salva password per le chiamate API
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                loadDashboard();
            } else {
                document.getElementById('loginError').textContent = 'Password errata';
                document.getElementById('loginError').style.display = 'block';
            }
        }
        
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if(tabName === 'orders') loadOrders();
            if(tabName === 'sales') loadSalesAnalysis();
            if(tabName === 'backPhotos') loadBackPhotos();
            if(tabName === 'upload') loadPhotosByDate();
        }
        
        // Carica le date disponibili e popola il selettore
        async function loadPhotosByDate() {
            try {
                const res = await fetch(`/admin/photos-by-date?password=${encodeURIComponent(adminPassword)}`);
                const data = await res.json();
                
                if(data.ok && data.photos_by_date) {
                    const dateSelector = document.getElementById('dateSelector');
                    if(dateSelector) {
                        dateSelector.innerHTML = '<option value="">-- Seleziona una data --</option>';
                        
                        data.photos_by_date.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item.date;
                            option.textContent = `${item.date} (${item.count} foto)`;
                            dateSelector.appendChild(option);
                        });
                    }
                }
            } catch(e) {
                console.error('Error loading photos by date:', e);
            }
        }
        
        // Mostra le foto per la data selezionata
        async function showPhotosForDate(selectedDate) {
            if(!selectedDate || selectedDate === '') {
                const dateStats = document.getElementById('dateStats');
                const photosGrid = document.getElementById('photosGrid');
                if(dateStats) dateStats.style.display = 'none';
                if(photosGrid) photosGrid.style.display = 'none';
                return;
            }
            
            try {
                const res = await fetch(`/admin/photos-by-date?password=${encodeURIComponent(adminPassword)}`);
                const data = await res.json();
                
                if(data.ok && data.photos_by_date) {
                    const dateData = data.photos_by_date.find(item => item.date === selectedDate);
                    
                    if(dateData) {
                        // Mostra statistiche
                        const photoCount = document.getElementById('photoCount');
                        const dateStats = document.getElementById('dateStats');
                        if(photoCount) photoCount.textContent = dateData.count;
                        if(dateStats) dateStats.style.display = 'block';
                        
                        // Mostra griglia foto
                        const gridContainer = document.getElementById('photosGridContainer');
                        const photosGrid = document.getElementById('photosGrid');
                        
                        if(gridContainer) {
                            gridContainer.innerHTML = '';
                            
                            if(dateData.photos.length > 0) {
                                dateData.photos.forEach(photo => {
                                    const photoDiv = document.createElement('div');
                                    photoDiv.style.cssText = 'position: relative; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); background: white;';
                                    
                                    const img = document.createElement('img');
                                    img.src = `/photos/${encodeURIComponent(photo.photo_id)}`;
                                    img.style.cssText = 'width: 100%; height: 150px; object-fit: cover; display: block;';
                                    img.onerror = function() { this.style.display = 'none'; };
                                    
                                    const label = document.createElement('div');
                                    label.style.cssText = 'padding: 8px; font-size: 12px; color: #666; text-align: center; background: #f8f9fa;';
                                    label.textContent = photo.photo_id.length > 20 ? photo.photo_id.substring(0, 20) + '...' : photo.photo_id;
                                    
                                    photoDiv.appendChild(img);
                                    photoDiv.appendChild(label);
                                    gridContainer.appendChild(photoDiv);
                                });
                                
                                if(photosGrid) photosGrid.style.display = 'block';
                            } else {
                                if(photosGrid) photosGrid.style.display = 'none';
                            }
                        }
                    } else {
                        const dateStats = document.getElementById('dateStats');
                        const photosGrid = document.getElementById('photosGrid');
                        if(dateStats) dateStats.style.display = 'none';
                        if(photosGrid) photosGrid.style.display = 'none';
                    }
                }
            } catch(e) {
                console.error('Error showing photos for date:', e);
            }
        }
        
        async function loadDashboard() {
            try {
                const res = await fetch(`/admin/stats?password=${encodeURIComponent(adminPassword)}`);
                const data = await res.json();
                
                document.getElementById('totalOrders').textContent = data.total_orders || 0;
                document.getElementById('totalRevenue').textContent = '‚Ç¨' + ((data.total_revenue || 0) / 100).toFixed(2);
            } catch(e) {
                console.error('Error loading dashboard:', e);
            }
        }
        
        async function loadOrders() {
            try {
                const res = await fetch(`/admin/orders?password=${encodeURIComponent(adminPassword)}`);
                const data = await res.json();
                
                if(data.orders && data.orders.length > 0) {
                    let html = '<table><tr><th>Data</th><th>Email</th><th>Foto</th><th>Importo</th><th>Token</th></tr>';
                    data.orders.forEach(order => {
                        html += `<tr>
                            <td>${new Date(order.paid_at).toLocaleDateString('it-IT')}</td>
                            <td>${order.email}</td>
                            <td>${order.photo_count}</td>
                            <td>‚Ç¨${(order.amount_cents / 100).toFixed(2)}</td>
                            <td><code style="font-size: 11px;">${order.download_token.substring(0, 20)}...</code></td>
                        </tr>`;
                    });
                    html += '</table>';
                    document.getElementById('ordersList').innerHTML = html;
                } else {
                    document.getElementById('ordersList').innerHTML = '<p>Nessun ordine</p>';
                }
            } catch(e) {
                console.error('Error loading orders:', e);
                document.getElementById('ordersList').innerHTML = '<p class="alert alert-error">Errore nel caricamento ordini</p>';
            }
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }
        
        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }
        
        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            uploadPhotos(Array.from(files));
        }
        
        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            uploadPhotos(files);
        }
        
        async function uploadPhotos(files) {
            const progressBar = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('progressFill');
            const statusDiv = document.getElementById('uploadStatus');
            const uploadedDiv = document.getElementById('uploadedFiles');
            const tourDateInput = document.getElementById('tourDateInput');
            
            // Verifica che la data sia selezionata
            const tourDate = tourDateInput ? tourDateInput.value : null;
            if(!tourDate || tourDate.trim() === '') {
                statusDiv.className = 'alert alert-error';
                statusDiv.textContent = '‚ö†Ô∏è Seleziona prima la data del tour!';
                statusDiv.style.display = 'block';
                return;
            }
            
            progressBar.style.display = 'block';
            statusDiv.style.display = 'none';
            uploadedDiv.innerHTML = '';
            
            let uploaded = 0;
            const total = files.length;
            
            console.log(`Inizio upload di ${total} foto, data tour: ${tourDate}`);
            
            for(const file of files) {
                console.log(`Caricamento: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
                
                const formData = new FormData();
                formData.append('password', adminPassword);
                formData.append('photo', file);
                if(tourDate) {
                    formData.append('tour_date', tourDate);
                }
                
                try {
                    const res = await fetch('/admin/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    console.log(`Risposta server per ${file.name}:`, res.status, res.statusText);
                    
                    if(!res.ok) {
                        let errorText = '';
                        try {
                            errorText = await res.text();
                        } catch(e) {
                            errorText = 'Errore sconosciuto';
                        }
                        throw new Error(`Errore HTTP ${res.status}: ${errorText}`);
                    }
                    
                    const data = await res.json();
                    console.log(`Dati ricevuti per ${file.name}:`, data);
                    
                    uploaded++;
                    progressFill.style.width = (uploaded / total * 100) + '%';
                    
                    if(data.ok) {
                        uploadedDiv.innerHTML += `<p>‚úÖ ${file.name} - Indicizzata${tourDate ? ' (Data: ' + tourDate + ')' : ''}</p>`;
                    } else {
                        uploadedDiv.innerHTML += `<p>‚ùå ${file.name} - ${data.error || data.detail || 'Errore sconosciuto'}</p>`;
                    }
                } catch(e) {
                    console.error('Errore upload foto:', e);
                    uploadedDiv.innerHTML += `<p>‚ùå ${file.name} - Errore: ${e.message || 'Errore di caricamento'}</p>`;
                }
            }
            
            progressBar.style.display = 'none';
            statusDiv.className = 'alert alert-success';
            statusDiv.textContent = `Caricate ${uploaded} di ${total} foto`;
            statusDiv.style.display = 'block';
            
            // Ricarica le foto per la data selezionata
            const selectedDate = document.getElementById('dateSelector').value || document.getElementById('tourDateInput').value;
            if(selectedDate) {
                loadPhotosByDate();
                setTimeout(() => showPhotosForDate(selectedDate), 500);
            }
        }
        
        async function loadBackPhotos() {
            try {
                const res = await fetch(`/admin/back-photos?password=${encodeURIComponent(adminPassword)}`);
                const data = await res.json();
                
                if(data.photos && data.photos.length > 0) {
                    let html = '';
                    data.photos.forEach(photo => {
                        html += `<div class="back-photo-item">
                            <img src="/photo/${encodeURIComponent(photo.filename)}?paid=false" alt="${photo.filename}" />
                            <button class="remove-btn" onclick="removeBackPhoto('${photo.filename}')">√ó</button>
                        </div>`;
                    });
                    document.getElementById('backPhotosList').innerHTML = html;
                } else {
                    document.getElementById('backPhotosList').innerHTML = '<p>Nessuna foto senza volti</p>';
                }
            } catch(e) {
                console.error('Error loading back photos:', e);
            }
        }
        
        async function handleBackPhotoUpload(e) {
            const files = Array.from(e.target.files);
            const tourDateInput = document.getElementById('tourDateInput');
            const tourDate = tourDateInput ? tourDateInput.value : null;
            
            for(const file of files) {
                const formData = new FormData();
                formData.append('photo', file);
                formData.append('password', adminPassword);
                if(tourDate) {
                    formData.append('tour_date', tourDate);
                }
                
                try {
                    await fetch('/admin/back-photo', {
                        method: 'POST',
                        body: formData
                    });
                } catch(e) {
                    console.error('Error uploading back photo:', e);
                }
            }
            loadBackPhotos();
        }
        
        async function removeBackPhoto(filename) {
            if(!confirm(`Rimuovere ${filename} dalle foto senza volti?`)) return;
            
            try {
                await fetch(`/admin/back-photo/${encodeURIComponent(filename)}?password=${encodeURIComponent(adminPassword)}`, {
                    method: 'DELETE'
                });
                loadBackPhotos();
            } catch(e) {
                console.error('Error removing back photo:', e);
            }
        }
        
        // Enter key per login
        document.getElementById('adminPassword').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') login();
        });
        
        // Gestione selettore data e input date
        document.addEventListener('DOMContentLoaded', function() {
            const dateSelector = document.getElementById('dateSelector');
            const tourDateInput = document.getElementById('tourDateInput');
            
            if(dateSelector) {
                dateSelector.addEventListener('change', function() {
                    const selectedDate = this.value;
                    if(selectedDate) {
                        if(tourDateInput) tourDateInput.value = selectedDate;
                        showPhotosForDate(selectedDate);
                    }
                });
            }
            
            if(tourDateInput) {
                tourDateInput.addEventListener('change', function() {
                    const selectedDate = this.value;
                    if(selectedDate) {
                        // Aggiorna selettore se la data esiste
                        if(dateSelector) {
                            const option = Array.from(dateSelector.options).find(opt => opt.value === selectedDate);
                            if(option) {
                                dateSelector.value = selectedDate;
                            }
                        }
                        showPhotosForDate(selectedDate);
                    }
                });
            }
        });
        
        // Sales Analysis Functions - Semplificata
        async function loadSalesAnalysis() {
            try {
                const res = await fetch(`/admin/packages?password=${encodeURIComponent(adminPassword)}`);
                const data = await res.json();
                
                if(data.ok) {
                    // Suggerimenti PRIMA (pi√π visibili)
                    const suggestionsDiv = document.getElementById('salesSuggestions');
                    if(data.suggestions && data.suggestions.length > 0) {
                        // Mostra solo i suggerimenti pi√π importanti (success e warning)
                        const importantSuggestions = data.suggestions.filter(s => s.type === 'success' || s.type === 'warning');
                        if(importantSuggestions.length > 0) {
                            let html = '<h3 style="margin-bottom: 15px;">üí° Suggerimenti</h3>';
                            importantSuggestions.forEach(sugg => {
                                const alertClass = sugg.type === 'success' ? 'alert-success' : 'alert-error';
                                html += `<div class="alert ${alertClass}" style="display: block; margin: 10px 0; padding: 15px; font-size: 15px;">${sugg.message}</div>`;
                            });
                            suggestionsDiv.innerHTML = html;
                        } else {
                            suggestionsDiv.innerHTML = '';
                        }
                    } else {
                        suggestionsDiv.innerHTML = '';
                    }
                    
                    // Top 3 Pacchetti - Solo 3 colonne
                    const topPackagesDiv = document.getElementById('topPackages');
                    if(data.packages && data.packages.length > 0) {
                        // Prendi solo i top 3
                        const top3 = data.packages.slice(0, 3);
                        let html = `
                            <table>
                                <tr>
                                    <th>Pacchetto</th>
                                    <th>Vendite</th>
                                    <th>Ricavi</th>
                                </tr>
                        `;
                        
                        top3.forEach((pkg, index) => {
                            const medal = index === 0 ? 'ü•á' : (index === 1 ? 'ü•à' : 'ü•â');
                            html += `
                                <tr style="background: ${index === 0 ? '#d1fae5' : 'transparent'};">
                                    <td><strong>${medal} ${pkg.package}</strong></td>
                                    <td>${pkg.sales}</td>
                                    <td>‚Ç¨${pkg.revenue_euros.toFixed(2)}</td>
                                </tr>
                            `;
                        });
                        
                        html += '</table>';
                        topPackagesDiv.innerHTML = html;
                    } else {
                        topPackagesDiv.innerHTML = '<p>Nessun dato di vendita disponibile</p>';
                    }
                    
                    // Monthly Trend - Caricato solo quando l'utente apre il details
                    const monthlyDiv = document.getElementById('monthlyTrend');
                    if(data.monthly_trend && data.monthly_trend.length > 0) {
                        let html = '<table><tr><th>Mese</th><th>Ordini</th><th>Ricavi</th><th>Foto</th></tr>';
                        
                        data.monthly_trend.forEach(month => {
                            if(month.orders > 0) {
                                html += `
                                    <tr>
                                        <td><strong>${month.month_name}</strong></td>
                                        <td>${month.orders}</td>
                                        <td>‚Ç¨${month.revenue_euros.toFixed(2)}</td>
                                        <td>${month.photos}</td>
                                    </tr>
                                `;
                            }
                        });
                        
                        html += '</table>';
                        monthlyDiv.innerHTML = html;
                    } else {
                        monthlyDiv.innerHTML = '<p>Nessun dato di trend mensile disponibile</p>';
                    }
                } else {
                    document.getElementById('topPackages').innerHTML = '<p class="alert alert-error">Errore nel caricamento dei dati</p>';
                }
            } catch(e) {
                console.error('Error loading sales analysis:', e);
                document.getElementById('topPackages').innerHTML = '<p class="alert alert-error">Errore nel caricamento</p>';
            }
        }
        
        // Fix All Orders Function
        async function fixAllOrders() {
            if(!confirm('Questo marcher√† tutte le foto negli ordini esistenti come pagate. Continuare?')) return;
            
            const resultDiv = document.getElementById('fixOrdersResult');
            resultDiv.innerHTML = '<p class="loading">Elaborazione in corso...</p>';
            
            try {
                const res = await fetch(`/admin/fix-all-orders?password=${encodeURIComponent(adminPassword)}`, {
                    method: 'POST'
                });
                const data = await res.json();
                
                if(data.ok) {
                    let html = `
                        <div class="alert alert-success" style="display: block;">
                            <h3>‚úÖ Ordini Aggiornati con Successo!</h3>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                <li><strong>Ordini Totali:</strong> ${data.total_orders}</li>
                                <li><strong>Ordini Processati:</strong> ${data.orders_processed}</li>
                                <li><strong>Foto Marcate come Pagate:</strong> ${data.photos_marked_paid}</li>
                                <li><strong>Foto Gi√† Pagate:</strong> ${data.photos_already_paid}</li>
                                <li><strong>Foto Non Trovate:</strong> ${data.photos_not_found || 0}</li>
                                ${data.errors && data.errors.length > 0 ? `<li><strong>Errori:</strong> ${data.errors.length}</li>` : ''}
                            </ul>
                        </div>
                    `;
                    
                    if(data.errors && data.errors.length > 0) {
                        html += `<div class="alert alert-error" style="display: block; margin-top: 10px;">
                            <h4>Errori:</h4>
                            <ul style="margin: 10px 0; padding-left: 20px; max-height: 200px; overflow-y: auto;">
                                ${data.errors.map(e => `<li>${e}</li>`).join('')}
                            </ul>
                        </div>`;
                    }
                    
                    if(data.details && data.details.length > 0) {
                        html += `<details style="margin-top: 15px;">
                            <summary style="cursor: pointer; font-weight: 600; color: #667eea;">Visualizza Dettagli (${data.details.length} ordini)</summary>
                            <div style="margin-top: 10px; max-height: 400px; overflow-y: auto;">
                                <table style="font-size: 12px;">
                                    <tr>
                                        <th>ID Ordine</th>
                                        <th>Email</th>
                                        <th>Foto</th>
                                        <th>Importo</th>
                                        <th>Marcate</th>
                                        <th>Gi√† Pagate</th>
                                        <th>Non Trovate</th>
                                    </tr>
                                    ${data.details.map(d => `
                                        <tr>
                                            <td><code>${d.order_id.substring(0, 20)}...</code></td>
                                            <td>${d.email}</td>
                                            <td>${d.photo_count}</td>
                                            <td>‚Ç¨${(d.amount_cents / 100).toFixed(2)}</td>
                                            <td>${d.photos_marked}</td>
                                            <td>${d.photos_already_paid}</td>
                                            <td>${d.photos_not_found || 0}</td>
                                        </tr>
                                    `).join('')}
                                </table>
                            </div>
                        </details>`;
                    }
                    
                    resultDiv.innerHTML = html;
                    
                    // Ricarica la lista ordini
                    loadOrders();
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-error" style="display: block;">Errore: ${data.error || 'Errore sconosciuto'}</div>`;
                }
            } catch(e) {
                console.error('Error fixing orders:', e);
                resultDiv.innerHTML = `<div class="alert alert-error" style="display: block;">Errore: ${e.message}</div>`;
            }
        }
    </script>
</body>
</html>

<!-- TEST VISIBILIT√Ä CAMPO DATA -->
